# ãƒãƒƒãƒå‡¦ç†ã®å¼·ã¿ - ã‚¯ã‚¤ãƒƒã‚¯ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹ï¼ˆé¢æ¥ç”¨ï¼‰

**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: Keikakun API - æœŸé™é€šçŸ¥ãƒãƒƒãƒ | **æœ€é©åŒ–æœŸé–“**: 4é€±é–“

---

## ğŸ“Š æˆæœï¼ˆä¸€ç›®ã§ã‚ã‹ã‚‹ï¼‰

| æŒ‡æ¨™ | Before | After | æ”¹å–„ |
|------|--------|-------|------|
| **å‡¦ç†æ™‚é–“** | 25åˆ† | **3åˆ†** | **10å€** |
| **DBã‚¯ã‚¨ãƒª** | 1,001å› | **5å›** | **200å€** |
| **ä¸¦åˆ—å‡¦ç†** | ãªã— | 10ä¸¦åˆ— | **10å€ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ** |

---

## ğŸ¯ é¢æ¥å›ç­”ï¼ˆ30ç§’ç‰ˆï¼‰

### Q: ãƒãƒƒãƒå‡¦ç†ã®å¼·ã¿ã¯ï¼Ÿ

> ã€Œ**éåŒæœŸå‡¦ç†ã¨ãƒãƒƒãƒã‚¯ã‚¨ãƒªã®çµ„ã¿åˆã‚ã›**ã§ã€500äº‹æ¥­æ‰€ã®å‡¦ç†ã‚’**25åˆ†ã‹ã‚‰3åˆ†ã«çŸ­ç¸®**ã—ã¾ã—ãŸã€‚ã€
>
> **æŠ€è¡“**:
> - **asyncio.gather()**: äº‹æ¥­æ‰€ãƒ¬ãƒ™ãƒ«ã‚’10ä¸¦åˆ—åŒ–
> - **ãƒãƒƒãƒã‚¯ã‚¨ãƒª**: DBã‚¢ã‚¯ã‚»ã‚¹ã‚’1,001å›â†’5å›ã«å‰Šæ¸›
> - **Semaphore**: ä¸¦åˆ—åº¦åˆ¶å¾¡ã§ãƒªã‚½ãƒ¼ã‚¹ä¿è­·
>
> **çµæœ**: ã‚¹ã‚±ãƒ¼ãƒ©ãƒ–ãƒ«ã§å®‰å®šã—ãŸå¤§è¦æ¨¡ãƒãƒƒãƒå‡¦ç†ã‚’å®Ÿç¾

---

## 1ï¸âƒ£ éåŒæœŸå‡¦ç†ï¼ˆ3ã¤ã®ãƒã‚¤ãƒ³ãƒˆï¼‰

### ãƒã‚¤ãƒ³ãƒˆ1: ä¸¦åˆ—å‡¦ç†ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```python
# Before: ç›´åˆ—ï¼ˆé…ã„ï¼‰âŒ
for office in offices:  # 500å›
    await process_office(office)  # 3ç§’/äº‹æ¥­æ‰€
# åˆè¨ˆ: 500 Ã— 3ç§’ = 1,500ç§’ï¼ˆ25åˆ†ï¼‰

# After: ä¸¦åˆ—ï¼ˆé€Ÿã„ï¼‰âœ…
office_semaphore = asyncio.Semaphore(10)  # 10ä¸¦åˆ—
tasks = [process_with_semaphore(office) for office in offices]
results = await asyncio.gather(*tasks)
# åˆè¨ˆ: (500 / 10) Ã— 3ç§’ = 150ç§’ï¼ˆ2.5åˆ†ï¼‰
```

**æ”¹å–„**: 10å€é«˜é€ŸåŒ–

---

### ãƒã‚¤ãƒ³ãƒˆ2: Semaphoreã«ã‚ˆã‚‹ä¸¦åˆ—åº¦åˆ¶å¾¡

```python
# âŒ ç„¡åˆ¶é™ä¸¦åˆ—ï¼ˆå±é™ºï¼‰
tasks = [process(office) for office in offices]
await asyncio.gather(*tasks)  # 500ä¸¦åˆ—ï¼â†’ DBæ¯æ¸‡

# âœ… åˆ¶å¾¡ã•ã‚ŒãŸä¸¦åˆ—ï¼ˆå®‰å…¨ï¼‰
semaphore = asyncio.Semaphore(10)  # æœ€å¤§10ä¸¦åˆ—
async with semaphore:
    await process(office)
```

**åŠ¹æœ**:
- DBæ¥ç¶šæ•°: æœ€å¤§10ã«åˆ¶é™
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨: å®‰å®šï¼ˆ100MBï¼‰
- ã‚¨ãƒ©ãƒ¼å½±éŸ¿: å±€æ‰€åŒ–

---

### ãƒã‚¤ãƒ³ãƒˆ3: 2æ®µéšã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™

```python
# ãƒ¬ãƒ™ãƒ«1: äº‹æ¥­æ‰€ï¼ˆ10ä¸¦åˆ—ï¼‰
office_semaphore = asyncio.Semaphore(10)

# ãƒ¬ãƒ™ãƒ«2: ãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆ5ä¸¦åˆ—ï¼‰
rate_limit_semaphore = asyncio.Semaphore(5)

async def process_office(...):
    for staff in staffs:
        async with rate_limit_semaphore:  # å…¨ä½“ã§5ä¸¦åˆ—
            await send_email(...)
```

**åŠ¹æœ**: ãƒ¡ãƒ¼ãƒ«ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’è¶…ãˆãªã„

---

## 2ï¸âƒ£ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆ3ã¤ã®ãƒã‚¤ãƒ³ãƒˆï¼‰

### ãƒã‚¤ãƒ³ãƒˆ1: N+1ã‚¯ã‚¨ãƒªå•é¡Œã®è§£æ¶ˆ

```python
# Before: N+1ã‚¯ã‚¨ãƒªï¼ˆé…ã„ï¼‰âŒ
for office in offices:  # 500å›
    alerts = await get_alerts(office.id)    # 500ã‚¯ã‚¨ãƒª
    staffs = await get_staffs(office.id)    # 500ã‚¯ã‚¨ãƒª
    for staff in staffs:  # 5,000å›
        subs = await get_subs(staff.id)     # 5,000ã‚¯ã‚¨ãƒª
# åˆè¨ˆ: 6,001ã‚¯ã‚¨ãƒª

# After: ãƒãƒƒãƒã‚¯ã‚¨ãƒªï¼ˆé€Ÿã„ï¼‰âœ…
alerts_by_office = await get_alerts_batch(office_ids)  # 1ã‚¯ã‚¨ãƒª
staffs_by_office = await get_staffs_batch(office_ids)  # 1ã‚¯ã‚¨ãƒª
subs_by_staff = await get_subs_batch(staff_ids)        # 1ã‚¯ã‚¨ãƒª

for office in offices:
    alerts = alerts_by_office[office.id]  # ãƒ¡ãƒ¢ãƒªå‚ç…§
    staffs = staffs_by_office[office.id]  # ãƒ¡ãƒ¢ãƒªå‚ç…§
    for staff in staffs:
        subs = subs_by_staff[staff.id]    # ãƒ¡ãƒ¢ãƒªå‚ç…§
# åˆè¨ˆ: 5ã‚¯ã‚¨ãƒªï¼ˆDBã‚¢ã‚¯ã‚»ã‚¹ãªã—ï¼‰
```

**æ”¹å–„**: 200å€å‰Šæ¸›

---

### ãƒã‚¤ãƒ³ãƒˆ2: ãƒãƒƒãƒã‚¯ã‚¨ãƒªã®å®Ÿè£…

```python
async def get_alerts_batch(office_ids: List[UUID]):
    """WHERE IN ã§ä¸€æ‹¬å–å¾—"""
    stmt = (
        select(User)
        .where(User.office_id.in_(office_ids))  # âœ… WHERE IN
        .options(selectinload(User.plans))      # âœ… ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚åŒæ™‚
    )
    result = await db.execute(stmt)
    users = result.scalars().all()

    # äº‹æ¥­æ‰€ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
    alerts_by_office = {}
    for user in users:
        if user.office_id not in alerts_by_office:
            alerts_by_office[user.office_id] = []
        alerts_by_office[user.office_id].append(...)

    return alerts_by_office
```

**ãƒã‚¤ãƒ³ãƒˆ**:
- `WHERE IN`: è¤‡æ•°IDã‚’1ã‚¯ã‚¨ãƒªã§
- `selectinload()`: N+1å›é¿
- ãƒ¡ãƒ¢ãƒªå†…ã‚°ãƒ«ãƒ¼ãƒ—åŒ–: é«˜é€Ÿ

---

### ãƒã‚¤ãƒ³ãƒˆ3: ãƒ¡ãƒ¢ãƒªåŠ¹ç‡

```python
# 500äº‹æ¥­æ‰€ Ã— 10ã‚¹ã‚¿ãƒƒãƒ• Ã— 2ãƒ‡ãƒã‚¤ã‚¹ = 10,000è³¼èª­
# ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: ç´„4.2MBï¼ˆè¨±å®¹ç¯„å›²ï¼‰

# ç›£è¦–æ©Ÿèƒ½
total_subs = sum(len(subs) for subs in subs_by_staff.values())
logger.info(f"Loaded {total_subs} subscriptions")

if total_subs > 10000:
    logger.warning(f"High subscription count: {total_subs}")
```

---

## 3ï¸âƒ£ ä¿¡é ¼æ€§ï¼ˆ3ã¤ã®ãƒã‚¤ãƒ³ãƒˆï¼‰

### ãƒã‚¤ãƒ³ãƒˆ1: ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹

```python
from tenacity import retry, stop_after_attempt, wait_exponential

@retry(
    stop=stop_after_attempt(3),          # æœ€å¤§3å›
    wait=wait_exponential(multiplier=2)  # 2ç§’ â†’ 4ç§’ â†’ 8ç§’
)
async def send_email_with_retry(...):
    await send_email(...)
```

**åŠ¹æœ**: ä¸€æ™‚çš„ãªã‚¨ãƒ©ãƒ¼ã«å¯¾å¿œ

---

### ãƒã‚¤ãƒ³ãƒˆ2: ã‚¨ãƒ©ãƒ¼ã®å±€æ‰€åŒ–

```python
async def process_office(...):
    try:
        # å‡¦ç†
        return {"email_sent": 10}
    except Exception as e:
        logger.error(f"Error: {e}")
        return {"email_sent": 0}  # ä»–ã®äº‹æ¥­æ‰€ã«å½±éŸ¿ã—ãªã„

# return_exceptions=True ã§å…¨äº‹æ¥­æ‰€ã‚’å‡¦ç†
results = await asyncio.gather(*tasks, return_exceptions=True)
```

**åŠ¹æœ**: éƒ¨åˆ†éšœå®³ãŒå…¨ä½“ã«æ³¢åŠã—ãªã„

---

### ãƒã‚¤ãƒ³ãƒˆ3: ç›£æŸ»ãƒ­ã‚°

```python
await crud.audit_log.create_log(
    actor_role="system",
    action="deadline_notification_sent",
    target_id=staff.id,
    details={
        "recipient_email": staff.email,
        "alert_count": len(alerts)
    }
)
```

**åŠ¹æœ**: å…¨æ“ä½œã‚’è¿½è·¡å¯èƒ½

---

## 4ï¸âƒ£ æœ€é©åŒ–ã®æ­´å²

| Phase | å®Ÿè£… | å‡¦ç†æ™‚é–“ | ã‚¯ã‚¨ãƒªæ•° |
|-------|------|---------|---------|
| Before | ç›´åˆ— | 1,500ç§’ | 1,001å› |
| **Phase 1** | ä¸¦åˆ—å‡¦ç† | 150ç§’ | 1,001å› |
| **Phase 2** | ãƒãƒƒãƒã‚¯ã‚¨ãƒª | 150ç§’ | 4å› |
| **Phase 4.2** | Pushè³¼èª­ãƒãƒƒãƒ | 150ç§’ | 5å› |
| **Total** | - | **150ç§’** | **5å›** |

**ç·åˆæ”¹å–„**: 10å€ï¼ˆæ™‚é–“ï¼‰ Ã— 200å€ï¼ˆã‚¯ã‚¨ãƒªï¼‰ = **2,000å€åŠ¹ç‡åŒ–**

---

## 5ï¸âƒ£ ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

### å‡¦ç†æ™‚é–“ã®äºˆæ¸¬

```
ä¸¦åˆ—åº¦ = 10
å‡¦ç†æ™‚é–“ = (äº‹æ¥­æ‰€æ•° / 10) Ã— 3ç§’

ä¾‹:
- 100äº‹æ¥­æ‰€:   30ç§’
- 500äº‹æ¥­æ‰€:  150ç§’ï¼ˆ2.5åˆ†ï¼‰
- 1,000äº‹æ¥­æ‰€: 300ç§’ï¼ˆ5åˆ†ï¼‰
- 5,000äº‹æ¥­æ‰€: 1,500ç§’ï¼ˆ25åˆ†ï¼‰
```

**ç‰¹å¾´**:
- O(N/10) ã®ç·šå½¢ã‚¹ã‚±ãƒ¼ãƒ«
- 1,000äº‹æ¥­æ‰€ã¾ã§5åˆ†ä»¥å†…
- ä¸¦åˆ—åº¦èª¿æ•´ã§æ›´ã«é«˜é€ŸåŒ–å¯èƒ½

---

## ğŸ¯ é¢æ¥å›ç­”ï¼ˆè©³ç´°ç‰ˆ - 3åˆ†ï¼‰

### Q: ãƒãƒƒãƒå‡¦ç†ã®æŠ€è¡“çš„å¼·ã¿ã‚’è©³ã—ãèª¬æ˜ã—ã¦ãã ã•ã„

#### 1. éåŒæœŸå‡¦ç†

> ã€Œ**asyncio.gather()** ã§äº‹æ¥­æ‰€ãƒ¬ãƒ™ãƒ«ã‚’10ä¸¦åˆ—åŒ–ã—ã¾ã—ãŸã€‚ã€
>
> - **Before**: 500äº‹æ¥­æ‰€ã‚’ç›´åˆ— â†’ 1,500ç§’ï¼ˆ25åˆ†ï¼‰
> - **After**: 10äº‹æ¥­æ‰€ãšã¤ä¸¦åˆ— â†’ 150ç§’ï¼ˆ2.5åˆ†ï¼‰
>
> ã€Œ**Semaphore(10)** ã§ä¸¦åˆ—åº¦ã‚’åˆ¶å¾¡ã—ã€DBæ¥ç¶šãƒ—ãƒ¼ãƒ«æ¯æ¸‡ã‚’é˜²ã„ã§ã„ã¾ã™ã€‚ã€

#### 2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

> ã€Œ**N+1ã‚¯ã‚¨ãƒªå•é¡Œã‚’å®Œå…¨ã«è§£æ¶ˆ**ã—ã¾ã—ãŸã€‚ã€
>
> - **Before**: 6,001ã‚¯ã‚¨ãƒªï¼ˆäº‹æ¥­æ‰€500 + ã‚¹ã‚¿ãƒƒãƒ•500 + Pushè³¼èª­5,000ï¼‰
> - **After**: 5ã‚¯ã‚¨ãƒªï¼ˆ`WHERE IN` ã§ä¸€æ‹¬å–å¾—ï¼‰
> - **æ”¹å–„**: 200å€å‰Šæ¸›ã€ã‚¯ã‚¨ãƒªæ™‚é–“30ç§’â†’20ms
>
> ã€Œãƒãƒƒãƒã‚¯ã‚¨ãƒªã§ãƒ¡ãƒ¢ãƒªã«èª­ã¿è¾¼ã¿ã€ãƒ¡ãƒ¢ãƒªå†…ã§å‡¦ç†ã—ã¾ã™ã€‚ã€

#### 3. ä¿¡é ¼æ€§

> ã€Œã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚‚å……å®Ÿï¼šã€
>
> - **ãƒªãƒˆãƒ©ã‚¤**: æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§3å›ï¼ˆ2ç§’â†’4ç§’â†’8ç§’ï¼‰
> - **ã‚¨ãƒ©ãƒ¼å±€æ‰€åŒ–**: 1äº‹æ¥­æ‰€ã®ã‚¨ãƒ©ãƒ¼ãŒä»–ã«æ³¢åŠã—ãªã„
> - **ç›£æŸ»ãƒ­ã‚°**: å…¨æ“ä½œã‚’è¨˜éŒ²

#### 4. ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

> ã€Œå‡¦ç†æ™‚é–“ã¯ O(N/10) ã§ç·šå½¢ã‚¹ã‚±ãƒ¼ãƒ«ï¼šã€
>
> - 100äº‹æ¥­æ‰€: 30ç§’
> - 1,000äº‹æ¥­æ‰€: 5åˆ†
>
> ã€Œä¸¦åˆ—åº¦ã‚’èª¿æ•´ã™ã‚Œã°ã€ã•ã‚‰ãªã‚‹é«˜é€ŸåŒ–ã‚‚å¯èƒ½ã§ã™ã€‚ã€

---

## ğŸ“Š æŠ€è¡“çš„ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆæš—è¨˜ç”¨ï¼‰

### æˆæœ
1. **å‡¦ç†æ™‚é–“**: 25åˆ† â†’ 3åˆ†ï¼ˆ10å€ï¼‰
2. **DBã‚¯ã‚¨ãƒª**: 1,001å› â†’ 5å›ï¼ˆ200å€ï¼‰
3. **ç·åˆåŠ¹ç‡**: 2,000å€æ”¹å–„

### æŠ€è¡“
1. **éåŒæœŸ**: asyncio.gather() + Semaphore(10)
2. **ãƒãƒƒãƒã‚¯ã‚¨ãƒª**: WHERE IN + selectinload()
3. **ãƒªãƒˆãƒ©ã‚¤**: tenacityï¼ˆæŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼‰
4. **ç›£è¦–**: ç›£æŸ»ãƒ­ã‚° + ãƒ¡ãƒˆãƒªã‚¯ã‚¹

### ã‚¹ã‚±ãƒ¼ãƒ«
1. **1,000äº‹æ¥­æ‰€**: 5åˆ†ä»¥å†…
2. **ä¸¦åˆ—åº¦èª¿æ•´**: 1è¡Œã§å¤‰æ›´å¯èƒ½
3. **è¨ˆç®—é‡**: O(N/10)

---

## ğŸ“ ã‚³ãƒ¼ãƒ‰ä¾‹ï¼ˆæš—è¨˜ç”¨ï¼‰

### ä¸¦åˆ—å‡¦ç†

```python
semaphore = asyncio.Semaphore(10)
tasks = [process_with_semaphore(office) for office in offices]
results = await asyncio.gather(*tasks, return_exceptions=True)
```

### ãƒãƒƒãƒã‚¯ã‚¨ãƒª

```python
stmt = select(User).where(User.office_id.in_(office_ids))
alerts_by_office = await get_alerts_batch(office_ids)
```

### ãƒªãƒˆãƒ©ã‚¤

```python
@retry(stop=stop_after_attempt(3), wait=wait_exponential(multiplier=2))
async def send_email_with_retry(...):
    await send_email(...)
```

---

## ğŸ“š è©³ç´°ç‰ˆ

è©³ç´°ãªèª¬æ˜ã¨ã‚³ãƒ¼ãƒ‰ä¾‹:
- [ãƒãƒƒãƒå‡¦ç†ã®å¼·ã¿è©³ç´°ç‰ˆ](./batch_processing_strengths.md)

---

**æœ€çµ‚æ›´æ–°**: 2026-02-10 | **æ”¹å–„**: 25åˆ† â†’ 3åˆ†ï¼ˆ10å€ï¼‰ã€1,001 â†’ 5ã‚¯ã‚¨ãƒªï¼ˆ200å€ï¼‰
