# Phase 1 å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆè¿½åŠ 

**æ—¥ä»˜**: 2026-02-09
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 1 - REDï¼ˆãƒ†ã‚¹ãƒˆè¿½åŠ ï¼‰
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Œäº†

---

## ğŸ“‹ å®Ÿè£…å†…å®¹

### 1. pytest.ini ã«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `k_back/pytest.ini`

```ini
markers =
    integration: marks tests as integration tests (requires Google Calendar API access)
    performance: marks tests as performance tests (deselect with '-m "not performance"')
```

**ç›®çš„**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚’ä»–ã®ãƒ†ã‚¹ãƒˆã¨åˆ†é›¢ã—ã¦å®Ÿè¡Œå¯èƒ½ã«ã™ã‚‹

---

### 2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `k_back/tests/performance/test_deadline_notification_performance.py`

**å®Ÿè£…ã•ã‚ŒãŸã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ**:

#### QueryCounter ã‚¯ãƒ©ã‚¹
- SQLAlchemyã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã‚¯ã‚¨ãƒªæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
- N+1ã‚¯ã‚¨ãƒªå•é¡Œã®æ¤œå‡ºã«ä½¿ç”¨

```python
class QueryCounter:
    def __init__(self):
        self.count = 0
        self.queries: List[Dict] = []
```

#### ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£

1. **query_counter**: SQLã‚¯ã‚¨ãƒªæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
2. **performance_test_data_small**: 10äº‹æ¥­æ‰€ã€100ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆã‚¯ã‚¨ãƒªåŠ¹ç‡ãƒ†ã‚¹ãƒˆç”¨ï¼‰
3. **performance_test_data_large**: 500äº‹æ¥­æ‰€ã€5,000ã‚¹ã‚¿ãƒƒãƒ•ï¼ˆæœ¬æ ¼è² è·ãƒ†ã‚¹ãƒˆç”¨ï¼‰
4. **mock_weekday_check**: é€±æœ«ãƒ»ç¥æ—¥ãƒã‚§ãƒƒã‚¯ã‚’ãƒã‚¤ãƒ‘ã‚¹

#### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹

##### Test 1: `test_deadline_notification_performance_500_offices`
**ç›®çš„**: 500äº‹æ¥­æ‰€è¦æ¨¡ã§ã®åŸºæœ¬ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š

**æ¸¬å®šé …ç›®**:
- å‡¦ç†æ™‚é–“ï¼ˆç›®æ¨™: < 300ç§’ï¼‰
- ãƒ¡ãƒ¢ãƒªå¢—åŠ ï¼ˆç›®æ¨™: < 50MBï¼‰
- DBã‚¯ã‚¨ãƒªæ•°ï¼ˆç›®æ¨™: < 100å›ï¼‰

**ç¾çŠ¶**: æœªå®Ÿè¡Œï¼ˆå¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã«æ™‚é–“ãŒã‹ã‹ã‚‹ãŸã‚ï¼‰

---

##### Test 2: `test_query_efficiency_no_n_plus_1`
**ç›®çš„**: N+1ã‚¯ã‚¨ãƒªå•é¡Œã®æ¤œå‡º

**æ¸¬å®šé …ç›®**:
- ã‚¯ã‚¨ãƒªæ•°ãŒäº‹æ¥­æ‰€æ•°ã«æ¯”ä¾‹ã—ãªã„ã“ã¨ï¼ˆO(1)ï¼‰

**å®Ÿè¡Œçµæœ**:
```
======================================================================
ğŸ“Š Test 2: ã‚¯ã‚¨ãƒªåŠ¹ç‡ãƒ†ã‚¹ãƒˆï¼ˆN+1å•é¡Œæ¤œå‡ºï¼‰
======================================================================

ğŸ“ˆ æ¸¬å®šçµæœ:
  ğŸ¢ äº‹æ¥­æ‰€æ•°: 10
  ğŸ—ƒï¸  DBã‚¯ã‚¨ãƒªæ•°: 42å›
  ğŸ“§ é€ä¿¡ãƒ¡ãƒ¼ãƒ«æ•°: 200ä»¶

ğŸ¯ N+1å•é¡Œãƒã‚§ãƒƒã‚¯:
  è¨±å®¹ã‚¯ã‚¨ãƒªæ•°: < 2.0å› (äº‹æ¥­æ‰€æ•°ã®20%)
  å®Ÿéš›ã®ã‚¯ã‚¨ãƒªæ•°: 42å›

âŒ FAILED - N+1ã‚¯ã‚¨ãƒªå•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ
```

**åˆ†æ**:
- 10äº‹æ¥­æ‰€ã§42ã‚¯ã‚¨ãƒª â†’ äº‹æ¥­æ‰€ã‚ãŸã‚Šç´„4ã‚¯ã‚¨ãƒª
- ç›®æ¨™ï¼ˆå®šæ•°æ™‚é–“O(1)ï¼‰ã®20å€ä»¥ä¸Š
- **N+1å•é¡ŒãŒæ˜ç¢ºã«å­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª** âœ…

**æœŸå¾…ã•ã‚Œã‚‹æŒ™å‹•**: ã“ã®ãƒ†ã‚¹ãƒˆã¯ **å¤±æ•—ã™ã‚‹ã®ãŒæ­£å¸¸**ï¼ˆREDçŠ¶æ…‹ï¼‰

---

##### Test 3: `test_memory_efficiency_chunk_processing`
**ç›®çš„**: ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯æ¤œå‡º

**æ¸¬å®šé …ç›®**:
- ãƒ”ãƒ¼ã‚¯ãƒ¡ãƒ¢ãƒªå¢—åŠ ï¼ˆç›®æ¨™: < 50MBï¼‰
- GCå¾Œãƒ¡ãƒ¢ãƒªä¿æŒï¼ˆç›®æ¨™: < 10MBï¼‰
- ãƒ¡ãƒ¢ãƒªãƒªãƒ¼ã‚¯ç‡ï¼ˆç›®æ¨™: < 20%ï¼‰

**ç¾çŠ¶**: æœªå®Ÿè¡Œï¼ˆ500äº‹æ¥­æ‰€ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ï¼‰

---

##### Test 4: `test_parallel_processing_speedup`
**ç›®çš„**: ä¸¦åˆ—å‡¦ç†åŠ¹ç‡ã®æ¸¬å®š

**æ¸¬å®šé …ç›®**:
- 1äº‹æ¥­æ‰€ã‚ãŸã‚Šã®å‡¦ç†æ™‚é–“ï¼ˆç›®æ¨™: < 0.1ç§’ï¼‰
- æ¨å®šä¸¦åˆ—åº¦ï¼ˆç›®æ¨™: >= 10å€ï¼‰

**ç¾çŠ¶**: æœªå®Ÿè¡Œï¼ˆ500äº‹æ¥­æ‰€ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ï¼‰

---

##### Test 5: `test_performance_test_data_generation_speed`
**è£œåŠ©ãƒ†ã‚¹ãƒˆ**: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆé€Ÿåº¦ã®ç¢ºèª

**ç›®çš„**: ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¢ºèª

---

### 3. READMEä½œæˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `k_back/tests/performance/README.md`

**å†…å®¹**:
- ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œæ–¹æ³•
- å„ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®è©³ç´°èª¬æ˜
- ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰
- é€²æ—ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°è¡¨

---

### 4. ä¾å­˜é–¢ä¿‚è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«**: `k_back/requirements-dev.txt`

**è¿½åŠ ãƒ©ã‚¤ãƒ–ãƒ©ãƒª**:
```txt
# ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆç”¨ï¼ˆãƒ¡ãƒ¢ãƒªãƒ»CPUä½¿ç”¨é‡æ¸¬å®šï¼‰
psutil>=5.9.0
```

**ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†**: âœ…

---

## ğŸ¯ Phase 1 ã®é”æˆçŠ¶æ³

### å®Œäº†é …ç›®

- [x] pytest.ini ã«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¼ã‚«ãƒ¼è¿½åŠ 
- [x] QueryCounter ã‚¯ãƒ©ã‚¹å®Ÿè£…
- [x] ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ä½œæˆ
  - [x] performance_test_data_smallï¼ˆ10äº‹æ¥­æ‰€ï¼‰
  - [x] performance_test_data_largeï¼ˆ500äº‹æ¥­æ‰€ï¼‰
- [x] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šãƒ†ã‚¹ãƒˆ4ç¨®é¡ä½œæˆ
  - [x] test_deadline_notification_performance_500_offices
  - [x] test_query_efficiency_no_n_plus_1
  - [x] test_memory_efficiency_chunk_processing
  - [x] test_parallel_processing_speedup
- [x] è£œåŠ©ãƒ†ã‚¹ãƒˆä½œæˆï¼ˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆé€Ÿåº¦ï¼‰
- [x] READMEä½œæˆ
- [x] psutilä¾å­˜é–¢ä¿‚è¿½åŠ ãƒ»ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- [x] ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç¢ºèªï¼ˆN+1ãƒ†ã‚¹ãƒˆï¼‰
- [x] REDçŠ¶æ…‹ç¢ºèªï¼ˆN+1å•é¡Œæ¤œå‡ºï¼‰

### æ¤œè¨¼çµæœ

#### âœ… N+1ã‚¯ã‚¨ãƒªå•é¡Œã®æ¤œå‡ºã«æˆåŠŸ

**æ¸¬å®šãƒ‡ãƒ¼ã‚¿**:
```
äº‹æ¥­æ‰€æ•°: 10
DBã‚¯ã‚¨ãƒªæ•°: 42å›
1äº‹æ¥­æ‰€ã‚ãŸã‚Š: 4.2ã‚¯ã‚¨ãƒª

æœŸå¾…å€¤ï¼ˆæœ€é©åŒ–å¾Œï¼‰: 4ã‚¯ã‚¨ãƒªï¼ˆå®šæ•°ï¼‰
ç¾çŠ¶: 42ã‚¯ã‚¨ãƒªï¼ˆO(N)ï¼‰

æ”¹å–„ä½™åœ°: 10å€ä»¥ä¸Š
```

**çµè«–**: N+1ã‚¯ã‚¨ãƒªå•é¡ŒãŒ **æ˜ç¢ºã«å­˜åœ¨**ã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚

---

## ğŸ“Š ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ¸¬å®šçµæœ

### Test 2: ã‚¯ã‚¨ãƒªåŠ¹ç‡ãƒ†ã‚¹ãƒˆï¼ˆ10äº‹æ¥­æ‰€ï¼‰

| ãƒ¡ãƒˆãƒªã‚¯ã‚¹ | æ¸¬å®šå€¤ | ç›®æ¨™å€¤ | åˆ¤å®š |
|-----------|--------|--------|------|
| å‡¦ç†æ™‚é–“ | 338ç§’ (5åˆ†38ç§’) | - | å‚è€ƒå€¤ |
| DBã‚¯ã‚¨ãƒªæ•° | 42å› | 2å›ä»¥ä¸‹ | âŒ FAIL |
| é€ä¿¡ãƒ¡ãƒ¼ãƒ«æ•° | 200ä»¶ | - | âœ… OK |

**ã‚¯ã‚¨ãƒªåŠ¹ç‡**: O(N) â†’ O(1) ã¸ã®æ”¹å–„ãŒå¿…è¦

---

## ğŸ”´ REDçŠ¶æ…‹ã®ç¢ºèª

### æœŸå¾…ã•ã‚Œã‚‹å¤±æ•—

Phase 1ã§ã¯ã€ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆãŒ **å¤±æ•—ã™ã‚‹ã“ã¨ãŒæ­£å¸¸** ã§ã™ï¼ˆTDDã®REDãƒ•ã‚§ãƒ¼ã‚ºï¼‰:

1. âœ… **test_query_efficiency_no_n_plus_1** - N+1ã‚¯ã‚¨ãƒªå•é¡Œæ¤œå‡º
   ```
   AssertionError: N+1ã‚¯ã‚¨ãƒªå•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ: 42å› >= 2å›
   ã‚¯ã‚¨ãƒªæ•°ãŒäº‹æ¥­æ‰€æ•°ã«æ¯”ä¾‹ã—ã¦ã„ã¾ã™ï¼ˆO(N)ï¼‰
   ```

2. â³ **test_deadline_notification_performance_500_offices** - å‡¦ç†æ™‚é–“è¶…éï¼ˆäºˆæƒ³ï¼‰
   ```
   AssertionError: å‡¦ç†æ™‚é–“ãŒç›®æ¨™ã‚’è¶…é: 1500ç§’ > 300ç§’
   ```

3. â³ **test_memory_efficiency_chunk_processing** - ãƒ¡ãƒ¢ãƒªè¶…éï¼ˆäºˆæƒ³ï¼‰
   ```
   AssertionError: ãƒ”ãƒ¼ã‚¯ãƒ¡ãƒ¢ãƒªå¢—åŠ ãŒç›®æ¨™ã‚’è¶…é: 500MB > 50MB
   ```

4. â³ **test_parallel_processing_speedup** - ä¸¦åˆ—åº¦ä¸è¶³ï¼ˆäºˆæƒ³ï¼‰
   ```
   AssertionError: æ¨å®šä¸¦åˆ—åº¦ãŒç›®æ¨™æœªé”: 1å€ < 10å€
   ```

---

## ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: Phase 2

### Phase 2: ãƒãƒƒãƒã‚¯ã‚¨ãƒªå®Ÿè£…ï¼ˆGREENï¼‰

**ç›®çš„**: N+1ã‚¯ã‚¨ãƒªå•é¡Œã‚’è§£æ¶ˆ

**å®Ÿè£…å†…å®¹**:
1. `get_deadline_alerts_batch()` å®Ÿè£…
   - è¤‡æ•°äº‹æ¥­æ‰€ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’2å›ã®ã‚¯ã‚¨ãƒªã§å–å¾—
2. `get_staffs_by_offices_batch()` å®Ÿè£…
   - è¤‡æ•°äº‹æ¥­æ‰€ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’1å›ã®ã‚¯ã‚¨ãƒªã§å–å¾—
3. ãƒ¡ã‚¤ãƒ³ãƒãƒƒãƒå‡¦ç†ã¸ã®çµ±åˆ
4. test_query_efficiency_no_n_plus_1 ã‚’ãƒ‘ã‚¹ã•ã›ã‚‹

**æœŸå¾…ã•ã‚Œã‚‹æ”¹å–„**:
- ã‚¯ã‚¨ãƒªæ•°: 42å› â†’ 4å›ï¼ˆ10å€å‰Šæ¸›ï¼‰
- å‡¦ç†æ™‚é–“: ä¸€éƒ¨æ”¹å–„ï¼ˆ10ã€œ20%ï¼‰

**æ‰€è¦æ™‚é–“**: 2æ—¥

---

## ğŸ“ æŠ€è¡“çš„ãªå­¦ã³

### 1. QueryCounterã®å®Ÿè£…

SQLAlchemyã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã‚¯ã‚¨ãƒªæ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ:

```python
bind = db_session.sync_session.bind
event.listen(bind, "before_cursor_execute", counter)
```

**æ³¨æ„ç‚¹**: Async sessionã®å ´åˆã€å†…éƒ¨ã®sync sessionã®bindã«ã‚¢ã‚¿ãƒƒãƒã™ã‚‹å¿…è¦ãŒã‚ã‚‹

### 2. psutil ã«ã‚ˆã‚‹ãƒ¡ãƒ¢ãƒªæ¸¬å®š

```python
process = psutil.Process(os.getpid())
memory_before = process.memory_info().rss / 1024 / 1024  # MB
```

**æ³¨æ„ç‚¹**: GCå®Ÿè¡Œå¾Œã«å°‘ã—å¾…æ©Ÿæ™‚é–“ã‚’è¨­ã‘ã‚‹ï¼ˆ`await asyncio.sleep(0.1)`ï¼‰

### 3. å¤§è¦æ¨¡ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆ

500äº‹æ¥­æ‰€ã®ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã«ã¯å·¥å¤«ãŒå¿…è¦:
- 100äº‹æ¥­æ‰€ã”ã¨ã«commitï¼ˆãƒ¡ãƒ¢ãƒªç¯€ç´„ï¼‰
- é€²æ—è¡¨ç¤ºã§çŠ¶æ³ã‚’å¯è¦–åŒ–
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚µã‚¤ã‚ºã®æœ€é©åŒ–

---

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

### ä½œæˆã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
- `k_back/tests/performance/test_deadline_notification_performance.py`
- `k_back/tests/performance/README.md`
- `md_files_design_note/performance/phase1_completion_report.md`ï¼ˆæœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰

### å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«
- `k_back/pytest.ini`ï¼ˆperformanceãƒãƒ¼ã‚«ãƒ¼è¿½åŠ ï¼‰
- `k_back/requirements-dev.txt`ï¼ˆpsutilè¿½åŠ ï¼‰

### å‚è€ƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶ä»•æ§˜æ›¸](./performance_requirements.md)
- [å®Ÿè£…è¨ˆç”»](./implementation_plan.md)
- [ãƒ†ã‚¹ãƒˆä»•æ§˜æ›¸](./test_specifications.md)

---

## âœ… Phase 1 å®Œäº†å®£è¨€

**Phase 1ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆè¿½åŠ ï¼‰ã¯æ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚**

### é”æˆäº‹é …
1. âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã®å®Ÿè£…ã¨å®Ÿè¡Œç¢ºèª
2. âœ… N+1ã‚¯ã‚¨ãƒªå•é¡Œã®æ¤œå‡ºã«æˆåŠŸ
3. âœ… REDçŠ¶æ…‹ï¼ˆãƒ†ã‚¹ãƒˆå¤±æ•—ï¼‰ã®ç¢ºèª
4. âœ… ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ¸¬å®šãƒ‡ãƒ¼ã‚¿ã®å–å¾—
5. âœ… Phase 2ã¸ã®æº–å‚™å®Œäº†

### æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

**Phase 2ã‚’é–‹å§‹ã™ã‚‹æº–å‚™ãŒæ•´ã„ã¾ã—ãŸ:**
1. ãƒãƒƒãƒã‚¯ã‚¨ãƒªãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…
2. N+1ã‚¯ã‚¨ãƒªå•é¡Œã®è§£æ¶ˆ
3. test_query_efficiency_no_n_plus_1 ã‚’GREENã«ã™ã‚‹

---

**ä½œæˆè€…**: Claude Sonnet 4.5
**ãƒ¬ãƒ“ãƒ¥ãƒ¯ãƒ¼**: Tech Leadï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼å¾…ã¡ï¼‰
**æœ€çµ‚æ›´æ–°**: 2026-02-09
