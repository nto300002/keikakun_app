# npmセキュリティ脆弱性対策タスクリスト

## 📋 即座に実施すべき対策（優先度: 最高）

### 1. 現状確認

- [ ] Next.jsバージョンを確認
  ```bash
  cd k_front
  npm list next
  ```
  - 影響を受けるバージョン: 15.x, 16.x, 14.3.0-canary.77以降
  - 安全なバージョン: 15.0.5, 15.1.9, 15.2.6, 15.3.6, 15.4.8, 15.5.7, 16.0.7

- [ ] 脆弱性スキャンの実行
  ```bash
  cd k_front
  npm audit
  ```

- [ ] 依存関係の確認
  ```bash
  npm outdated
  ```

### 2. 被害確認チェック（サプライチェーン攻撃）

- [ ] GitHubアカウントの確認
  - [ ] 不審なリポジトリ（"Sha1-Hulud: The Second Coming"）がないか確認
  - [ ] 検索実行: `github.com/search?q=owner:[ユーザー名]+path:.github/workflows/discussion.yaml`

- [ ] セルフホストランナーの確認
  - [ ] "SHA1HULUD" という名前のランナーがないかチェック

- [ ] ローカル環境の確認
  ```bash
  find . -type d -name "node_modules" -newermt "2025-11-20" -prune 2>/dev/null \
   | xargs -I {} find $(dirname {}) -name "setup_bun.js" -o -name "bun_environment.js" \
   -o -name "cloud.json" -o -name "actionsSecrets.json" 2>/dev/null | uniq
  ```
  - 検索対象: `setup_bun.js`, `bun_environment.js`, `cloud.json`, `environment.json`, `actionsSecrets.json`

### 3. 緊急パッチ適用（影響を受ける場合のみ）

- [ ] Next.jsのアップグレード
  ```bash
  cd k_front
  npx fix-react2shell-next
  ```
  または手動で最新パッチ版にアップグレード

- [ ] 環境変数とシークレットのローテーション
  - [ ] 全ての環境変数をローテーション
  - [ ] APIキーのローテーション
  - [ ] データベース認証情報のローテーション
  - [ ] JWT秘密鍵の再生成
  - [ ] その他のシークレットのローテーション

---

## 🛡️ セキュリティ基盤の構築（優先度: 高）

### 4. `.npmrc` の設定

- [ ] インストールスクリプトの無効化
  ```bash
  cd k_front
  echo "ignore-scripts=true" >> .npmrc
  ```

- [ ] `.npmrc` ファイルがgit管理に含まれているか確認

### 5. ホワイトリスト方式の導入

- [ ] @lavamoat/allow-scripts のインストール
  ```bash
  npm install @lavamoat/allow-scripts
  ```

- [ ] `package.json` に allowScripts 設定を追加
  ```json
  {
    "lavamoat": {
      "allowScripts": {
        "sharp": true,
        "esbuild": true,
        "bcrypt": true
      }
    }
  }
  ```

- [ ] 必要最小限のパッケージのみ許可リストに追加

### 6. セキュリティツールの導入

- [ ] OSV-Scannerのインストール
  ```bash
  brew install osv-scanner
  ```

- [ ] OSV-Scannerの動作確認
  ```bash
  cd k_front
  osv-scanner --lockfile package-lock.json
  ```

- [ ] Aikido Safe Chainのインストール（オプション）
  ```bash
  npm install -g @aikidosec/safe-chain
  safe-chain setup
  ```

### 7. package.jsonの更新

- [ ] セキュリティチェックスクリプトの追加
  ```json
  {
    "scripts": {
      "preinstall": "npx @aikidosec/safe-chain",
      "security-check": "npm audit && osv-scanner --lockfile package-lock.json",
      "audit": "npm audit --audit-level=high",
      "outdated-check": "npm outdated"
    }
  }
  ```

---

## 🔄 CI/CDパイプラインの強化（優先度: 高）

### 8. GitHub Actions セキュリティワークフローの作成

- [ ] `.github/workflows/security-check.yml` を作成
  ```yaml
  name: Security Check
  on:
    push:
      branches: [main, develop]
    pull_request:
    schedule:
      - cron: '0 9 * * 1'  # 毎週月曜日9時に実行

  jobs:
    security:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '20'

        - name: Run npm audit
          run: npm audit --audit-level=high
          working-directory: k_front

        - name: Run OSV-Scanner
          uses: google/osv-scanner-action@v1
          with:
            scan-args: --lockfile k_front/package-lock.json
  ```

- [ ] ワークフローファイルをコミット・プッシュ

- [ ] ワークフローの初回実行を確認

### 9. CI/CD環境の改善

- [ ] `npm install` を `npm ci` に変更（本番・CI環境）
  - より高速で確定的なビルドを実現

- [ ] `package-lock.json` がgit管理に含まれているか確認

- [ ] ビルドキャッシュの設定を確認

---

## 📊 継続的なセキュリティ管理（優先度: 中）

### 10. Dependabot/Renovateの導入

- [ ] Dependabotの有効化
  - GitHubリポジトリ設定 > Security > Dependabot alerts を有効化
  - Dependabot security updates を有効化
  - Dependabot version updates を有効化

- [ ] `.github/dependabot.yml` の作成
  ```yaml
  version: 2
  updates:
    - package-ecosystem: "npm"
      directory: "/k_front"
      schedule:
        interval: "weekly"
      open-pull-requests-limit: 10
  ```

- [ ] 自動PRの確認・マージフローの確立

### 11. npm provenance機能の有効化

- [ ] npm publishの設定確認（社内パッケージがある場合）
  ```bash
  npm publish --provenance
  ```

- [ ] パッケージの出所検証の有効化

---

## 🔍 定期メンテナンスタスク

### 週次タスク（毎週月曜日）

- [ ] `npm audit` の実行と結果確認
  ```bash
  cd k_front
  npm audit
  ```

- [ ] `osv-scanner` での脆弱性スキャン
  ```bash
  osv-scanner --lockfile package-lock.json
  ```

- [ ] 依存関係の更新確認
  ```bash
  npm outdated
  ```

- [ ] Dependabot PRの確認とマージ

### 月次タスク（毎月1日）

- [ ] `allowScripts` の見直し
  - 不要なパッケージの削除
  - 新規追加パッケージの確認

- [ ] セキュリティパッチの適用
  - Next.jsの最新パッチバージョン確認
  - 重要な依存関係の更新

- [ ] GitHub監査ログの確認
  - 不審なアクティビティのチェック
  - npm publishの履歴確認
  - CI/CDの実行履歴確認

### 四半期タスク（3ヶ月ごと）

- [ ] 依存関係の大幅な見直し
  - 使用していないパッケージの削除
  - 代替パッケージの検討
  - メジャーバージョンアップの計画

- [ ] セキュリティポリシーの見直し
  - `.npmrc` 設定の確認
  - allowScriptsリストの最適化
  - CI/CDワークフローの改善

### 年次タスク（毎年1月）

- [ ] 全シークレット・APIキーのローテーション
  - npm認証トークン
  - GitHub Personal Access Token
  - AWS/GCP/Azureの認証情報
  - データベース接続情報
  - APIキー（全サービス）
  - JWT秘密鍵

- [ ] セキュリティ監査の実施
  - 外部セキュリティ監査の検討
  - ペネトレーションテストの実施

- [ ] インシデント対応計画の見直し
  - 緊急連絡体制の確認
  - 復旧手順の更新

---

## 🚨 被害が確認された場合の対応手順

### フェーズ1: 即座の封じ込め

- [ ] 影響を受けたシステムの隔離
- [ ] 該当環境へのアクセス停止

### フェーズ2: トークンのローテーション

- [ ] npm認証トークンのローテーション
- [ ] GitHub Personal Access Tokenのローテーション
- [ ] AWS/GCP/Azureの認証情報のローテーション
- [ ] データベース接続情報のローテーション
- [ ] APIキー（全サービス）のローテーション

### フェーズ3: 不審なリソースの削除

- [ ] 不審なリポジトリの削除
- [ ] セルフホストランナーの削除
- [ ] ワークフローファイル（`.github/workflows/discussion.yaml`）の削除
- [ ] 不審なnpmパッケージのアンインストール

### フェーズ4: リポジトリの状態確認

- [ ] プライベートリポジトリが強制的に公開化されていないか確認
- [ ] リポジトリ設定の変更履歴を確認
- [ ] コミット履歴の確認（不審なコミットがないか）

### フェーズ5: 監査とレポート

- [ ] GitHubの監査ログで不審なアクティビティを確認
- [ ] npm publishの履歴を確認
- [ ] CI/CDの実行履歴を確認
- [ ] インシデントレポートの作成
- [ ] 関係者への報告

### フェーズ6: 復旧と再発防止

- [ ] クリーンな環境での再構築
- [ ] 全依存関係の再インストール
- [ ] セキュリティ対策の再確認
- [ ] 再発防止策の実施
- [ ] ポストモーテムの実施

---

## 📚 参考資料

- [Vercel Blog - Critical npm Supply Chain Attack Response](https://vercel.com/blog/critical-npm-supply-chain-attack-response-september-8-2025)
- [Next.js Security Advisory - CVE-2025-66478](https://nextjs.org/blog/CVE-2025-66478)
- [Zenn - npm サプライチェーン攻撃への対策](https://zenn.dev/hand_dot/articles/04542a91bc432e)

---

## ✅ 進捗トラッキング

### 即座に実施すべき対策
- [ ] 1. 現状確認
- [ ] 2. 被害確認チェック
- [ ] 3. 緊急パッチ適用

### セキュリティ基盤の構築
- [ ] 4. `.npmrc` の設定
- [ ] 5. ホワイトリスト方式の導入
- [ ] 6. セキュリティツールの導入
- [ ] 7. package.jsonの更新

### CI/CDパイプラインの強化
- [ ] 8. GitHub Actions セキュリティワークフローの作成
- [ ] 9. CI/CD環境の改善

### 継続的なセキュリティ管理
- [ ] 10. Dependabot/Renovateの導入
- [ ] 11. npm provenance機能の有効化

---

**最終更新日**: 2025-12-10
**次回レビュー予定**: 週次タスク（毎週月曜日）
