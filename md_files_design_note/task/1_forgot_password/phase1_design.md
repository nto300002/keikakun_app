# Phase 1: è¨­è¨ˆãƒ•ã‚§ãƒ¼ã‚º

ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ã®è¦ä»¶å®šç¾©ã¨APIè¨­è¨ˆ

---

## 1. æ¦‚è¦

ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã«ã€ãƒ¡ãƒ¼ãƒ«ã«ã‚ˆã‚‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ¯ãƒ³ã‚¿ã‚¤ãƒ ãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
æ—¢å­˜ã®ãƒ¡ãƒ¼ãƒ«èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã€èªè¨¼ãƒ•ãƒ­ãƒ¼ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½ã¨çµ±åˆã—ã€ä¸€è²«æ€§ã®ã‚ã‚‹å®Ÿè£…ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

---

## 2. è¦ä»¶å®šç¾©

### 2.1 æ©Ÿèƒ½è¦ä»¶

#### 2.1.1 ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¦æ±‚
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ç™»éŒ²æ¸ˆã¿ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãã‚‹
- ã‚·ã‚¹ãƒ†ãƒ ã¯ä¸€æ„ã§æœŸé™ä»˜ãã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã€ãƒ¡ãƒ¼ãƒ«ã§ãƒªã‚»ãƒƒãƒˆãƒªãƒ³ã‚¯ã‚’é€ä¿¡ã™ã‚‹
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®ï¼šå­˜åœ¨ã—ãªã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã‚‚æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ï¼ˆæƒ…å ±æ¼æ´©é˜²æ­¢ï¼‰
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼šåŒä¸€IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‹ã‚‰ã®é€£ç¶šãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’åˆ¶é™ï¼ˆ5å›/10åˆ†ï¼‰

#### 2.1.2 ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ãƒ¡ãƒ¼ãƒ«å†…ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹
- ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’æ¤œè¨¼ã™ã‚‹ï¼ˆå­˜åœ¨ãƒ»æœªä½¿ç”¨ãƒ»æœŸé™å†…ï¼‰
- æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¦ä»¶ã‚’æº€ãŸã™å¿…è¦ãŒã‚ã‚‹
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯bcryptã§ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ä¿å­˜ã™ã‚‹
- ãƒˆãƒ¼ã‚¯ãƒ³ã¯ä¸€åº¦ä½¿ç”¨ã•ã‚ŒãŸã‚‰ç„¡åŠ¹åŒ–ã•ã‚Œã‚‹ï¼ˆused=trueï¼‰
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å¾Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã™ã‚‹

#### 2.1.3 ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ã‚’äº‹å‰ç¢ºèªã§ãã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æä¾›
- ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ãªå ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é©åˆ‡ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º

### 2.2 éæ©Ÿèƒ½è¦ä»¶

#### 2.2.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- HTTPSå¿…é ˆï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
- ãƒˆãƒ¼ã‚¯ãƒ³ã¯æš—å·å­¦çš„ã«å®‰å…¨ãªãƒ©ãƒ³ãƒ€ãƒ å€¤ï¼ˆUUID v4ï¼‰ã‚’ä½¿ç”¨
- **ãƒˆãƒ¼ã‚¯ãƒ³ã¯SHA-256ã§ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦DBä¿å­˜**ï¼ˆDBä¾µå®³æ™‚ã®æ¼æ´©é˜²æ­¢ï¼‰
- ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ï¼š1æ™‚é–“
- ãƒˆãƒ¼ã‚¯ãƒ³ã¯ä¸€åº¦ã—ã‹ä½¿ç”¨ã§ããªã„ï¼ˆæ¥½è¦³çš„ãƒ­ãƒƒã‚¯ã§å®Ÿè£…ï¼‰
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯bcryptã§ãƒãƒƒã‚·ãƒ¥åŒ–ï¼ˆæ—¢å­˜å®Ÿè£…ã¨åŒã˜ï¼‰
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã«ã‚ˆã‚‹ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒé˜²æ­¢ï¼ˆforgot-password: 5/10åˆ†ã€resend: 3/10åˆ†ï¼‰
- ã‚ã„ã¾ã„ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼å­˜åœ¨ã®æ¨æ¸¬ã‚’é˜²æ­¢
- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å¾Œã¯å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–**ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ï¼‰
- **URLãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆè­˜åˆ¥å­ã§ãƒˆãƒ¼ã‚¯ãƒ³æ¸¡ã—**ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å±¥æ­´ãƒ»ãƒ­ã‚°æ¼æ´©é˜²æ­¢ï¼‰
- **ç›£æŸ»ãƒ­ã‚°ã®è¨˜éŒ²**ï¼ˆãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ƒIPã€User-Agentã€ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å±¥æ­´ï¼‰

#### 2.2.2 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹
- ãƒˆãƒ¼ã‚¯ãƒ³æ¤œç´¢ã«è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨ï¼ˆstaff_id, used, expires_atï¼‰
- æœŸé™åˆ‡ã‚Œãƒˆãƒ¼ã‚¯ãƒ³ã®å®šæœŸå‰Šé™¤ï¼ˆã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¸ãƒ§ãƒ–ã€æ¯æ—¥å®Ÿè¡Œæ¨å¥¨ï¼‰

#### 2.2.3 ç›£æŸ»ãƒ»ãƒ­ã‚°
- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç›£æŸ»ãƒ­ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«**ï¼ˆpassword_reset_audit_logsï¼‰ã®ä½œæˆ
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆå…ƒæƒ…å ±ã®è¨˜éŒ²ï¼ˆIP ã‚¢ãƒ‰ãƒ¬ã‚¹ã€User-Agentã€ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼‰
- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ã®è¨˜éŒ²ï¼ˆrequested, token_verified, completed, failedï¼‰
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å±¥æ­´ã®è¨˜éŒ²ï¼ˆpassword_changed_atï¼‰
- ç•°å¸¸ãªã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æ¤œå‡ºã¨ã‚¢ãƒ©ãƒ¼ãƒˆ

---

## 3. API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè¨­è¨ˆ

### 3.1 ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¦æ±‚

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/auth/forgot-password`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "email": "user@example.com"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "message": "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”¨ã®ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚"
}
```

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰**:
- `200 OK`: æˆåŠŸï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå­˜åœ¨ã—ãªã„å ´åˆã‚‚åŒã˜ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰
- `400 Bad Request`: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
- `429 Too Many Requests`: ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
2. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆ5å›/10åˆ†ï¼‰
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­˜åœ¨ç¢ºèª
4. æ—¢å­˜ã®æœªä½¿ç”¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼šã¾ãŸã¯æœ‰åŠ¹ãªãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚ã‚Œã°å†é€ä¿¡ï¼‰
5. æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆï¼ˆUUID v4ï¼‰
6. ãƒˆãƒ¼ã‚¯ãƒ³ã‚’DBã«ä¿å­˜ï¼ˆexpires_at = now() + 1æ™‚é–“ï¼‰
7. ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
8. æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­˜åœ¨ã«é–¢ã‚ã‚‰ãšï¼‰

---

### 3.2 ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æ€§ç¢ºèªï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `GET /api/v1/auth/verify-reset-token`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
```
?token=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "valid": true,
  "message": "ãƒˆãƒ¼ã‚¯ãƒ³ã¯æœ‰åŠ¹ã§ã™"
}
```

ã¾ãŸã¯

```json
{
  "valid": false,
  "message": "ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™"
}
```

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰**:
- `200 OK`: ãƒˆãƒ¼ã‚¯ãƒ³ã®çŠ¶æ…‹ã‚’è¿”ã™ï¼ˆvalid: true/falseï¼‰

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. ãƒˆãƒ¼ã‚¯ãƒ³ã‚’DBã‹ã‚‰æ¤œç´¢
2. ãƒˆãƒ¼ã‚¯ãƒ³ã®å­˜åœ¨ã€æœªä½¿ç”¨ã€æœŸé™å†…ã‚’ãƒã‚§ãƒƒã‚¯
3. çµæœã‚’è¿”ã™

---

### 3.3 ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `POST /api/v1/auth/reset-password`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "token": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx",
  "new_password": "NewP@ssw0rd123"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "message": "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£å¸¸ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸ"
}
```

**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰**:
- `200 OK`: æˆåŠŸ
- `400 Bad Request`: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã€ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹ã€æœŸé™åˆ‡ã‚Œã€æ—¢ã«ä½¿ç”¨æ¸ˆã¿
- `404 Not Found`: ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¦‹ã¤ã‹ã‚‰ãªã„

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
2. ãƒˆãƒ¼ã‚¯ãƒ³ã‚’DBã‹ã‚‰æ¤œç´¢
3. ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆå­˜åœ¨ã€æœªä½¿ç”¨ã€æœŸé™å†…ï¼‰
4. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
5. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ—¢å­˜ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¦ä»¶ã¨åŒã˜ï¼‰
6. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ï¼ˆbcryptï¼‰
7. ã‚¹ã‚¿ãƒƒãƒ•ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’æ›´æ–°
8. `password_changed_at` ã‚’æ›´æ–°
9. ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ `used=true`, `used_at=now()` ã«æ›´æ–°
10. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒŸãƒƒãƒˆ
11. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´é€šçŸ¥ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
12. æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å‡¦ç†ã—ã€ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
- ãƒˆãƒ¼ã‚¯ãƒ³å†åˆ©ç”¨ã®ãƒ¬ãƒ¼ã‚¹æ¡ä»¶ã‚’é˜²ããŸã‚ã€ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°æ™‚ã« `used=false` æ¡ä»¶ã‚’å«ã‚ã‚‹

---

## 4. ã‚¹ã‚­ãƒ¼ãƒå®šç¾©

### 4.1 ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¹ã‚­ãƒ¼ãƒ

`app/schemas/auth.py` ã¾ãŸã¯ `app/schemas/staff.py` ã«è¿½åŠ ï¼š

```python
from pydantic import BaseModel, EmailStr, field_validator
import re
from app.messages import ja


class ForgotPasswordRequest(BaseModel):
    """ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¦æ±‚"""
    email: EmailStr


class ResetPasswordRequest(BaseModel):
    """ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ"""
    token: str
    new_password: str

    @field_validator("new_password")
    @classmethod
    def validate_password(cls, v: str) -> str:
        """ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰è¦ä»¶ã®æ¤œè¨¼ï¼ˆæ—¢å­˜ã®StaffCreateã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰"""
        if len(v) < 8:
            raise ValueError(ja.VALIDATION_PASSWORD_TOO_SHORT)

        checks = {
            "lowercase": lambda s: re.search(r'[a-z]', s),
            "uppercase": lambda s: re.search(r'[A-Z]', s),
            "digit": lambda s: re.search(r'\d', s),
            "symbol": lambda s: re.search(r'[!@#$%^&*(),.?":{}|<>]', s),
        }

        score = sum(1 for check in checks.values() if check(v))

        if score < 4:
            raise ValueError(ja.VALIDATION_PASSWORD_COMPLEXITY)

        return v


class VerifyResetTokenRequest(BaseModel):
    """ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æ€§ç¢ºèª"""
    token: str


class PasswordResetResponse(BaseModel):
    """ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¬ã‚¹ãƒãƒ³ã‚¹"""
    message: str


class TokenValidityResponse(BaseModel):
    """ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æ€§ãƒ¬ã‚¹ãƒãƒ³ã‚¹"""
    valid: bool
    message: str
```

---

## 5. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å®šç¾©

`app/messages/ja.py` ã«è¿½åŠ ï¼š

```python
# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆé–¢é€£
AUTH_PASSWORD_RESET_EMAIL_SENT = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”¨ã®ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚"
AUTH_RESET_TOKEN_VALID = "ãƒˆãƒ¼ã‚¯ãƒ³ã¯æœ‰åŠ¹ã§ã™"
AUTH_RESET_TOKEN_INVALID_OR_EXPIRED = "ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã§ã™ã€‚æ–°ã—ã„ãƒªã‚»ãƒƒãƒˆãƒªãƒ³ã‚¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚"
AUTH_RESET_TOKEN_ALREADY_USED = "ã“ã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚æ–°ã—ã„ãƒªã‚»ãƒƒãƒˆãƒªãƒ³ã‚¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚"
AUTH_PASSWORD_RESET_SUCCESS = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£å¸¸ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚"
AUTH_PASSWORD_RESET_FAILED = "ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
AUTH_USER_NOT_FOUND = "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

# ãƒ¬ãƒ¼ãƒˆåˆ¶é™
AUTH_RATE_LIMIT_EXCEEDED = "ãƒªã‚¯ã‚¨ã‚¹ãƒˆå›æ•°ãŒå¤šã™ãã¾ã™ã€‚ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚"
```

---

## 6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆã®ãƒã‚¤ãƒ³ãƒˆ

### 6.1 ãƒˆãƒ¼ã‚¯ãƒ³ã®å–ã‚Šæ‰±ã„

**ç”Ÿæˆ**:
- UUID v4ã‚’ä½¿ç”¨ï¼ˆæš—å·å­¦çš„ã«å®‰å…¨ãªãƒ©ãƒ³ãƒ€ãƒ å€¤ï¼‰
- äºˆæ¸¬ä¸å¯èƒ½æ€§ã‚’ä¿è¨¼

**ä¿å­˜**:
- ç”Ÿã®ãƒˆãƒ¼ã‚¯ãƒ³ã¯DBã«ä¿å­˜ã—ãªã„
- SHA-256ã§ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ã‹ã‚‰ä¿å­˜
- DBä¾µå®³æ™‚ã§ã‚‚ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¼æ´©ã‚’é˜²ã

**é€ä¿¡**:
- URLãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆè­˜åˆ¥å­ï¼ˆ#token=xxxï¼‰ã‚’ä½¿ç”¨
- ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆ?token=xxxï¼‰ã¯ä½¿ç”¨ã—ãªã„
- ãƒ–ãƒ©ã‚¦ã‚¶å±¥æ­´ã‚„ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã«è¨˜éŒ²ã•ã‚Œãªã„
- ãƒªãƒ•ã‚¡ãƒ©ãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ã«å«ã¾ã‚Œãªã„

### 6.2 ãƒ¬ãƒ¼ãƒˆåˆ¶é™

```python
# forgot-password: 5å›/10åˆ†
@limiter.limit("5/10minute")

# resend: 3å›/10åˆ†ï¼ˆã‚ˆã‚Šå³ã—ãï¼‰
@limiter.limit("3/10minute")
```

### 6.3 ãƒ¦ãƒ¼ã‚¶ãƒ¼å­˜åœ¨ã®æ¨æ¸¬é˜²æ­¢

å­˜åœ¨ã—ãªã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã‚‚æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™ï¼š

```python
# ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€å¸¸ã«æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™
return PasswordResetResponse(
    message=ja.AUTH_PASSWORD_RESET_EMAIL_SENT
)
```

### 6.4 ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–

ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å¾Œã¯å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼š

```python
# å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–
stmt = (
    update(Session)
    .where(Session.staff_id == staff.id)
    .values(is_active=False, revoked_at=datetime.now(timezone.utc))
)
await db.execute(stmt)
```

---

## 7. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¨­è¨ˆã®ãƒã‚¤ãƒ³ãƒˆ

### 7.1 URLãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—

```typescript
// React/Next.jsã®ä¾‹
useEffect(() => {
  // URLãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
  const hash = window.location.hash;
  if (hash.startsWith('#token=')) {
    const token = hash.substring(7); // '#token='ã®7æ–‡å­—ã‚’é™¤å»
    setToken(token);

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€å±¥æ­´ã‹ã‚‰ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
    window.history.replaceState(null, '', window.location.pathname);
  }
}, []);
```

### 7.2 ç”»é¢é·ç§»ãƒ•ãƒ­ãƒ¼

1. **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¦æ±‚ç”»é¢**ï¼ˆ`/forgot-password`ï¼‰
   - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›
   - é€ä¿¡ãƒœã‚¿ãƒ³
   - å†é€ä¿¡æ©Ÿèƒ½

2. **ç¢ºèªç”»é¢**
   - ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
   - ãƒ¡ãƒ¼ãƒ«ãŒå±Šã‹ãªã„å ´åˆã®å¯¾å‡¦æ³•

3. **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œç”»é¢**ï¼ˆ`/reset-password#token=xxx`ï¼‰
   - ãƒˆãƒ¼ã‚¯ãƒ³è‡ªå‹•å–å¾—
   - æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›
   - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªå…¥åŠ›
   - ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³

4. **å®Œäº†ç”»é¢**
   - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
   - ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ã®ãƒªãƒ³ã‚¯

---

---

## 8. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ & ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãƒ¬ãƒ“ãƒ¥ãƒ¼

**ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿæ–½æ—¥**: 2025-11-20
**ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼**: Claude Code (Anthropic AI)
**ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†

---

### 8.1 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼

#### âœ… è‰¯å¥½ãªè¨­è¨ˆãƒã‚¤ãƒ³ãƒˆ

1. **ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒãƒƒã‚·ãƒ¥åŒ–** - SHA-256ã§DBä¿å­˜ã«ã‚ˆã‚Šã€DBä¾µå®³æ™‚ã®æ¼æ´©ã‚’é˜²æ­¢
2. **URLãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆè­˜åˆ¥å­** - ãƒ–ãƒ©ã‚¦ã‚¶å±¥æ­´ãƒ»ã‚µãƒ¼ãƒãƒ¼ãƒ­ã‚°ã¸ã®æ¼æ´©é˜²æ­¢
3. **ãƒ¬ãƒ¼ãƒˆåˆ¶é™** - ãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹æ”»æ’ƒã¸ã®å¯¾ç­–
4. **ãƒ¦ãƒ¼ã‚¶ãƒ¼å­˜åœ¨ã®æ¨æ¸¬é˜²æ­¢** - å¸¸ã«æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
5. **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–** - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¤‰æ›´å¾Œã®å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–
6. **ç›£æŸ»ãƒ­ã‚°** - ã‚¢ã‚¯ã‚»ã‚¹å±¥æ­´ã®è¨˜éŒ²
7. **ãƒˆãƒ¼ã‚¯ãƒ³ä¸€åº¦ä½¿ç”¨åˆ¶é™** - æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ã«ã‚ˆã‚‹å®Ÿè£…
8. **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–** - bcryptã®ä½¿ç”¨

#### ğŸ”´ é‡å¤§ãªå•é¡Œ

##### 1. ãƒˆãƒ¼ã‚¯ãƒ³ãƒãƒƒã‚·ãƒ¥åŒ–ã®å®Ÿè£…è©³ç´°ã®çŸ›ç›¾

**å•é¡Œç‚¹**:
```python
# è¨­è¨ˆæ›¸: ã€ŒSHA-256ã§ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦DBä¿å­˜ã€
# ã—ã‹ã—ã€å‡¦ç†ãƒ•ãƒ­ãƒ¼ã§ã¯å®Ÿè£…ã®è©³ç´°ãŒä¸æ˜ç¢º
```

**å½±éŸ¿**:
- ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ä¿å­˜ã™ã‚‹å ´åˆã€æ¤œè¨¼æ™‚ã«ã‚‚åŒã˜ãƒãƒƒã‚·ãƒ¥åŒ–ãŒå¿…è¦
- URLãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆã§æ¸¡ã™å¹³æ–‡ãƒˆãƒ¼ã‚¯ãƒ³ã¨DBä¸Šã®ãƒãƒƒã‚·ãƒ¥ã®å¯¾å¿œãŒä¸æ˜ç¢º
- ãƒ¡ãƒ¼ãƒ«ã«å«ã‚ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã¯å¹³æ–‡ï¼Ÿãƒãƒƒã‚·ãƒ¥ï¼Ÿ

**æ¨å¥¨ä¿®æ­£**:
```python
# ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆæ™‚
raw_token = str(uuid.uuid4())  # å¹³æ–‡ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆãƒ¡ãƒ¼ãƒ«ã«å«ã‚ã‚‹ï¼‰
token_hash = hashlib.sha256(raw_token.encode()).hexdigest()  # DBä¿å­˜ç”¨

# ãƒ¡ãƒ¼ãƒ«ã«å«ã‚ã‚‹URL
reset_url = f"https://example.com/reset-password#token={raw_token}"

# æ¤œè¨¼æ™‚
received_token = request.token
received_hash = hashlib.sha256(received_token.encode()).hexdigest()
db_token = await db.execute(
    select(PasswordResetToken).where(
        PasswordResetToken.token_hash == received_hash,
        PasswordResetToken.used == False,
        PasswordResetToken.expires_at > datetime.now(timezone.utc)
    )
)
```

**è¿½è¨˜ã™ã¹ãå‡¦ç†ãƒ•ãƒ­ãƒ¼**:
```
1. UUID v4ã§å¹³æ–‡ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
2. SHA-256ã§ãƒãƒƒã‚·ãƒ¥åŒ–
3. ãƒãƒƒã‚·ãƒ¥ã‚’DBã«ä¿å­˜ï¼ˆå¹³æ–‡ã¯ä¿å­˜ã—ãªã„ï¼‰
4. å¹³æ–‡ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒ¡ãƒ¼ãƒ«URLã«å«ã‚ã‚‹
5. æ¤œè¨¼æ™‚ã€å—ã‘å–ã£ãŸå¹³æ–‡ãƒˆãƒ¼ã‚¯ãƒ³ã‚’SHA-256ãƒãƒƒã‚·ãƒ¥åŒ–
6. DBã®ãƒãƒƒã‚·ãƒ¥ã¨æ¯”è¼ƒ
```

##### 2. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã®ä¸æ˜ç¢ºã•

**å•é¡Œç‚¹**:
```python
# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¦æ±‚ã®å‡¦ç†é †åº
1. ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
2. DBã«ä¿å­˜        # â† ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹ï¼Ÿ
3. ãƒ¡ãƒ¼ãƒ«é€ä¿¡      # â† ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ï¼Ÿå¤–ï¼Ÿ
4. æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹  # â† ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒŸãƒƒãƒˆï¼Ÿ
```

**å½±éŸ¿**:
- ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—æ™‚ã«ãƒˆãƒ¼ã‚¯ãƒ³ãŒDBã«æ®‹ã‚‹ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å—ã‘å–ã‚Œãªã„ï¼‰
- ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒé…å»¶ã—ãŸå ´åˆã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒé•·æ™‚é–“ä¿æŒã•ã‚Œã‚‹
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ­ãƒƒã‚¯ã®é•·æœŸåŒ–

**æ¨å¥¨ä¿®æ­£**:
```python
# æ­£ã—ã„ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œ
async def forgot_password(email: str, db: AsyncSession):
    # 1. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    async with db.begin():
        # ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆãƒ»ä¿å­˜
        token = await create_reset_token(db, staff.id)
        # ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚³ãƒŸãƒƒãƒˆï¼ˆæš—é»™çš„ï¼‰

    # 2. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤–ã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    try:
        await send_password_reset_email(email, token.raw_value)
    except EmailSendError as e:
        # ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—æ™‚ã®å‡¦ç†
        logger.error(f"Email send failed: {e}")
        # ãƒˆãƒ¼ã‚¯ãƒ³ã¯æ—¢ã«DBã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãŒã€
        # æœŸé™åˆ‡ã‚Œã§è‡ªå‹•å‰Šé™¤ã•ã‚Œã‚‹ã®ã§è¨±å®¹

    # 3. å¸¸ã«æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ï¼‰
    return {"message": ja.AUTH_PASSWORD_RESET_EMAIL_SENT}
```

#### ğŸŸ  ä¸­ç¨‹åº¦ã®å•é¡Œ

##### 3. ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒã¸ã®å¯¾ç­–ä¸è¶³

**å•é¡Œç‚¹**:
```python
# ç¾åœ¨ã®è¨­è¨ˆ
if not token:
    raise HTTPException(404, "Token not found")  # å³åº§ã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹

if token.used:
    raise HTTPException(400, "Already used")  # ç•°ãªã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°

if token.expires_at < now():
    raise HTTPException(400, "Expired")  # ã•ã‚‰ã«ç•°ãªã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°
```

**å½±éŸ¿**:
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã®é•ã„ã‹ã‚‰ã€ãƒˆãƒ¼ã‚¯ãƒ³ã®çŠ¶æ…‹ã‚’æ¨æ¸¬å¯èƒ½

**æ¨å¥¨ä¿®æ­£**:
```python
import secrets

# Constant-timeæ¯”è¼ƒã‚’ä½¿ç”¨
def verify_token_constant_time(token: PasswordResetToken,
                                received_hash: str) -> bool:
    """ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒã‚’é˜²ããƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼"""
    if not token:
        # ãƒ€ãƒŸãƒ¼å‡¦ç†ã§æ™‚é–“ã‚’æƒãˆã‚‹
        secrets.compare_digest("dummy", "dummy")
        return False

    # å…¨ã¦ã®æ¡ä»¶ã‚’å…ˆã«è©•ä¾¡
    is_hash_match = secrets.compare_digest(
        token.token_hash,
        received_hash
    )
    is_not_used = not token.used
    is_not_expired = token.expires_at > datetime.now(timezone.utc)

    # å…¨ã¦ã®æ¡ä»¶ãŒçœŸã®å ´åˆã®ã¿æˆåŠŸ
    return is_hash_match and is_not_used and is_not_expired
```

##### 4. æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ã®å®Ÿè£…ä¸è¶³

**å•é¡Œç‚¹**:
```python
# è¨­è¨ˆæ›¸: ã€Œæ¥½è¦³çš„ãƒ­ãƒƒã‚¯ã§å®Ÿè£…ã€
# ã—ã‹ã—ã€å…·ä½“çš„ãªå®Ÿè£…æ–¹æ³•ãŒä¸æ˜ç¢º
```

**æ¨å¥¨ä¿®æ­£**:
```python
# Option 1: ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚’ä½¿ã†æ¥½è¦³çš„ãƒ­ãƒƒã‚¯
class PasswordResetToken(Base):
    version: Mapped[int] = mapped_column(Integer, default=0)

# æ›´æ–°æ™‚
result = await db.execute(
    update(PasswordResetToken)
    .where(
        PasswordResetToken.id == token.id,
        PasswordResetToken.used == False,
        PasswordResetToken.version == token.version  # â† æ¥½è¦³çš„ãƒ­ãƒƒã‚¯
    )
    .values(used=True, used_at=now(), version=token.version + 1)
)

if result.rowcount == 0:
    raise HTTPException(409, "Token already used (conflict)")

# Option 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ã‚’ä½¿ã†
# CREATE UNIQUE INDEX ON password_reset_tokens (id)
# WHERE used = false;
```

##### 5. ä¸¦è¡Œå‡¦ç†ã®ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³

**å•é¡Œç‚¹**:
```python
# åŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰è¤‡æ•°ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒåŒæ™‚ã«æ¥ãŸå ´åˆ
# Request A: æ—¢å­˜ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ– â†’ æ–°ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
# Request B: æ—¢å­˜ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ– â†’ æ–°ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
# ã©ã¡ã‚‰ã®ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœ‰åŠ¹ï¼Ÿ
```

**æ¨å¥¨ä¿®æ­£**:
```python
async def create_reset_token(db: AsyncSession, staff_id: uuid.UUID):
    # SELECT ... FOR UPDATE ã§ãƒ­ãƒƒã‚¯å–å¾—
    existing_tokens = await db.execute(
        select(PasswordResetToken)
        .where(
            PasswordResetToken.staff_id == staff_id,
            PasswordResetToken.used == False,
            PasswordResetToken.expires_at > datetime.now(timezone.utc)
        )
        .with_for_update()  # â† æ‚²è¦³çš„ãƒ­ãƒƒã‚¯
    )

    # æ—¢å­˜ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ–
    for token in existing_tokens.scalars():
        token.used = True
        token.used_at = datetime.now(timezone.utc)

    # æ–°ãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆ
    new_token = PasswordResetToken(...)
    db.add(new_token)

    return new_token
```

#### ğŸŸ¡ è»½å¾®ãªå•é¡Œ

##### 6. IPã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—ã®ä¿¡é ¼æ€§

**å•é¡Œç‚¹**:
```python
# ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã®å ´åˆã€X-Forwarded-Forã®æ¤œè¨¼ãŒå¿…è¦
# è¤‡æ•°ãƒ—ãƒ­ã‚­ã‚·çµŒç”±ã®å ´åˆã®å–å¾—æ–¹æ³•ãŒä¸æ˜ç¢º
```

**æ¨å¥¨ä¿®æ­£**:
```python
from fastapi import Request

def get_client_ip(request: Request) -> str:
    """ä¿¡é ¼ã§ãã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—"""
    # 1. X-Forwarded-Forãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
    forwarded_for = request.headers.get("X-Forwarded-For")
    if forwarded_for:
        # æœ€åˆã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰
        # æ³¨æ„: ãƒ—ãƒ­ã‚­ã‚·ãŒä¿¡é ¼ã§ãã‚‹å ´åˆã®ã¿
        return forwarded_for.split(",")[0].strip()

    # 2. X-Real-IPãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
    real_ip = request.headers.get("X-Real-IP")
    if real_ip:
        return real_ip

    # 3. ç›´æ¥æ¥ç¶šã®å ´åˆ
    return request.client.host
```

##### 7. ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ã®å†æ¤œè¨

**ç¾åœ¨**: 1æ™‚é–“
**æ¨å¥¨**: 15åˆ†ã€œ30åˆ†

**ç†ç”±**:
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã¯ç·Šæ€¥æ€§ãŒé«˜ã„
- çŸ­ã„æœŸé™ã®æ–¹ãŒã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ãŒä½ã„
- ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã¨ã®ãƒãƒ©ãƒ³ã‚¹ã§30åˆ†ãŒå¦¥å½“

**è¿½åŠ æ©Ÿèƒ½**:
```python
# ãƒˆãƒ¼ã‚¯ãƒ³å†é€ä¿¡æ©Ÿèƒ½ã‚’è¿½åŠ 
@router.post("/api/v1/auth/resend-reset-password")
@limiter.limit("3/10minute")  # ã‚ˆã‚Šå³ã—ã„ãƒ¬ãƒ¼ãƒˆåˆ¶é™
async def resend_reset_password(email: EmailStr):
    # æ—¢å­˜ã®æœªä½¿ç”¨ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç„¡åŠ¹åŒ–
    # æ–°ã—ã„ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆãƒ»é€ä¿¡
    ...
```

##### 8. CSRFå¯¾ç­–ã®è¿½åŠ 

**å•é¡Œç‚¹**:
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œï¼ˆPOST /reset-passwordï¼‰ã§CSRFå¯¾ç­–ãŒè¨€åŠã•ã‚Œã¦ã„ãªã„

**æ¨å¥¨ä¿®æ­£**:
```python
# Option 1: CSRF ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä½¿ã†ï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹ï¼‰
# ã—ã‹ã—ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã¯æœªèªè¨¼ãªã®ã§ä¸é©åˆ‡

# Option 2: Double Submit Cookie ãƒ‘ã‚¿ãƒ¼ãƒ³
# ã—ã‹ã—ã€å®Ÿè£…ãŒè¤‡é›‘

# Option 3: SameSite Cookie å±æ€§
# æ¨å¥¨: ã“ã®å ´åˆã€ãƒˆãƒ¼ã‚¯ãƒ³è‡ªä½“ãŒä¸€åº¦ã—ã‹ä½¿ãˆãªã„ãŸã‚ã€
# CSRFæ”»æ’ƒã®ãƒªã‚¹ã‚¯ã¯é™å®šçš„ã€‚ãŸã ã—ã€å¿µã®ãŸã‚è¿½åŠ å¯¾ç­–ã‚’æ¨å¥¨

# æ¨å¥¨å®Ÿè£…: ãƒªãƒ•ã‚¡ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
from urllib.parse import urlparse

def validate_referer(request: Request):
    referer = request.headers.get("Referer")
    if not referer:
        raise HTTPException(403, "Invalid request")

    referer_host = urlparse(referer).netloc
    allowed_hosts = [
        "yourdomain.com",
        "www.yourdomain.com"
    ]

    if referer_host not in allowed_hosts:
        raise HTTPException(403, "Invalid referer")
```

---

### 8.2 ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ãƒ¬ãƒ“ãƒ¥ãƒ¼

#### âœ… è‰¯å¥½ãªè¨­è¨ˆãƒã‚¤ãƒ³ãƒˆ

1. **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ä½¿ç”¨** - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œæ™‚
2. **ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯** - ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ä¿è¨¼

#### ğŸ”´ é‡å¤§ãªå•é¡Œ

##### 1. ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œ

**å•é¡Œ**: ä¸Šè¨˜ 8.1 ã®ã€Œé‡å¤§ãªå•é¡Œ #2ã€ã‚’å‚ç…§

**ä¿®æ­£æ¸ˆã¿æ¨å¥¨ãƒ‘ã‚¿ãƒ¼ãƒ³**:
```python
# ãƒ‘ã‚¿ãƒ¼ãƒ³1: ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã¯ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤–ï¼ˆæ¨å¥¨ï¼‰
async with db.begin():
    # DBæ“ä½œã®ã¿
    token = await create_token(...)

# ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å®Œäº†å¾Œ
await send_email(...)  # å¤±æ•—ã—ã¦ã‚‚DBçŠ¶æ…‹ã¯ä¸€è²«

# ãƒ‘ã‚¿ãƒ¼ãƒ³2: Sagaãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆè¤‡é›‘ãªå ´åˆï¼‰
try:
    async with db.begin():
        token = await create_token(...)

    await send_email(...)
except EmailError:
    # è£œå„Ÿãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
    async with db.begin():
        await mark_token_as_failed(token.id)
```

#### ğŸŸ  ä¸­ç¨‹åº¦ã®å•é¡Œ

##### 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³

**å•é¡Œç‚¹**:
```python
# ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œæ™‚ã®å‡¦ç†é †åº
1. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°
2. password_changed_at æ›´æ–°
3. ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹åŒ–
4. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–  # â† ã©ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼Ÿ
```

**æ¨å¥¨ä¿®æ­£**:
```python
async def reset_password(token: str, new_password: str, db: AsyncSession):
    # å˜ä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å…¨ã¦å®Ÿè¡Œ
    async with db.begin():
        # 1. ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ãƒ»å–å¾—ï¼ˆFOR UPDATEï¼‰
        token_record = await db.execute(
            select(PasswordResetToken)
            .where(PasswordResetToken.token_hash == hash(token))
            .with_for_update()
        )

        # 2. ã‚¹ã‚¿ãƒƒãƒ•å–å¾—ï¼ˆFOR UPDATEï¼‰
        staff = await db.execute(
            select(Staff)
            .where(Staff.id == token_record.staff_id)
            .with_for_update()
        )

        # 3. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°
        staff.hashed_password = hash_password(new_password)
        staff.password_changed_at = datetime.now(timezone.utc)

        # 4. ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹åŒ–
        token_record.used = True
        token_record.used_at = datetime.now(timezone.utc)

        # 5. å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–ï¼ˆåŒä¸€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ï¼‰
        await db.execute(
            update(Session)
            .where(Session.staff_id == staff.id)
            .values(
                is_active=False,
                revoked_at=datetime.now(timezone.utc)
            )
        )

        # ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆ

    # ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å®Œäº†å¾Œ
    await send_password_changed_notification(staff.email)
```

##### 3. ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯é˜²æ­¢ã®ãŸã‚ã®ãƒ­ãƒƒã‚¯é †åº

**å•é¡Œç‚¹**:
è¤‡æ•°ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°ã™ã‚‹éš›ã€ãƒ­ãƒƒã‚¯é †åºãŒçµ±ä¸€ã•ã‚Œã¦ã„ãªã„ã¨ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ãŒç™ºç”Ÿ

**æ¨å¥¨ä¿®æ­£**:
```python
# ãƒ­ãƒƒã‚¯é †åºã‚’çµ±ä¸€
# æ¨å¥¨é †åº: 1. staffs â†’ 2. password_reset_tokens â†’ 3. sessions â†’ 4. audit_logs

async def reset_password_with_proper_lock_order(...):
    async with db.begin():
        # 1. ã¾ãš Staff ã‚’ãƒ­ãƒƒã‚¯
        staff = await db.execute(
            select(Staff).where(...).with_for_update()
        )

        # 2. æ¬¡ã« PasswordResetToken ã‚’ãƒ­ãƒƒã‚¯
        token = await db.execute(
            select(PasswordResetToken).where(...).with_for_update()
        )

        # 3. Sessions ã‚’æ›´æ–°ï¼ˆãƒ­ãƒƒã‚¯ä¸è¦ã€UPDATEã§è‡ªå‹•ãƒ­ãƒƒã‚¯ï¼‰
        await db.execute(update(Session).where(...))

        # 4. æœ€å¾Œã«ç›£æŸ»ãƒ­ã‚°ã‚’æŒ¿å…¥
        db.add(PasswordResetAuditLog(...))
```

#### ğŸŸ¡ è»½å¾®ãªå•é¡Œ

##### 4. ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³æˆ¦ç•¥

**å•é¡Œç‚¹**:
ç›£æŸ»ãƒ­ã‚°ãŒãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã ã¨ã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã«ãƒ­ã‚°ã‚‚æ¶ˆãˆã‚‹

**æ¨å¥¨ä¿®æ­£**:
```python
# Option 1: ç›£æŸ»ãƒ­ã‚°ã¯åˆ¥ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ¨å¥¨ï¼‰
async def reset_password(...):
    try:
        async with db.begin():
            # ãƒ¡ã‚¤ãƒ³å‡¦ç†
            ...

        # æˆåŠŸãƒ­ã‚°ï¼ˆåˆ¥ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
        await log_audit(action="completed", ...)

    except Exception as e:
        # å¤±æ•—ãƒ­ã‚°ï¼ˆåˆ¥ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã€ç¢ºå®Ÿã«è¨˜éŒ²ï¼‰
        await log_audit(action="failed", error=str(e), ...)
        raise

# Option 2: PostgreSQL AUTONOMOUS TRANSACTION (pg æ‹¡å¼µ)
# ã—ã‹ã—ã€SQLAlchemy ã§ã¯æ¨™æº–ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„
```

##### 5. ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¸ãƒ§ãƒ–ã¨ã®ç«¶åˆ

**å•é¡Œç‚¹**:
æœŸé™åˆ‡ã‚Œãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤ã‚¸ãƒ§ãƒ–ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç«¶åˆ

**æ¨å¥¨ä¿®æ­£**:
```python
# ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¸ãƒ§ãƒ–ï¼ˆæ¯æ—¥å®Ÿè¡Œï¼‰
async def cleanup_expired_tokens(db: AsyncSession):
    # DELETE ã§ã¯ãªãè«–ç†å‰Šé™¤ã‚’ä½¿ã†
    await db.execute(
        update(PasswordResetToken)
        .where(
            PasswordResetToken.expires_at < datetime.now(timezone.utc),
            PasswordResetToken.used == False
        )
        .values(used=True, used_at=datetime.now(timezone.utc))
    )

    # å¤ã„ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ç‰©ç†å‰Šé™¤ï¼ˆä¾‹: 30æ—¥ä»¥ä¸Šå‰ï¼‰
    await db.execute(
        delete(PasswordResetToken)
        .where(
            PasswordResetToken.created_at <
            datetime.now(timezone.utc) - timedelta(days=30)
        )
    )
```

---

### 8.3 æ¨å¥¨ã•ã‚Œã‚‹è¿½åŠ å®Ÿè£…

#### 1. ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ã®å®Œå…¨ãªå®Ÿè£…ä¾‹

```python
import hashlib
import secrets
from datetime import datetime, timezone

async def verify_reset_token(
    token: str,
    db: AsyncSession
) -> Optional[PasswordResetToken]:
    """
    ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼

    ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒå¯¾ç­–ã‚’å«ã‚€
    """
    # ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–
    token_hash = hashlib.sha256(token.encode()).hexdigest()

    # DBã‹ã‚‰å–å¾—
    result = await db.execute(
        select(PasswordResetToken)
        .where(PasswordResetToken.token_hash == token_hash)
    )
    db_token = result.scalar_one_or_none()

    # Constant-timeæ¤œè¨¼
    if not db_token:
        # ãƒ€ãƒŸãƒ¼å‡¦ç†ã§æ™‚é–“ã‚’æƒãˆã‚‹
        secrets.compare_digest("dummy_hash", "dummy_hash")
        return None

    # å…¨æ¡ä»¶ã‚’è©•ä¾¡
    is_not_used = not db_token.used
    is_not_expired = db_token.expires_at > datetime.now(timezone.utc)

    # å…¨ã¦çœŸã®å ´åˆã®ã¿æˆåŠŸ
    if is_not_used and is_not_expired:
        return db_token

    return None
```

#### 2. å®Œå…¨ãªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè£…ä¾‹

```python
async def execute_password_reset(
    token: str,
    new_password: str,
    db: AsyncSession,
    request: Request
) -> None:
    """
    ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆã®å®Œå…¨ãªå®Ÿè£…

    ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ã¨ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å«ã‚€
    """
    # 1. ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ï¼ˆèª­ã¿å–ã‚Šã®ã¿ï¼‰
    token_record = await verify_reset_token(token, db)
    if not token_record:
        await log_audit_async(
            action="failed",
            reason="invalid_token",
            ip=get_client_ip(request)
        )
        raise HTTPException(400, ja.AUTH_RESET_TOKEN_INVALID_OR_EXPIRED)

    # 2. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    try:
        async with db.begin():
            # 2.1 ãƒ­ãƒƒã‚¯é †åº: Staff â†’ PasswordResetToken â†’ Session

            # Staff ã‚’ãƒ­ãƒƒã‚¯
            staff = await db.execute(
                select(Staff)
                .where(Staff.id == token_record.staff_id)
                .with_for_update()
            )
            staff = staff.scalar_one()

            # ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å†æ¤œè¨¼ & ãƒ­ãƒƒã‚¯ï¼ˆæ¥½è¦³çš„ãƒ­ãƒƒã‚¯ï¼‰
            update_result = await db.execute(
                update(PasswordResetToken)
                .where(
                    PasswordResetToken.id == token_record.id,
                    PasswordResetToken.used == False  # æ¥½è¦³çš„ãƒ­ãƒƒã‚¯æ¡ä»¶
                )
                .values(
                    used=True,
                    used_at=datetime.now(timezone.utc)
                )
            )

            if update_result.rowcount == 0:
                raise HTTPException(409, ja.AUTH_RESET_TOKEN_ALREADY_USED)

            # ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°
            staff.hashed_password = get_password_hash(new_password)
            staff.password_changed_at = datetime.now(timezone.utc)

            # å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–
            await db.execute(
                update(Session)
                .where(Session.staff_id == staff.id)
                .values(
                    is_active=False,
                    revoked_at=datetime.now(timezone.utc)
                )
            )

            # ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³è‡ªå‹•ã‚³ãƒŸãƒƒãƒˆ

        # 3. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¤–ã®å‡¦ç†
        # é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡
        try:
            await send_password_changed_notification(staff.email)
        except EmailError as e:
            # ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—ã¯ãƒ­ã‚°ã®ã¿ï¼ˆå‡¦ç†ã¯æˆåŠŸæ‰±ã„ï¼‰
            logger.error(f"Failed to send notification email: {e}")

        # æˆåŠŸç›£æŸ»ãƒ­ã‚°ï¼ˆåˆ¥ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
        await log_audit_async(
            action="completed",
            staff_id=staff.id,
            ip=get_client_ip(request)
        )

    except HTTPException:
        # æ—¢çŸ¥ã®ã‚¨ãƒ©ãƒ¼ã¯å†é€å‡º
        raise
    except Exception as e:
        # äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼
        logger.error(f"Password reset failed: {e}")
        await log_audit_async(
            action="failed",
            reason="unexpected_error",
            error=str(e),
            ip=get_client_ip(request)
        )
        raise HTTPException(
            500,
            ja.AUTH_PASSWORD_RESET_FAILED
        )
```

---

### 8.4 ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã‚µãƒãƒªãƒ¼

| æ·±åˆ»åº¦ | é …ç›®æ•° | ä¸»ãªå•é¡Œ |
|--------|--------|----------|
| ğŸ”´ é‡å¤§ | 2 | ãƒˆãƒ¼ã‚¯ãƒ³ãƒãƒƒã‚·ãƒ¥åŒ–ã®çŸ›ç›¾ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œ |
| ğŸŸ  ä¸­ç¨‹åº¦ | 5 | ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒã€æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ã€ä¸¦è¡Œå‡¦ç† |
| ğŸŸ¡ è»½å¾® | 5 | IPå–å¾—ã€æœ‰åŠ¹æœŸé™ã€CSRFã€ç›£æŸ»ãƒ­ã‚° |

**ç·åˆè©•ä¾¡**: âš ï¸ **Phase 2 é€²è¡Œå‰ã«é‡å¤§ãªå•é¡Œã®ä¿®æ­£ãŒå¿…è¦**

**æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³**:
1. âœ… ãƒˆãƒ¼ã‚¯ãƒ³ãƒãƒƒã‚·ãƒ¥åŒ–ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼ã‚’æ˜ç¢ºåŒ–ï¼ˆ8.1 #1ï¼‰
2. âœ… ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã‚’æ˜ç¢ºåŒ–ï¼ˆ8.1 #2, 8.2 #1ï¼‰
3. âœ… æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ã®å…·ä½“çš„å®Ÿè£…ã‚’è¿½åŠ ï¼ˆ8.1 #4ï¼‰
4. âš ï¸ ã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒå¯¾ç­–ã‚’è¿½åŠ ï¼ˆ8.1 #3ï¼‰
5. âš ï¸ ä¸¦è¡Œå‡¦ç†ã®ãƒ¬ãƒ¼ã‚¹ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³å¯¾ç­–ï¼ˆ8.1 #5ï¼‰

---

## Next Steps

**ä¿®æ­£å¾Œã®ãƒ•ã‚§ãƒ¼ã‚ºé€²è¡Œ**:
1. æœ¬ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœã«åŸºã¥ã Phase 1 è¨­è¨ˆã‚’ä¿®æ­£
2. Phase 2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã¸é€²ã‚€
   - ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã‚«ãƒ©ãƒ è¿½åŠ ï¼‰
   - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆ
   - ORM ãƒ¢ãƒ‡ãƒ«å®Ÿè£…ï¼ˆæ¥½è¦³çš„ãƒ­ãƒƒã‚¯å¯¾å¿œï¼‰
