# 管理者向け事務所操作機能 要件定義書

**作業ブランチ**: `issue/feature-管理者_事務所情報変更機能`

**最終更新日**: 2024-11-24

---

## 目次

1. [プロジェクト概要](#1-プロジェクト概要)
2. [スタッフ削除機能](#2-スタッフ削除機能)
3. [事務所情報変更機能](#3-事務所情報変更機能)
4. [システム通知機能（自動発動）](#4-システム通知機能自動発動)
5. [非機能要件](#5-非機能要件)
6. [実装スケジュール](#6-実装スケジュール)

---

## 1. プロジェクト概要

### 1.1 目的

管理者（Owner）が事務所のスタッフおよび事務所情報を適切に管理できる機能を提供します。操作が実行されると、システムが自動的に一斉通知を送信し、事務所内の全スタッフに変更内容を周知します。

### 1.2 対象ユーザー

- **主要ユーザー**: Owner（事務所管理者）
- **副次的ユーザー**: 事務所に所属する全Staff（通知の受信者）

### 1.3 提供機能

| 機能名 | 概要 | 権限 |
|--------|------|------|
| スタッフ削除 | 所属スタッフを論理削除し、即座にアクセスを無効化 | Owner のみ |
| 事務所情報変更 | 事務所の基本情報（名称、住所等）を更新 | Owner のみ |
| システム通知（自動） | 上記操作実行時に自動的に一斉通知を送信 | システム自動実行 |

### 1.4 技術スタック

- **フロントエンド**: React + TypeScript, AdminMenu.tsx
- **バックエンド**: FastAPI (Python), SQLAlchemy 2.0
- **データベース**: PostgreSQL
- **認証**: JWT（Cookie-based）

---

## 2. スタッフ削除機能

### 2.1 機能概要

管理者が AdminMenu の「事務所タブ」から所属スタッフを削除できる機能です。削除は論理削除で実装され、削除されたスタッフは即座にログアウトされ、再ログインができなくなります。

### 2.2 ビジネス要件

#### 2.2.1 背景と目的

事務所から退職したスタッフや、不正行為が発覚したスタッフのアクセス権限を即座に無効化する必要があります。物理削除ではなく論理削除を採用することで、監査証跡を保持し、将来的な復旧や調査を可能にします。

#### 2.2.2 主要なビジネスルール

1. **削除実行権限**: Owner のみが削除を実行できる
2. **自己削除の禁止**: 自分自身を削除することはできない
3. **最後のOwner保護**: 事務所に残る唯一のOwnerは削除できない
4. **即座のアクセス無効化**: 削除と同時に全トークンを無効化し、セッションを終了させる
5. **同一事務所内のみ**: 異なる事務所のスタッフは削除できない
6. **監査証跡の保持**: 誰が、いつ、誰を削除したかを記録する

#### 2.2.3 削除時の挙動

```
削除実行
  ↓
1. スタッフレコードの論理削除（is_deleted = True）
2. 削除日時の記録（deleted_at）
3. 削除実行者の記録（deleted_by）
4. 全リフレッシュトークンの無効化
5. 監査ログへの記録
6. 事務所全体への一斉通知送信（システム自動）
  ↓
結果: 対象スタッフは即座にログアウトされ、再ログイン不可
```

### 2.3 ユーザーインターフェース要件

#### 2.3.1 表示場所

- **画面**: AdminMenu.tsx
- **タブ**: 事務所タブ
- **セクション**: スタッフ一覧テーブル

#### 2.3.2 UI要素

**削除ボタン**
- 位置: 各スタッフ行の操作列
- アイコン: 🗑️
- ラベル: "削除"
- 表示条件:
  - ログインユーザーのロールが Owner である
  - 対象スタッフが自分自身でない
- ホバー時のツールチップ: "このスタッフを削除します"

**削除確認ダイアログ**
- タイトル: "スタッフ削除の確認"
- メッセージ:
  ```
  スタッフ「{姓} {名}」を削除しますか？

  削除すると、このスタッフはログインできなくなります。
  この操作は取り消せません。
  ```
- ボタン:
  - 主要アクション: "削除する"（赤色、危険を示す）
  - 副次アクション: "キャンセル"（グレー）

**ローディング状態**
- 削除処理中: ボタンテキストが "削除中..." に変化
- ボタンは無効化され、クリックできない
- スピナーアニメーションを表示

**フィードバックメッセージ**
- 成功時: "スタッフを削除しました"（緑色の成功メッセージ）
- エラー時: エラー内容に応じたメッセージ（赤色のエラーメッセージ）

#### 2.3.3 操作フロー

```
1. Ownerがスタッフ一覧テーブルを表示
   ↓
2. 削除したいスタッフの行の「削除」ボタンをクリック
   ↓
3. 削除確認ダイアログが表示される
   - 対象スタッフの氏名が表示される
   - 操作の重大性を警告するメッセージが表示される
   ↓
4. Ownerが「削除する」をクリック
   ↓
5. DELETE /api/v1/auth/staffs/{staff_id} を呼び出し
   - ボタンが "削除中..." に変化
   - ダイアログのボタンが無効化
   ↓
6. APIレスポンス受信
   ↓
7a. 成功の場合:
    - ダイアログを閉じる
    - 成功メッセージを表示
    - スタッフ一覧を再取得
    - 削除されたスタッフの行が消える
   ↓
7b. エラーの場合:
    - エラーメッセージを表示
    - ダイアログは開いたまま
    - ボタンを再度有効化
```

### 2.4 API仕様

#### 2.4.1 スタッフ削除エンドポイント

**エンドポイント**: `DELETE /api/v1/auth/staffs/{staff_id}`

**認証**: JWT必須（Cookie: `access_token`）

**権限**: Owner のみ（`require_owner` dependency）

**パスパラメータ**:
| パラメータ | 型 | 説明 |
|-----------|-----|------|
| staff_id | UUID | 削除対象スタッフのID |

**リクエストボディ**: なし

**レスポンス（成功時）**:
```json
{
  "message": "スタッフを削除しました",
  "staff_id": "123e4567-e89b-12d3-a456-426614174000",
  "deleted_at": "2024-11-24T05:30:00Z"
}
```

**ステータスコード**:
| コード | 状況 | 説明 |
|--------|------|------|
| 200 | 成功 | スタッフが正常に削除された |
| 400 | バリデーションエラー | 自分自身を削除しようとした、または既に削除済み |
| 403 | 権限エラー | Ownerでない、または別の事務所のスタッフ |
| 404 | Not Found | 指定されたスタッフIDが存在しない |
| 409 | 競合エラー | 最後のOwnerを削除しようとした |

**エラーレスポンス例**:
```json
{
  "detail": "自分自身は削除できません"
}
```

#### 2.4.2 バリデーションルール

削除処理の前に以下のバリデーションを実施します:

1. **スタッフの存在確認**
   - 指定されたスタッフIDが存在するか確認
   - 存在しない場合: `404 Not Found`

2. **削除済みチェック**
   - `is_deleted` が既に `True` でないか確認
   - 既に削除済みの場合: `400 Bad Request` "このスタッフは既に削除されています"

3. **同一事務所チェック**
   - 削除対象スタッフの `office_id` がログインユーザーの `office_id` と一致するか確認
   - 異なる事務所の場合: `403 Forbidden` "異なる事務所のスタッフは削除できません"

4. **自己削除チェック**
   - 削除対象スタッフIDがログインユーザーのIDと一致しないか確認
   - 一致する場合: `400 Bad Request` "自分自身は削除できません"

5. **最後のOwnerチェック**
   - 削除対象スタッフが Owner の場合、事務所内の有効な Owner が2人以上いるか確認
   - 最後のOwnerの場合: `409 Conflict` "最後のOwnerは削除できません"

### 2.5 データ設計

#### 2.5.1 Staff テーブル拡張

既存の `staff` テーブルに以下のカラムを追加します:

| カラム名 | 型 | NULL許可 | デフォルト | 説明 |
|---------|-----|----------|-----------|------|
| is_deleted | BOOLEAN | NOT NULL | FALSE | 論理削除フラグ |
| deleted_at | TIMESTAMP WITH TIME ZONE | NULL | NULL | 削除日時（UTC） |
| deleted_by | UUID | NULL | NULL | 削除を実行したスタッフのID（staff.id への外部キー） |

**インデックス**:
```sql
CREATE INDEX idx_staff_is_deleted ON staff(is_deleted);
CREATE INDEX idx_staff_office_id_is_deleted ON staff(office_id, is_deleted);
```

理由:
- スタッフ一覧取得時に `is_deleted = FALSE` でフィルタリングするため
- 事務所ごとの有効なスタッフを高速に取得するため

#### 2.5.2 監査ログテーブル（新規作成推奨）

スタッフ操作の監査証跡を記録するため、`staff_audit_log` テーブルを作成します:

| カラム名 | 型 | NULL許可 | 説明 |
|---------|-----|----------|------|
| id | UUID | NOT NULL | 主キー |
| staff_id | UUID | NOT NULL | 対象スタッフID（staff.id への外部キー） |
| action | VARCHAR(50) | NOT NULL | 操作種別（"deleted", "created", "updated" など） |
| performed_by | UUID | NOT NULL | 操作実行者のスタッフID（staff.id への外部キー） |
| ip_address | VARCHAR(45) | NULL | 操作元のIPアドレス |
| user_agent | TEXT | NULL | 操作元のUser-Agent |
| details | JSONB | NULL | 操作の詳細情報（JSON形式） |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL | 記録日時（UTC） |

**details カラムの例**:
```json
{
  "deleted_staff_email": "example@example.com",
  "deleted_staff_name": "山田 太郎",
  "deleted_staff_role": "Employee"
}
```

### 2.6 セキュリティ要件

#### 2.6.1 認証・認可

- **JWT認証必須**: すべてのエンドポイントでJWT検証を実施
- **ロールベースアクセス制御（RBAC）**: Owner のみが削除を実行可能
- **トークン無効化**: 削除されたスタッフの全トークンを即座に無効化

#### 2.6.2 セッション無効化の実装

削除処理時に以下を実施します:

1. **リフレッシュトークンの無効化**
   - `refresh_tokens` テーブルで `staff_id` に一致する全レコードの `is_revoked` を `True` に設定
   - `revoked_at` に現在日時を記録

2. **アクセストークンの検証強化**
   - `get_current_user()` 依存性注入で、スタッフの `is_deleted` をチェック
   - `is_deleted = True` の場合は `403 Forbidden` を返却
   - これにより、既存のアクセストークンも実質的に無効化される

3. **ログイン時のチェック**
   - ログインエンドポイントで、スタッフの `is_deleted` をチェック
   - `is_deleted = True` の場合は `403 Forbidden` "このアカウントは削除されています"

#### 2.6.3 監査証跡

すべての削除操作を監査ログに記録します:

- 操作実行者のID
- 削除されたスタッフのID、メールアドレス、氏名、ロール
- 操作日時（UTC）
- 操作元のIPアドレス
- User-Agent

### 2.7 エラーハンドリング

#### 2.7.1 バックエンドエラーメッセージ

すべてのエラーメッセージは日本語で返却します:

| エラー | メッセージ |
|--------|-----------|
| スタッフが存在しない | "スタッフが見つかりません" |
| 既に削除済み | "このスタッフは既に削除されています" |
| 自分自身を削除 | "自分自身は削除できません" |
| 最後のOwnerを削除 | "最後のOwnerは削除できません" |
| 異なる事務所のスタッフ | "異なる事務所のスタッフは削除できません" |
| 権限不足 | "この操作を実行する権限がありません" |

#### 2.7.2 フロントエンドエラーハンドリング

APIレスポンスのステータスコードに応じて適切なメッセージを表示します:

```typescript
try {
  await apiClient.deleteStaff(staffId);
  setMessage('スタッフを削除しました');
  await fetchStaffList();
} catch (error: any) {
  const status = error.response?.status;
  const detail = error.response?.data?.detail;

  if (status === 400) {
    setError(detail || 'バリデーションエラーが発生しました');
  } else if (status === 403) {
    setError('この操作を実行する権限がありません');
  } else if (status === 404) {
    setError('スタッフが見つかりません');
  } else if (status === 409) {
    setError('最後のOwnerは削除できません');
  } else {
    setError('スタッフの削除に失敗しました');
  }
}
```

---

## 3. 事務所情報変更機能

### 3.1 機能概要

管理者が AdminMenu の「事務所タブ」から事務所の基本情報（名称、住所、電話番号等）を変更できる機能です。変更内容は即座に反映され、事務所に所属する全スタッフに自動的に通知されます。

### 3.2 ビジネス要件

#### 3.2.1 背景と目的

事務所の移転や組織変更に伴い、事務所情報を更新する必要があります。変更内容を全スタッフに周知することで、情報の一貫性を保ち、業務上の混乱を防ぎます。

#### 3.2.2 主要なビジネスルール

1. **変更実行権限**: Owner のみが変更を実行できる
2. **必須項目の検証**: 事務所名は必須であり、空欄にできない
3. **即座の反映**: 変更は即座にデータベースに反映される
4. **全スタッフへの周知**: 変更完了後、自動的に一斉通知を送信
5. **監査証跡の保持**: 誰が、いつ、何を変更したかを記録する

#### 3.2.3 変更対象項目

| 項目 | フィールド名 | 型 | 必須 | 制約 |
|------|------------|-----|------|------|
| 事務所名 | office_name | VARCHAR(255) | ✅ | 1〜255文字 |
| 郵便番号 | postal_code | VARCHAR(10) | - | 半角数字、ハイフン可 |
| 都道府県 | prefecture | VARCHAR(50) | - | - |
| 市区町村 | city | VARCHAR(100) | - | - |
| 番地 | street_address | VARCHAR(255) | - | - |
| 建物名・部屋番号 | building | VARCHAR(255) | - | - |
| 電話番号 | phone_number | VARCHAR(20) | - | 半角数字、ハイフン可 |

### 3.3 ユーザーインターフェース要件

#### 3.3.1 表示場所

- **画面**: AdminMenu.tsx
- **タブ**: 事務所タブ
- **セクション**: 事務所情報セクション

#### 3.3.2 UI要素

**事務所情報編集ボタン**
- 位置: 事務所情報セクションの右上
- ラベル: "✏️ 編集"
- 表示条件: ログインユーザーのロールが Owner である

**事務所情報編集モーダル**
- タイトル: "事務所情報の編集"
- フォーム項目:
  - 事務所名（必須）
  - 郵便番号
  - 都道府県
  - 市区町村
  - 番地
  - 建物名・部屋番号
  - 電話番号
- ボタン:
  - 主要アクション: "保存"（青色）
  - 副次アクション: "キャンセル"（グレー）

**バリデーション**
- 事務所名が空の場合: "事務所名は必須です" とエラー表示
- 郵便番号の形式が不正な場合: "郵便番号の形式が正しくありません"
- 電話番号の形式が不正な場合: "電話番号の形式が正しくありません"

**ローディング状態**
- 保存処理中: ボタンテキストが "保存中..." に変化
- ボタンは無効化され、クリックできない
- スピナーアニメーションを表示

**フィードバックメッセージ**
- 成功時: "事務所情報を更新しました"（緑色の成功メッセージ）
- エラー時: エラー内容に応じたメッセージ（赤色のエラーメッセージ）

#### 3.3.3 操作フロー

```
1. Ownerが事務所タブを表示
   ↓
2. 「編集」ボタンをクリック
   ↓
3. 事務所情報編集モーダルが表示される
   - 現在の事務所情報がフォームに入力された状態で表示される
   ↓
4. Ownerが情報を編集し、「保存」をクリック
   ↓
5. クライアント側でバリデーション実施
   - エラーがある場合はエラーメッセージを表示し、処理を中断
   ↓
6. PUT /api/v1/offices/{office_id} を呼び出し
   - ボタンが "保存中..." に変化
   - フォームが無効化
   ↓
7. APIレスポンス受信
   ↓
8a. 成功の場合:
    - モーダルを閉じる
    - 成功メッセージを表示
    - 事務所情報を再取得して表示を更新
   ↓
8b. エラーの場合:
    - エラーメッセージを表示
    - モーダルは開いたまま
    - フォームを再度有効化
```

### 3.4 API仕様

#### 3.4.1 事務所情報更新エンドポイント

**エンドポイント**: `PUT /api/v1/offices/{office_id}`

**認証**: JWT必須（Cookie: `access_token`）

**権限**: Owner のみ（`require_owner` dependency）

**パスパラメータ**:
| パラメータ | 型 | 説明 |
|-----------|-----|------|
| office_id | UUID | 更新対象事務所のID |

**リクエストボディ**:
```json
{
  "office_name": "○○法律事務所",
  "postal_code": "100-0001",
  "prefecture": "東京都",
  "city": "千代田区",
  "street_address": "千代田1-1-1",
  "building": "千代田ビル3F",
  "phone_number": "03-1234-5678"
}
```

**レスポンス（成功時）**:
```json
{
  "id": "123e4567-e89b-12d3-a456-426614174000",
  "office_name": "○○法律事務所",
  "postal_code": "100-0001",
  "prefecture": "東京都",
  "city": "千代田区",
  "street_address": "千代田1-1-1",
  "building": "千代田ビル3F",
  "phone_number": "03-1234-5678",
  "updated_at": "2024-11-24T05:30:00Z"
}
```

**ステータスコード**:
| コード | 状況 | 説明 |
|--------|------|------|
| 200 | 成功 | 事務所情報が正常に更新された |
| 400 | バリデーションエラー | 必須項目が不足、または形式が不正 |
| 403 | 権限エラー | Ownerでない、または別の事務所 |
| 404 | Not Found | 指定された事務所IDが存在しない |

#### 3.4.2 バリデーションルール

更新処理の前に以下のバリデーションを実施します:

1. **事務所の存在確認**
   - 指定された事務所IDが存在するか確認
   - 存在しない場合: `404 Not Found`

2. **同一事務所チェック**
   - 更新対象事務所IDがログインユーザーの所属事務所IDと一致するか確認
   - 異なる事務所の場合: `403 Forbidden` "他の事務所の情報は変更できません"

3. **必須項目チェック**
   - `office_name` が空でないか確認
   - 空の場合: `400 Bad Request` "事務所名は必須です"

4. **形式チェック**
   - `postal_code`: 正規表現 `^\d{3}-?\d{4}$` にマッチするか確認
   - `phone_number`: 正規表現 `^0\d{1,4}-?\d{1,4}-?\d{4}$` にマッチするか確認
   - 不正な場合: `400 Bad Request` "{項目名}の形式が正しくありません"

### 3.5 データ設計

#### 3.5.1 Office テーブル

既存の `offices` テーブルを使用します（新規カラム追加は不要）:

| カラム名 | 型 | NULL許可 | 説明 |
|---------|-----|----------|------|
| id | UUID | NOT NULL | 主キー |
| office_name | VARCHAR(255) | NOT NULL | 事務所名 |
| postal_code | VARCHAR(10) | NULL | 郵便番号 |
| prefecture | VARCHAR(50) | NULL | 都道府県 |
| city | VARCHAR(100) | NULL | 市区町村 |
| street_address | VARCHAR(255) | NULL | 番地 |
| building | VARCHAR(255) | NULL | 建物名・部屋番号 |
| phone_number | VARCHAR(20) | NULL | 電話番号 |
| created_at | TIMESTAMP WITH TIME ZONE | NOT NULL | 作成日時 |
| updated_at | TIMESTAMP WITH TIME ZONE | NOT NULL | 更新日時 |

### 3.6 セキュリティ要件

#### 3.6.1 認証・認可

- **JWT認証必須**: すべてのエンドポイントでJWT検証を実施
- **ロールベースアクセス制御（RBAC）**: Owner のみが変更を実行可能
- **同一事務所チェック**: 自分の所属事務所の情報のみ変更可能

#### 3.6.2 監査証跡

すべての事務所情報変更操作を監査ログに記録します（既存の監査ログ機構を活用）:

- 操作実行者のID
- 変更された事務所のID、名称
- 変更前の情報と変更後の情報（JSON形式）
- 操作日時（UTC）
- 操作元のIPアドレス
- User-Agent

### 3.7 エラーハンドリング

#### 3.7.1 バックエンドエラーメッセージ

すべてのエラーメッセージは日本語で返却します:

| エラー | メッセージ |
|--------|-----------|
| 事務所が存在しない | "事務所が見つかりません" |
| 事務所名が空 | "事務所名は必須です" |
| 郵便番号の形式不正 | "郵便番号の形式が正しくありません" |
| 電話番号の形式不正 | "電話番号の形式が正しくありません" |
| 他の事務所を変更 | "他の事務所の情報は変更できません" |
| 権限不足 | "この操作を実行する権限がありません" |

#### 3.7.2 フロントエンドエラーハンドリング

```typescript
try {
  await apiClient.updateOffice(officeId, officeData);
  setMessage('事務所情報を更新しました');
  setShowEditModal(false);
  await fetchOfficeInfo();
} catch (error: any) {
  const status = error.response?.status;
  const detail = error.response?.data?.detail;

  if (status === 400) {
    setError(detail || 'バリデーションエラーが発生しました');
  } else if (status === 403) {
    setError('この操作を実行する権限がありません');
  } else if (status === 404) {
    setError('事務所が見つかりません');
  } else {
    setError('事務所情報の更新に失敗しました');
  }
}
```

---

## 4. システム通知機能（自動発動）

### 4.1 機能概要

スタッフ削除または事務所情報変更が実行されると、システムが自動的に一斉通知（announcement）を送信し、事務所に所属する全スタッフに変更内容を周知します。

### 4.2 通知の種別

本機能で送信される通知は、既存のメッセージ機能の `announcement`（一斉通知）を使用します。

### 4.3 スタッフ削除時の通知

#### 4.3.1 発動条件

- スタッフ削除処理が正常に完了した時（トランザクションコミット後）

#### 4.3.2 通知内容

| 項目 | 内容 |
|------|------|
| 通知種別 | `announcement` |
| タイトル | "スタッフ削除のお知らせ" |
| 本文 | "{削除されたスタッフの姓} {削除されたスタッフの名}が事務所から削除されました。" |
| 優先度 | `normal` |
| 送信者 | 削除を実行したスタッフ（Owner） |
| 受信者 | 削除されたスタッフが所属していた事務所の全スタッフ（削除されたスタッフ自身を除く） |

#### 4.3.3 実装方法

スタッフ削除エンドポイント内で、削除処理成功後に以下を実行します:

```python
# スタッフ削除処理完了後（同一トランザクション内）

# 削除されたスタッフの情報を取得
deleted_staff_name = f"{target_staff.last_name} {target_staff.first_name}"

# 事務所内の全スタッフを取得（削除されたスタッフを除く）
all_staff = await crud.staff.get_by_office_id(
    db=db,
    office_id=current_user.office_id,
    exclude_deleted=True
)
recipient_ids = [staff.id for staff in all_staff if staff.id != target_staff.id]

# 一斉通知を作成
message_data = {
    "sender_staff_id": current_user.id,
    "office_id": current_user.office_id,
    "recipient_ids": recipient_ids,
    "message_type": MessageType.announcement,
    "priority": MessagePriority.normal,
    "title": "スタッフ削除のお知らせ",
    "content": f"{deleted_staff_name}が事務所から削除されました。"
}

await crud_message.create_announcement(db=db, obj_in=message_data)
```

### 4.4 事務所情報変更時の通知

#### 4.4.1 発動条件

- 事務所情報更新処理が正常に完了した時（トランザクションコミット後）

#### 4.4.2 通知内容

| 項目 | 内容 |
|------|------|
| 通知種別 | `announcement` |
| タイトル | "事務所情報変更のお知らせ" |
| 本文 | "事務所情報が更新されました。変更内容をご確認ください。" |
| 優先度 | `normal` |
| 送信者 | 変更を実行したスタッフ（Owner） |
| 受信者 | 当該事務所に所属する全スタッフ |

#### 4.4.3 実装方法

事務所情報更新エンドポイント内で、更新処理成功後に以下を実行します:

```python
# 事務所情報更新処理完了後（同一トランザクション内）

# 事務所内の全スタッフを取得
all_staff = await crud.staff.get_by_office_id(
    db=db,
    office_id=office_id,
    exclude_deleted=True
)
recipient_ids = [staff.id for staff in all_staff]

# 一斉通知を作成
message_data = {
    "sender_staff_id": current_user.id,
    "office_id": office_id,
    "recipient_ids": recipient_ids,
    "message_type": MessageType.announcement,
    "priority": MessagePriority.normal,
    "title": "事務所情報変更のお知らせ",
    "content": "事務所情報が更新されました。変更内容をご確認ください。"
}

await crud_message.create_announcement(db=db, obj_in=message_data)
```

### 4.5 通知の仕様

#### 4.5.1 既存メッセージ機能との統合

本機能は、既に実装済みの `crud_message.create_announcement()` を呼び出すことで実現します。

**メリット**:
- 既存のメッセージ機能をそのまま活用できる
- 受信箱、未読件数、既読処理などが自動的に動作する
- 通知の閲覧、削除、アーカイブなどの機能が利用可能

#### 4.5.2 トランザクション管理

通知送信は、削除/変更処理と同一トランザクション内で実行します。

**理由**:
- 削除/変更処理が失敗した場合、通知も送信されない（データ整合性の保証）
- 通知送信が失敗した場合、削除/変更処理もロールバックされる

#### 4.5.3 エラーハンドリング

通知送信に失敗した場合、削除/変更処理全体をロールバックします:

```python
try:
    async with db.begin():
        # スタッフ削除処理
        target_staff.is_deleted = True
        # ... その他の削除処理 ...

        # システム通知送信
        await crud_message.create_announcement(db=db, obj_in=message_data)

    # コミット成功
    return {"message": "スタッフを削除しました", ...}

except Exception as e:
    # ロールバックされる
    logger.error(f"スタッフ削除処理に失敗: {e}")
    raise HTTPException(500, detail="スタッフ削除処理に失敗しました")
```

---

## 5. 非機能要件

### 5.1 パフォーマンス要件

| 項目 | 目標値 | 備考 |
|------|--------|------|
| スタッフ削除APIレスポンスタイム | 200ms以内 | トークン無効化、通知送信を含む |
| 事務所情報更新APIレスポンスタイム | 150ms以内 | 通知送信を含む |
| 通知送信処理時間 | 100ms以内 | 受信者500人以下の場合 |

### 5.2 可用性要件

- **稼働率**: 99.9%以上（月間ダウンタイム43分以内）
- **障害復旧時間（RTO）**: 1時間以内
- **データ復旧ポイント（RPO）**: 1時間以内（データベースバックアップ）

### 5.3 スケーラビリティ要件

- **同時実行スタッフ削除**: 10件/秒まで対応
- **同時実行事務所情報変更**: 20件/秒まで対応
- **通知受信者数**: 1事務所あたり最大1,000人まで対応

### 5.4 ユーザビリティ要件

- **操作の明確性**: 全ての操作ボタンにツールチップまたは説明テキストを表示
- **エラーメッセージの可読性**: すべてのエラーメッセージを日本語で表示
- **操作の安全性**: 削除などの重要な操作には必ず確認ダイアログを表示
- **フィードバックの即時性**: 操作完了時に成功/失敗メッセージを即座に表示

### 5.5 監査・コンプライアンス要件

- **操作ログの記録**: すべての削除・変更操作をログに記録
- **ログ保持期間**: 最低3年間（法的要件に準拠）
- **ログの不変性**: 一度記録されたログは変更・削除不可
- **アクセス制御**: ログの閲覧は Owner および システム管理者のみ可能

---

## 6. 実装スケジュール

### 6.1 全体スケジュール

| フェーズ | 期間 | 内容 |
|---------|------|------|
| Phase 1 | 3日間 | バックエンド実装（スタッフ削除） |
| Phase 2 | 2日間 | バックエンド実装（事務所情報変更 + システム通知） |
| Phase 3 | 3日間 | フロントエンド実装 |
| Phase 4 | 2日間 | テスト・バグ修正 |
| Phase 5 | 1日間 | ドキュメント・レビュー |
| **合計** | **11日間** | - |

### 6.2 Phase 1: バックエンド実装（スタッフ削除）

**期間**: 3日間

**タスク**:
1. データベーススキーマ拡張
   - Staff モデルに `is_deleted`, `deleted_at`, `deleted_by` カラム追加
   - マイグレーションファイル作成
   - インデックス追加
   - StaffAuditLog モデル作成

2. CRUD操作の実装
   - `crud/staff.py` に `count_owners_in_office()` メソッド追加
   - `crud/staff.py` に論理削除フィルタリング機能追加
   - `crud/refresh_token.py` に `revoke_all_by_staff()` メソッド追加

3. スタッフ削除エンドポイントの作成
   - `DELETE /api/v1/auth/staffs/{staff_id}` 実装
   - 権限チェック（Owner のみ）
   - バリデーション実装
   - トランザクション処理実装

4. 認証・認可の修正
   - `get_current_user()` に削除済みチェック追加
   - ログイン処理に削除済みチェック追加

### 6.3 Phase 2: バックエンド実装（事務所情報変更 + システム通知）

**期間**: 2日間

**タスク**:
1. 事務所情報変更エンドポイントの作成
   - `PUT /api/v1/offices/{office_id}` 実装
   - 権限チェック（Owner のみ）
   - バリデーション実装（必須項目、形式チェック）

2. システム通知機能の実装
   - スタッフ削除時の自動通知送信
   - 事務所情報変更時の自動通知送信
   - トランザクション内での通知送信
   - エラーハンドリング

3. エラーメッセージの日本語化
   - `messages/ja.py` への追加

### 6.4 Phase 3: フロントエンド実装

**期間**: 3日間

**タスク**:
1. スタッフ削除機能（AdminMenu.tsx）
   - 削除ボタンの追加（表示制御）
   - 削除確認ダイアログの実装
   - 削除処理ハンドラーの実装
   - ローディング状態の実装
   - エラーハンドリング

2. 事務所情報変更機能（AdminMenu.tsx）
   - 事務所情報編集ボタンの追加
   - 事務所情報編集モーダルの実装
   - フォームバリデーション
   - 更新処理ハンドラーの実装
   - ローディング状態の実装
   - エラーハンドリング

3. APIクライアントの追加
   - `lib/auth.ts` に `deleteStaff()` メソッド追加
   - `lib/office.ts` に `updateOffice()` メソッド追加（または新規作成）
   - 型定義の追加

### 6.5 Phase 4: テスト・バグ修正

**期間**: 2日間

**タスク**:
1. バックエンドテスト
   - スタッフ削除エンドポイントの正常系・異常系テスト
   - 事務所情報変更エンドポイントの正常系・異常系テスト
   - システム通知の送信確認テスト
   - セキュリティテスト（削除後のログイン拒否）

2. フロントエンドテスト
   - 削除ボタンの表示制御テスト
   - 確認ダイアログのテスト
   - 事務所情報編集モーダルのテスト
   - エラーハンドリングのテスト

3. 統合テスト
   - エンドツーエンドの操作確認
   - 通知の受信確認

4. バグ修正

### 6.6 Phase 5: ドキュメント・レビュー

**期間**: 1日間

**タスク**:
1. ドキュメント更新
   - APIドキュメントの更新（OpenAPI仕様）
   - README の更新

2. コードレビュー
   - セキュリティレビュー
   - パフォーマンスレビュー
   - コード品質レビュー

---

## 7. 付録

### 7.1 既存実装の参照先

| 項目 | ファイルパス | 説明 |
|------|-------------|------|
| AdminMenu.tsx | `/k_front/components/protected/admin/AdminMenu.tsx` | スタッフ一覧テーブル（行686-722） |
| Auth エンドポイント | `/k_back/app/api/v1/endpoints/auth.py` | ログイン処理、トークン検証 |
| 依存性注入 | `/k_back/app/api/deps.py` | `require_owner`、`get_current_user` |
| Staff モデル | `/k_back/app/models/staff.py` | Staff テーブルのORM定義 |
| RefreshToken モデル | `/k_back/app/models/refresh_token.py` | リフレッシュトークンのORM定義 |
| Message CRUD | `/k_back/app/crud/crud_message.py` | `create_announcement()` メソッド |
| Messages API | `/k_back/app/api/v1/endpoints/messages.py` | 一斉通知エンドポイント |

### 7.2 関連ドキュメント

- スタッフ削除詳細設計: `/md_files_design_note/task/3_office_action/staff_delete.md`
- 事務所操作概要: `/md_files_design_note/task/3_office_action/office_action.md`
- メッセージ機能設計: `/md_files_design_note/task/2_messages/message_design.md`
- エラーメッセージ定義: `/k_back/app/messages/ja.py`

---

## 8. まとめ

本要件定義書では、管理者向けの事務所操作機能を定義しました。

**提供機能**:
1. **スタッフ削除**: Owner がスタッフを安全に削除し、即座にアクセスを無効化
2. **事務所情報変更**: Owner が事務所の基本情報を更新
3. **システム通知（自動）**: 上記操作実行時に自動的に一斉通知を送信し、全スタッフに周知

**セキュリティ対策**:
- Owner のみが操作可能
- 自分自身や最後のOwnerの削除を防止
- 削除されたスタッフの即座のセッション無効化
- すべての操作を監査ログに記録

**ユーザビリティ**:
- 明確な確認ダイアログによる誤操作防止
- 日本語のエラーメッセージ
- ローディング状態の視覚的フィードバック
- 操作完了時の成功メッセージ表示

この機能により、Owner は事務所を安全かつ効率的に管理できるようになります。
