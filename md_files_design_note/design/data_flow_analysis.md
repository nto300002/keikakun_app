# role_change ã¨ employee_action ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼åˆ†æ

## æ¦‚è¦
ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€role_change_serviceã¨employee_action_serviceã«ãŠã‘ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã¨MissingGreenletã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã‚„ã™ã„ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ç®‡æ‰€ã‚’åˆ†æã—ã¾ã™ã€‚

---

## 1. Role Change Request ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### 1.1 ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆãƒ•ãƒ­ãƒ¼ (create_request)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ role_change_service.create_request()                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆè€…ã®æƒ…å ±å–å¾—                                      â”‚
â”‚    requester = await crud_staff.get(db, id=requester_staff_id)  â”‚
â”‚    from_role = requester.role                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. RoleChangeRequestã‚’ä½œæˆ                                       â”‚
â”‚    request = await crud_role_change_request.create(             â”‚
â”‚        db, obj_in, requester_staff_id, office_id, from_role     â”‚
â”‚    )                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯1ã€‘1å›ç›®ã®commit                                  â”‚
â”‚    await db.commit()                                            â”‚
â”‚    â†’ requestã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒexpireã•ã‚Œã‚‹                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯2ã€‘refresh()ã§ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã¯å†ãƒ­ãƒ¼ãƒ‰ã•ã‚Œãªã„   â”‚
â”‚    await db.refresh(request)                                    â”‚
â”‚    â†’ åŸºæœ¬å±æ€§ã®ã¿refreshã€requesterã‚„officeã¯å«ã¾ã‚Œãªã„             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. é€šçŸ¥ä½œæˆãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—                                        â”‚
â”‚    await self._create_request_notification(db, request)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ _create_request_notification(db, request)     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯3ã€‘ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹  â”‚
        â”‚ approvers = await self._get_approvers(...)    â”‚
        â”‚                                              â”‚
        â”‚ for approver_id in approvers:                â”‚
        â”‚     notice_data = NoticeCreate(              â”‚
        â”‚         content=f"{request.requester         â”‚
        â”‚              .full_name}ã•ã‚“ãŒ..."            â”‚
        â”‚              ^^^^^^^^^^^^                    â”‚
        â”‚         ã€MissingGreenletã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç®‡æ‰€ã€‘       â”‚
        â”‚     )                                        â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯4ã€‘2å›ç›®ã®commit                  â”‚
        â”‚ await db.commit()                            â”‚
        â”‚ â†’ è¦ªãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚‰è¿”ã•ã‚Œã‚‹requestãŒå†åº¦expire     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. requestã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™                                       â”‚
â”‚    return request                                               â”‚
â”‚    â†’ 2å›ç›®ã®commitå¾Œã«expireã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€                       â”‚
â”‚      å‘¼ã³å‡ºã—å´ã§request.idãªã©ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨MissingGreenlet      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ‰¿èªãƒ•ãƒ­ãƒ¼ (approve_request)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ role_change_service.approve_request()                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨æ‰¿èªè€…æƒ…å ±ã®å–å¾—                                     â”‚
â”‚    request = await crud_role_change_request.get(db, id)         â”‚
â”‚    reviewer = await crud_staff.get(db, id=reviewer_staff_id)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æ¨©é™ãƒã‚§ãƒƒã‚¯                                                   â”‚
â”‚    validate_approval_permission(reviewer.role, request)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ‰¿èª                                                 â”‚
â”‚    approved_request = await crud_role_change_request.approve(   â”‚
â”‚        db, request_id, reviewer_staff_id, reviewer_notes        â”‚
â”‚    )                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ã‚¹ã‚¿ãƒƒãƒ•ã®roleå¤‰æ›´                                              â”‚
â”‚    requester = await crud_staff.get(db, id=request.requester...) â”‚
â”‚    requester.role = request.requested_role                      â”‚
â”‚    await db.flush()                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. IDã‚’ä¿å­˜ã—ã¦commit                                             â”‚
â”‚    approved_request_id = request_id                             â”‚
â”‚    await db.commit()                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. ã€GOODã€‘selectinloadã§æ˜ç¤ºçš„ã«å†å–å¾—                            â”‚
â”‚    result = await db.execute(                                   â”‚
â”‚        select(RoleChangeRequest)                                â”‚
â”‚        .where(RoleChangeRequest.id == approved_request_id)      â”‚
â”‚        .options(                                                â”‚
â”‚            selectinload(RoleChangeRequest.requester),           â”‚
â”‚            selectinload(RoleChangeRequest.reviewer),            â”‚
â”‚            selectinload(RoleChangeRequest.office)               â”‚
â”‚        )                                                        â”‚
â”‚    )                                                            â”‚
â”‚    approved_request = result.scalar_one()                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. æ‰¿èªé€šçŸ¥ä½œæˆ                                                   â”‚
â”‚    await self._create_approval_notification(db, approved_request)â”‚
â”‚    â†’ ã“ã®ä¸­ã§å†åº¦commitãŒç™ºç”Ÿï¼ˆãƒœãƒˆãƒ«ãƒãƒƒã‚¯ï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. æ‰¿èªæ¸ˆã¿ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¿”ã™                                        â”‚
â”‚    return approved_request                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 ãƒªã‚¯ã‚¨ã‚¹ãƒˆå´ä¸‹ãƒ•ãƒ­ãƒ¼ (reject_request)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ role_change_service.reject_request()                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆå´ä¸‹                                                 â”‚
â”‚    rejected_request = await crud_role_change_request.reject(    â”‚
â”‚        db, request_id, reviewer_staff_id, reviewer_notes        â”‚
â”‚    )                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. IDã‚’ä¿å­˜ã—ã¦commit                                             â”‚
â”‚    rejected_request_id = request_id                             â”‚
â”‚    await db.commit()                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ã€GOODã€‘selectinloadã§æ˜ç¤ºçš„ã«å†å–å¾—                            â”‚
â”‚    result = await db.execute(                                   â”‚
â”‚        select(RoleChangeRequest)                                â”‚
â”‚        .where(RoleChangeRequest.id == rejected_request_id)      â”‚
â”‚        .options(selectinload(...))                              â”‚
â”‚    )                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å´ä¸‹é€šçŸ¥ä½œæˆ                                                   â”‚
â”‚    await self._create_rejection_notification(db, rejected_request)â”‚
â”‚    â†’ ã“ã®ä¸­ã§å†åº¦commitãŒç™ºç”Ÿï¼ˆãƒœãƒˆãƒ«ãƒãƒƒã‚¯ï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Employee Action Request ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### 2.1 ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆãƒ•ãƒ­ãƒ¼ (create_request)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ employee_action_service.create_request()                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. EmployeeActionRequestã‚’ä½œæˆ                                   â”‚
â”‚    request = await crud_employee_action_request.create(         â”‚
â”‚        db, obj_in, requester_staff_id, office_id                â”‚
â”‚    )                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯1ã€‘1å›ç›®ã®commit                                  â”‚
â”‚    await db.commit()                                            â”‚
â”‚    â†’ requestã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒexpireã•ã‚Œã‚‹                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ã€ä¿®æ­£å¾Œã€‘selectinloadã§æ˜ç¤ºçš„ã«å†å–å¾—                           â”‚
â”‚    result = await db.execute(                                   â”‚
â”‚        select(EmployeeActionRequest)                            â”‚
â”‚        .where(EmployeeActionRequest.id == request_id)           â”‚
â”‚        .options(                                                â”‚
â”‚            selectinload(EmployeeActionRequest.requester),       â”‚
â”‚            selectinload(EmployeeActionRequest.office)           â”‚
â”‚        )                                                        â”‚
â”‚    )                                                            â”‚
â”‚    request = result.scalar_one()                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. é€šçŸ¥ä½œæˆãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—                                        â”‚
â”‚    await self._create_request_notification(db, request)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ _create_request_notification(db, request)     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ æ‰¿èªè€…ãƒªã‚¹ãƒˆã‚’å–å¾—                            â”‚
        â”‚ approvers = await self._get_approvers(...)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ å„æ‰¿èªè€…ã«é€šçŸ¥ã‚’ä½œæˆ                          â”‚
        â”‚ for approver_id in approvers:                â”‚
        â”‚     notice_data = NoticeCreate(              â”‚
        â”‚         content=f"{request.requester         â”‚
        â”‚              .full_name}ã•ã‚“ãŒ..."            â”‚
        â”‚     )                                        â”‚
        â”‚     await crud_notice.create(db, notice_data)â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯2ã€‘2å›ç›®ã®commit                  â”‚
        â”‚ await db.commit()                            â”‚
        â”‚ â†’ è¦ªãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚‰è¿”ã•ã‚Œã‚‹requestãŒå†åº¦expire     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. requestã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™                                       â”‚
â”‚    return request                                               â”‚
â”‚    â†’ 2å›ç›®ã®commitå¾Œã«expireã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€                       â”‚
â”‚      å‘¼ã³å‡ºã—å´ã§request.idãªã©ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨MissingGreenlet      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ‰¿èªãƒ•ãƒ­ãƒ¼ (approve_request)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ employee_action_service.approve_request()                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆå–å¾—                                                 â”‚
â”‚    request = await crud_employee_action_request.get(db, id)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å®Ÿéš›ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œï¼ˆtry-catchï¼‰                              â”‚
â”‚    try:                                                         â”‚
â”‚        execution_result = await self._execute_action(db, request)â”‚
â”‚        approved_request = await crud.approve(...)               â”‚
â”‚    except Exception as e:                                       â”‚
â”‚        execution_result = {"success": False, "error": str(e)}   â”‚
â”‚        approved_request = await crud.approve(...)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. IDã‚’ä¿å­˜ã—ã¦commit                                             â”‚
â”‚    approved_request_id = request_id                             â”‚
â”‚    await db.commit()                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ã€GOODã€‘selectinloadã§æ˜ç¤ºçš„ã«å†å–å¾—                            â”‚
â”‚    result = await db.execute(                                   â”‚
â”‚        select(EmployeeActionRequest)                            â”‚
â”‚        .where(EmployeeActionRequest.id == approved_request_id)  â”‚
â”‚        .options(selectinload(...))                              â”‚
â”‚    )                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. æ‰¿èªé€šçŸ¥ä½œæˆ                                                   â”‚
â”‚    await self._create_approval_notification(db, approved_request)â”‚
â”‚    â†’ ã“ã®ä¸­ã§å†åº¦commitãŒç™ºç”Ÿï¼ˆãƒœãƒˆãƒ«ãƒãƒƒã‚¯ï¼‰                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ (_execute_action)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ _execute_action(db, request)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—ã§åˆ†å²                                               â”‚
â”‚ - welfare_recipient â†’ _execute_welfare_recipient_action()       â”‚
â”‚ - support_plan_cycle â†’ _execute_support_plan_cycle_action()    â”‚
â”‚ - support_plan_status â†’ _execute_support_plan_status_action()  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ _execute_welfare_recipient_action()           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ã§åˆ†å²                         â”‚
        â”‚ - create: æ–°è¦ä½œæˆ + äº‹æ¥­æ‰€ã¨ã®é–¢é€£ä»˜ã‘        â”‚
        â”‚ - update: æ›´æ–°                               â”‚
        â”‚ - delete: å‰Šé™¤                               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ db.flush()ã§å¤‰æ›´ã‚’åæ˜ ï¼ˆcommitã¯ã—ãªã„ï¼‰        â”‚
        â”‚ å®Ÿè¡Œçµæœã‚’è¿”ã™                                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ç®‡æ‰€ã®ã¾ã¨ã‚

### 3.1 å…±é€šãƒœãƒˆãƒ«ãƒãƒƒã‚¯

| ç®‡æ‰€ | å•é¡Œ | å½±éŸ¿ | å„ªå…ˆåº¦ |
|------|------|------|--------|
| **é€šçŸ¥ä½œæˆãƒ¡ã‚½ãƒƒãƒ‰å†…ã®commit** | `_create_request_notification`, `_create_approval_notification`, `_create_rejection_notification`ãŒç‹¬è‡ªã«commitã—ã¦ã„ã‚‹ | è¦ªãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚‰è¿”ã•ã‚Œã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒäºˆæœŸã›ãšexpireã•ã‚Œã‚‹ | ğŸ”´ é«˜ |
| **è¤‡æ•°å›ã®commit** | 1ã¤ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§è¤‡æ•°å›commitãŒç™ºç”Ÿ | ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•ŒãŒä¸æ˜ç¢ºã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒè¤‡æ•°å›expire | ğŸ”´ é«˜ |
| **refresh()ã®èª¤ç”¨** | `refresh()`ã§ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ãŒå†ãƒ­ãƒ¼ãƒ‰ã•ã‚Œãªã„å‰æã‚’ç„¡è¦– | ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«MissingGreenlet | ğŸŸ¡ ä¸­ |

### 3.2 role_change_service å›ºæœ‰ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯

| ãƒ¡ã‚½ãƒƒãƒ‰ | ç®‡æ‰€ | å•é¡Œ |
|----------|------|------|
| `create_request` | line 76-81 | refresh()å¾Œã«ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ãŒæœªãƒ­ãƒ¼ãƒ‰ã®ã¾ã¾é€šçŸ¥ä½œæˆãƒ¡ã‚½ãƒƒãƒ‰ã«æ¸¡ã•ã‚Œã‚‹ |
| `create_request` | line 84 | é€šçŸ¥ä½œæˆãƒ¡ã‚½ãƒƒãƒ‰å†…ã§2å›ç›®ã®commitãŒç™ºç”Ÿ |
| `_create_request_notification` | line 288 | `request.requester.full_name`ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«MissingGreenletï¼ˆä¿®æ­£å‰ï¼‰ |
| `_create_request_notification` | line 293 | ã‚µãƒ–ãƒ¡ã‚½ãƒƒãƒ‰ãŒcommitã™ã‚‹ã®ã¯ä¸é©åˆ‡ |
| `approve_request` | line 172 | æ‰¿èªé€šçŸ¥ä½œæˆãƒ¡ã‚½ãƒƒãƒ‰å†…ã§å†åº¦commitãŒç™ºç”Ÿ |
| `reject_request` | line 231 | å´ä¸‹é€šçŸ¥ä½œæˆãƒ¡ã‚½ãƒƒãƒ‰å†…ã§å†åº¦commitãŒç™ºç”Ÿ |

### 3.3 employee_action_service å›ºæœ‰ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯

| ãƒ¡ã‚½ãƒƒãƒ‰ | ç®‡æ‰€ | å•é¡Œ |
|----------|------|------|
| `create_request` | line 66-70 | 1å›ç›®ã®commitå¾Œã€refresh()ã§ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ãŒæœªãƒ­ãƒ¼ãƒ‰ |
| `create_request` | line 73 | é€šçŸ¥ä½œæˆãƒ¡ã‚½ãƒƒãƒ‰å†…ã§2å›ç›®ã®commitãŒç™ºç”Ÿ |
| `_create_request_notification` | line 405 | `request.requester.full_name`ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«MissingGreenletï¼ˆä¿®æ­£å‰ï¼‰ |
| `_create_request_notification` | line 410 | ã‚µãƒ–ãƒ¡ã‚½ãƒƒãƒ‰ãŒcommitã™ã‚‹ã®ã¯ä¸é©åˆ‡ |
| `approve_request` | line 168 | æ‰¿èªé€šçŸ¥ä½œæˆãƒ¡ã‚½ãƒƒãƒ‰å†…ã§å†åº¦commitãŒç™ºç”Ÿ |
| `reject_request` | line 224 | å´ä¸‹é€šçŸ¥ä½œæˆãƒ¡ã‚½ãƒƒãƒ‰å†…ã§å†åº¦commitãŒç™ºç”Ÿ |

---

## 4. ä¿®æ­£ã®æ–¹å‘æ€§

### 4.1 çŸ­æœŸçš„ãªä¿®æ­£ï¼ˆç·Šæ€¥å¯¾å¿œï¼‰

1. **é€šçŸ¥ä½œæˆãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚‰commitã‚’å‰Šé™¤**
   - `_create_request_notification`
   - `_create_approval_notification`
   - `_create_rejection_notification`

   ã“ã‚Œã‚‰ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯commitã›ãšã€è¦ªãƒ¡ã‚½ãƒƒãƒ‰ã§æœ€å¾Œã«1å›ã ã‘commitã™ã‚‹ã€‚

2. **create_requestãƒ¡ã‚½ãƒƒãƒ‰ã®ä¿®æ­£**
   - commitå¾Œã«`selectinload`ã§ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚’æ˜ç¤ºçš„ã«å†å–å¾—
   - é€šçŸ¥ä½œæˆãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—å‰ã«ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚’ç¢ºå®Ÿã«ãƒ­ãƒ¼ãƒ‰

### 4.2 ä¸­æœŸçš„ãªä¿®æ­£ï¼ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ”¹å–„ï¼‰

1. **ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã®æ˜ç¢ºåŒ–**
   - ã‚µãƒ¼ãƒ“ã‚¹å±¤ã§1ã¤ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ = 1ã¤ã®commit
   - é€šçŸ¥ä½œæˆã¯ã‚µãƒ¼ãƒ“ã‚¹ãƒ¡ã‚½ãƒƒãƒ‰å†…ã§å®Œçµã•ã›ã‚‹

2. **expire_on_commit=Falseã®æ¤œè¨**
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³è¨­å®šã§expire_on_commit=Falseã‚’è¨­å®š
   - ãŸã ã—ã€ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã«æ³¨æ„ãŒå¿…è¦

### 4.3 é•·æœŸçš„ãªä¿®æ­£ï¼ˆè¨­è¨ˆã®è¦‹ç›´ã—ï¼‰

1. **é€šçŸ¥ä½œæˆã®éåŒæœŸåŒ–**
   - é€šçŸ¥ä½œæˆã‚’åˆ¥ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å®Ÿè¡Œï¼ˆCeleryãªã©ã®ã‚¿ã‚¹ã‚¯ã‚­ãƒ¥ãƒ¼ï¼‰
   - ãƒ¡ã‚¤ãƒ³ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¨åˆ†é›¢ã™ã‚‹ã“ã¨ã§ã€è¤‡é›‘ã•ã‚’è»½æ¸›

2. **ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã®Eager Loadingè¨­å®š**
   - ãƒ¢ãƒ‡ãƒ«å®šç¾©ã§`lazy='selectin'`ã‚’è¨­å®š
   - ã¾ãŸã¯`lazy='raise'`ã§é–‹ç™ºæ™‚ã«N+1å•é¡Œã‚’æ—©æœŸç™ºè¦‹

3. **Unit of Workãƒ‘ã‚¿ãƒ¼ãƒ³ã®å°å…¥**
   - ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ã‚’ä¸€å…ƒåŒ–
   - commitã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æ˜ç¢ºã«ã™ã‚‹

---

## 5. ä¿®æ­£å„ªå…ˆåº¦

| å„ªå…ˆåº¦ | ã‚¿ã‚¹ã‚¯ | æœŸå¾…åŠ¹æœ |
|--------|--------|----------|
| ğŸ”´ P0 | é€šçŸ¥ä½œæˆãƒ¡ã‚½ãƒƒãƒ‰ã‹ã‚‰commitã‚’å‰Šé™¤ | MissingGreenletã‚¨ãƒ©ãƒ¼ã®å³åº§ã®è§£æ±º |
| ğŸ”´ P0 | create_requestã§selectinloadã«ã‚ˆã‚‹å†å–å¾— | ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ã‚¢ã‚¯ã‚»ã‚¹ã®å®‰å…¨æ€§ç¢ºä¿ |
| ğŸŸ¡ P1 | ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã®æ˜ç¢ºåŒ– | ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ãƒ»ä¿å®ˆæ€§å‘ä¸Š |
| ğŸŸ¢ P2 | expire_on_commit=Falseã®æ¤œè¨ | ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ |
| ğŸŸ¢ P3 | é€šçŸ¥ä½œæˆã®éåŒæœŸåŒ– | ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ”¹å–„ |

---

## 6. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 6.1 ä¿®æ­£å¾Œã«å®Ÿè¡Œã™ã¹ããƒ†ã‚¹ãƒˆ

```bash
# role_change_service ã®ãƒ†ã‚¹ãƒˆ
pytest tests/services/test_role_change_service.py -v

# employee_action_service ã®ãƒ†ã‚¹ãƒˆ
pytest tests/services/test_employee_action_service.py -v

# ç‰¹ã«MissingGreenleté–¢é€£ã®ãƒ†ã‚¹ãƒˆ
pytest tests/services/test_role_change_service.py::test_no_missing_greenlet_after_approve -v
pytest tests/services/test_role_change_service.py::test_no_missing_greenlet_after_reject -v
pytest tests/services/test_employee_action_service.py::test_no_missing_greenlet_after_approve_action -v
pytest tests/services/test_employee_action_service.py::test_no_missing_greenlet_after_reject_action -v
```

### 6.2 ç¢ºèªã™ã¹ããƒã‚¤ãƒ³ãƒˆ

- [ ] commitå¾Œã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å±æ€§ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„
- [ ] ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ï¼ˆrequester, approver, officeï¼‰ã«å®‰å…¨ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹
- [ ] ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒæ­£ã—ãrollbackã•ã‚Œã‚‹ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ï¼‰
- [ ] é€šçŸ¥ãŒæ­£ã—ãä½œæˆã•ã‚Œã‚‹
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ•´åˆæ€§ãŒä¿ãŸã‚Œã‚‹

---

## 7. å‚è€ƒè³‡æ–™

- [SQLAlchemy Async I/O Documentation](https://docs.sqlalchemy.org/en/20/orm/extensions/asyncio.html)
- [SQLAlchemy Session Basics](https://docs.sqlalchemy.org/en/20/orm/session_basics.html)
- [Understanding Session.expire_on_commit](https://docs.sqlalchemy.org/en/20/orm/session_api.html#sqlalchemy.orm.Session.params.expire_on_commit)
- [@rule.md - SQLAlchemy éåŒæœŸORM ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã¨ã‚¢ãƒ³ãƒãƒ‘ã‚¿ãƒ¼ãƒ³](./rule.md)
