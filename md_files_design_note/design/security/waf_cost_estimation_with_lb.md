# けいかくん - WAF実装コスト試算（Cloud Load Balancer経由）

**作成日**: 2026-02-03
**為替レート**: 1 USD = ¥150
**前提条件**: Cloud Load Balancer + Cloud Armor + Cloud Run構成

---

## 📋 目次

1. [アーキテクチャ概要](#アーキテクチャ概要)
2. [コスト内訳](#コスト内訳)
3. [トラフィック量別試算](#トラフィック量別試算)
4. [既存構成との比較](#既存構成との比較)
5. [コスト最適化の提案](#コスト最適化の提案)
6. [ROI分析](#roi分析)

---

## アーキテクチャ概要

### 推奨構成

```
                        インターネット
                             ↓
┌────────────────────────────────────────────────────┐
│  Cloud Load Balancer (外部HTTPS LB)                │
│  - グローバルロードバランシング                      │
│  - SSL/TLS終端                                      │
│  - フォワーディングルール                            │
│  ├─ URL Map                                         │
│  └─ バックエンドサービス                            │
└────────────────────────────────────────────────────┘
                             ↓
┌────────────────────────────────────────────────────┐
│  Google Cloud Armor (WAF)                          │
│  - OWASP Top 10対策                                │
│  - レート制限                                       │
│  - 地理的制限                                       │
│  - IPホワイトリスト/ブラックリスト                   │
└────────────────────────────────────────────────────┘
                             ↓
┌────────────────────────────────────────────────────┐
│  Serverless NEG (Network Endpoint Group)           │
│  - Cloud Runへのルーティング                        │
└────────────────────────────────────────────────────┘
                             ↓
┌────────────────────────────────────────────────────┐
│  Google Cloud Run (asia-northeast1)                │
│  - FastAPI (k-back)                                │
│  - 既存のアプリケーション                            │
└────────────────────────────────────────────────────┘
```

### 現在の構成（比較用）

```
インターネット
    ↓
Cloud Run (直接アクセス)
    - 自動提供のHTTPSロードバランサー
    - 基本的なDDoS保護のみ
```

---

## コスト内訳

### 1. Cloud Load Balancer（外部HTTPS LB）

#### 1.1 フォワーディングルール料金

| 項目 | 単価 | 数量 | 月額費用 |
|------|------|------|---------|
| **フォワーディングルール** | $0.025/時間 | 730時間/月 | $18.25 ≈ **¥2,737** |

**計算**:
- フォワーディングルール: 1個（HTTPSリスナー）
- 1ヶ月 = 730時間（30.4日 × 24時間）
- $0.025 × 730 = $18.25 ≈ ¥2,737

#### 1.2 データ処理料金（Ingress/Egress）

| 項目 | 単価 | 月間転送量 | 月額費用 |
|------|------|-----------|---------|
| **データ処理（最初の10TB）** | $0.008/GB | 100GB | $0.80 ≈ **¥120** |
| **データ処理（10TB超）** | $0.004/GB | 0GB | $0 |

**計算例（月間100万リクエストの場合）**:
- 1リクエストあたりの平均サイズ: 100KB（リクエスト50KB + レスポンス50KB）
- 100万リクエスト × 100KB = 100GB
- 100GB × $0.008 = $0.80 ≈ ¥120

**注**: Cloud Run → LB間の内部トラフィックは無料

---

### 2. Cloud Armor（WAF）

#### 2.1 ポリシーとルール料金

| 項目 | 単価 | 数量 | 月額費用 |
|------|------|------|---------|
| **セキュリティポリシー** | $5/ポリシー/月 | 1個 | $5 ≈ **¥750** |
| **ルール** | $1/ルール/月 | 10個 | $10 ≈ **¥1,500** |

**ルール内訳**:
1. SQLインジェクション対策
2. XSS対策
3. LFI対策
4. RCE対策
5. RFI対策
6. ログインレート制限
7. パスワードリセットレート制限
8. Webhookレート制限
9. 地理的制限
10. IPホワイトリスト（Stripe）

#### 2.2 リクエスト処理料金

| トラフィック量 | 単価 | 月額費用 |
|--------------|------|---------|
| **100万リクエスト** | $0.75/100万req | $0.75 ≈ **¥112** |
| **500万リクエスト** | $0.75/100万req | $3.75 ≈ **¥562** |
| **1,000万リクエスト** | $0.75/100万req | $7.50 ≈ **¥1,125** |

---

### 3. Cloud Logging（ログ保存）

| 項目 | 単価 | 月間ログ量 | 月額費用 |
|------|------|-----------|---------|
| **ログ取り込み** | $0.50/GB | 5GB | $2.50 ≈ **¥375** |
| **ログ保存（30日）** | $0.01/GB/月 | 5GB × 30日 | 含まれる |

**ログ量の想定**:
- Cloud Armorログ: 1リクエスト = 約5KB
- 100万リクエスト/月 × 5KB = 5GB

---

### 4. SSL/TLS証明書

| 項目 | 費用 |
|------|------|
| **Google管理SSL証明書** | **¥0（無料）** |

**注**: Cloud Load BalancerでGoogle管理のSSL証明書を使用する場合、追加費用なし

---

### 5. Cloud Run（既存）

| 項目 | 費用 |
|------|------|
| **Cloud Run** | **変更なし** |

**注**:
- Cloud Run自体の費用は既存のまま
- LB経由でも課金体系は同じ（CPU/メモリ/リクエスト数）

---

## トラフィック量別試算

### シナリオ1: 小規模（月間100万リクエスト）

#### 内訳

| コスト項目 | 月額費用（円） |
|-----------|--------------|
| Cloud Load Balancer（フォワーディングルール） | ¥2,737 |
| Cloud Load Balancer（データ処理 100GB） | ¥120 |
| Cloud Armor（ポリシー） | ¥750 |
| Cloud Armor（ルール 10個） | ¥1,500 |
| Cloud Armor（リクエスト処理 100万） | ¥112 |
| Cloud Logging（5GB） | ¥375 |
| **小計** | **¥5,594** |

#### 既存構成との差額

| 項目 | 既存構成 | 新構成 | 差額 |
|------|---------|--------|------|
| 月額費用 | ¥0（Cloud Run直接） | ¥5,594 | **+¥5,594** |

---

### シナリオ2: 中規模（月間500万リクエスト）

#### 内訳

| コスト項目 | 月額費用（円） |
|-----------|--------------|
| Cloud Load Balancer（フォワーディングルール） | ¥2,737 |
| Cloud Load Balancer（データ処理 500GB） | ¥600 |
| Cloud Armor（ポリシー） | ¥750 |
| Cloud Armor（ルール 10個） | ¥1,500 |
| Cloud Armor（リクエスト処理 500万） | ¥562 |
| Cloud Logging（25GB） | ¥1,875 |
| **小計** | **¥8,024** |

#### 既存構成との差額

| 項目 | 既存構成 | 新構成 | 差額 |
|------|---------|--------|------|
| 月額費用 | ¥0 | ¥8,024 | **+¥8,024** |

---

### シナリオ3: 大規模（月間1,000万リクエスト）

#### 内訳

| コスト項目 | 月額費用（円） |
|-----------|--------------|
| Cloud Load Balancer（フォワーディングルール） | ¥2,737 |
| Cloud Load Balancer（データ処理 1TB） | ¥1,200 |
| Cloud Armor（ポリシー） | ¥750 |
| Cloud Armor（ルール 10個） | ¥1,500 |
| Cloud Armor（リクエスト処理 1,000万） | ¥1,125 |
| Cloud Logging（50GB） | ¥3,750 |
| **小計** | **¥11,062** |

#### 既存構成との差額

| 項目 | 既存構成 | 新構成 | 差額 |
|------|---------|--------|------|
| 月額費用 | ¥0 | ¥11,062 | **+¥11,062** |

---

## 既存構成との比較

### コスト比較（月額）

| トラフィック量 | 既存構成<br>（Cloud Run直接） | 新構成<br>（LB + Cloud Armor） | 追加コスト | 年間追加コスト |
|--------------|---------------------------|---------------------------|----------|-------------|
| **100万リクエスト** | ¥0 | ¥5,594 | +¥5,594 | +¥67,128 |
| **500万リクエスト** | ¥0 | ¥8,024 | +¥8,024 | +¥96,288 |
| **1,000万リクエスト** | ¥0 | ¥11,062 | +¥11,062 | +¥132,744 |

**注**: Cloud Run本体のコスト（CPU/メモリ/リクエスト処理）は両構成で同じため除外

---

### 機能比較

| 機能 | 既存構成 | 新構成（LB + Cloud Armor） |
|------|---------|-------------------------|
| **HTTPS/TLS** | ✅ 自動提供 | ✅ 自動提供 |
| **基本的なDDoS保護** | ✅ 自動提供（基本レベル） | ✅ 強化レベル |
| **OWASP Top 10対策** | ❌ なし | ✅ あり |
| **レート制限（ネットワーク層）** | ❌ なし | ✅ あり |
| **地理的制限** | ❌ なし | ✅ あり |
| **IPホワイトリスト/ブラックリスト** | ❌ なし | ✅ あり |
| **カスタムWAFルール** | ❌ なし | ✅ あり |
| **リアルタイム攻撃ブロック** | ❌ なし | ✅ あり |
| **詳細なセキュリティログ** | ⚠️ 限定的 | ✅ 完全 |
| **グローバルロードバランシング** | ⚠️ Cloud Run内蔵 | ✅ 専用LB |

---

## コスト最適化の提案

### 最適化1: ログ保持期間の調整

**現状**: 30日間保持
**提案**: 7日間保持（重要なログのみ30日）

**コスト削減**:
```
変更前: ¥375/月（5GB × 30日）
変更後: ¥87/月（5GB × 7日）
削減額: ¥288/月 → 年間¥3,456削減
```

**設定**:
```bash
# ログの保持期間を7日に設定
gcloud logging sinks create waf-logs-7days \
    storage.googleapis.com/BUCKET_NAME \
    --log-filter='resource.type="http_load_balancer"' \
    --retention-days=7
```

---

### 最適化2: ルール数の削減

**現状**: 10ルール
**提案**: 必須ルールのみ（6ルール）

**削減するルール**:
- 業務時間外アクセス制限（運用で対応可能）
- User-Agent制限（誤検知リスクが高い）
- 特定パスへのPOST制限（アプリケーション層で対応）
- 地理的制限（将来の国際展開を考慮）

**コスト削減**:
```
変更前: ¥1,500/月（10ルール）
変更後: ¥900/月（6ルール）
削減額: ¥600/月 → 年間¥7,200削減
```

---

### 最適化3: トラフィック圧縮

**提案**: Cloud CDN併用（圧縮によるデータ転送量削減）

**効果**:
```
圧縮前: 100GB/月
圧縮後: 60GB/月（40%削減）

データ処理料金削減:
変更前: ¥120/月
変更後: ¥72/月
削減額: ¥48/月 → 年間¥576削減
```

**追加コスト**:
- Cloud CDN: $0.02/GB（キャッシュヒット率50%の場合）
- 月額約¥150（実質削減効果は小）

**判断**: 費用対効果が低いため、当面は見送り

---

### 最適化後のコスト

| トラフィック量 | 最適化前 | 最適化後 | 削減額 |
|--------------|---------|---------|--------|
| **100万リクエスト** | ¥5,594 | ¥4,706 | **-¥888** |
| **500万リクエスト** | ¥8,024 | ¥6,248 | **-¥1,776** |
| **1,000万リクエスト** | ¥11,062 | ¥8,398 | **-¥2,664** |

**年間削減額**: ¥10,656〜¥31,968

---

## ROI分析

### セキュリティインシデントの想定被害額

| インシデント種別 | 想定被害額 | 発生確率（年間） | 期待損失 |
|----------------|-----------|----------------|---------|
| **DDoS攻撃** | ¥500,000〜¥2,000,000 | 20% | ¥100,000〜¥400,000 |
| **データ漏洩** | ¥1,000,000〜¥10,000,000 | 5% | ¥50,000〜¥500,000 |
| **不正アクセス** | ¥500,000〜¥3,000,000 | 10% | ¥50,000〜¥300,000 |
| **サービス停止** | ¥200,000〜¥1,000,000 | 15% | ¥30,000〜¥150,000 |
| **合計期待損失** | - | - | **¥230,000〜¥1,350,000** |

**参考データ**:
- IPAセキュリティ白書2024
- 情報漏洩インシデント平均被害額: 約500万円（JNSA調査）

---

### 投資対効果（ROI）計算

#### シナリオ1: 小規模（100万リクエスト/月）

**年間投資額**: ¥67,128（最適化前）または ¥56,472（最適化後）

**期待損失削減**: ¥230,000〜¥1,350,000

**ROI計算**:
```
ROI = (削減される損失 - 投資額) / 投資額 × 100%

最小ケース: (¥230,000 - ¥67,128) / ¥67,128 × 100% = 242%
最大ケース: (¥1,350,000 - ¥67,128) / ¥67,128 × 100% = 1,911%
```

**結論**: 1年以内に投資回収可能（ROI 242%〜1,911%）

---

#### シナリオ2: 中規模（500万リクエスト/月）

**年間投資額**: ¥96,288（最適化前）または ¥74,976（最適化後）

**ROI計算**:
```
最小ケース: (¥230,000 - ¥96,288) / ¥96,288 × 100% = 139%
最大ケース: (¥1,350,000 - ¥96,288) / ¥96,288 × 100% = 1,302%
```

**結論**: 1年以内に投資回収可能（ROI 139%〜1,302%）

---

#### シナリオ3: 大規模（1,000万リクエスト/月）

**年間投資額**: ¥132,744（最適化前）または ¥100,776（最適化後）

**ROI計算**:
```
最小ケース: (¥230,000 - ¥132,744) / ¥132,744 × 100% = 73%
最大ケース: (¥1,350,000 - ¥132,744) / ¥132,744 × 100% = 917%
```

**結論**: 1年以内に投資回収可能（ROI 73%〜917%）

---

### ROI要約

| トラフィック量 | 年間投資額（最適化後） | 最小ROI | 最大ROI | 回収期間 |
|--------------|-------------------|---------|---------|---------|
| **100万リクエスト** | ¥56,472 | 307% | 2,291% | **2.5ヶ月** |
| **500万リクエスト** | ¥74,976 | 207% | 1,701% | **3.9ヶ月** |
| **1,000万リクエスト** | ¥100,776 | 128% | 1,239% | **5.2ヶ月** |

**結論**: どのシナリオでも**6ヶ月以内に投資回収可能**

---

## 段階的導入プラン（コスト抑制版）

### Phase 0: 最小構成（月額¥3,219）

**目的**: WAFの効果を最小コストで検証

**構成**:
- Cloud Load Balancer: ¥2,737
- Cloud Armor（ポリシー1個）: ¥750
- Cloud Armor（ルール3個: SQLi/XSS/RCE）: ¥450（¥150×3）
- ログ（3日保持）: ¥52

**検証期間**: 1ヶ月

---

### Phase 1: 基本構成（月額¥4,706）

**目的**: 主要な攻撃への対策

**構成**:
- Phase 0 + レート制限ルール（3個）
- ログ保持7日間

**実装期間**: 1週間

---

### Phase 2: 完全構成（月額¥5,594〜¥11,062）

**目的**: エンタープライズレベルのセキュリティ

**構成**:
- すべてのルール（10個）
- ログ保持30日間
- アラート・モニタリング

**実装期間**: 2週間

---

## コスト削減の代替案

### 代替案1: アプリケーション層のみで対応（コスト¥0）

**メリット**:
- 追加コストなし
- 既存の実装を活用

**デメリット**:
- DDoS攻撃への対応が弱い
- ネットワーク層での防御なし
- アプリケーションサーバーへの負荷増

**推奨度**: ⭐⭐☆☆☆（非推奨）

---

### 代替案2: Cloudflare WAF（月額¥20,000〜）

**メリット**:
- 高度なボット対策
- グローバルCDN統合
- DDoS対策が強力

**デメリット**:
- コストが高い（約4倍）
- DNS設定変更が必要
- Vercel（フロントエンド）との統合確認が必要

**推奨度**: ⭐⭐⭐☆☆（予算に余裕がある場合）

---

### 代替案3: AWS WAF（月額¥8,000〜¥15,000）

**メリット**:
- 高度なカスタマイズ可能
- マネージドルール豊富

**デメリット**:
- GCPとの統合が複雑
- クロスクラウド構成の管理コスト
- レイテンシ増加の懸念

**推奨度**: ⭐⭐☆☆☆（非推奨）

---

## 最終推奨事項

### 推奨構成

**Cloud Load Balancer + Cloud Armor（最適化版）**

**月額コスト**: ¥4,706〜¥8,398（トラフィック量による）

**理由**:
1. ✅ Cloud Runとのシームレス統合
2. ✅ コストパフォーマンスが最高（ROI 128%〜2,291%）
3. ✅ 6ヶ月以内に投資回収可能
4. ✅ エンタープライズレベルのセキュリティ
5. ✅ 段階的導入が可能

---

## 詳細見積もり（月間100万リクエスト、最適化版）

| コスト項目 | 詳細 | 月額費用 |
|-----------|------|---------|
| **Cloud Load Balancer** | | |
| └ フォワーディングルール | $0.025/時間 × 730時間 | ¥2,737 |
| └ データ処理 | $0.008/GB × 100GB | ¥120 |
| **Cloud Armor** | | |
| └ ポリシー | $5/ポリシー | ¥750 |
| └ ルール（6個） | $1/ルール × 6 | ¥900 |
| └ リクエスト処理 | $0.75/100万req | ¥112 |
| **Cloud Logging** | | |
| └ ログ取り込み（7日保持） | $0.50/GB × 5GB × 0.23 | ¥87 |
| **合計** | | **¥4,706** |
| **年間合計** | | **¥56,472** |

---

## まとめ

### コスト要約（最適化版）

| トラフィック量 | 月額費用 | 年間費用 | ROI | 回収期間 |
|--------------|---------|---------|-----|---------|
| **100万リクエスト** | ¥4,706 | ¥56,472 | 307%〜2,291% | 2.5ヶ月 |
| **500万リクエスト** | ¥6,248 | ¥74,976 | 207%〜1,701% | 3.9ヶ月 |
| **1,000万リクエスト** | ¥8,398 | ¥100,776 | 128%〜1,239% | 5.2ヶ月 |

### 推奨アクション

1. ✅ **Phase 0**: 最小構成で1ヶ月検証（月額¥3,219）
2. ✅ **Phase 1**: 効果確認後、基本構成に移行（月額¥4,706）
3. ✅ **Phase 2**: 必要に応じて完全構成に拡張

### 次のステップ

1. 経営層の承認取得
2. Phase 0実装（最小構成）
3. 1ヶ月後に効果測定
4. Phase 1へ移行判断

---

**見積もりバージョン**: 1.0
**次回見積もり更新**: 3ヶ月後（実測値を基に）
**作成者**: Claude Sonnet 4.5
