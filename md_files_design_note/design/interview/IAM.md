# IAM設計 - 最小権限の原則

**作成日**: 2026-02-09
**対象システム**: けいかくん（個別支援計画管理システム）

---

## 📋 最小権限設計の方針

けいかくんでは、**最小権限の原則（Principle of Least Privilege）** に基づいてIAMポリシーを設計しています。

### 基本方針

1. **必要最小限の権限のみ付与**
   - 業務要件を満たす最小限の権限に制限
   - 不要な権限は一切付与しない

2. **リソース単位での制限**
   - ワイルドカード（`*`）の使用を最小化
   - 特定のバケット・リソースのみに限定

3. **環境分離**
   - dev/prod環境ごとに明示的にリソースを指定
   - 環境間のアクセスを防止

4. **定期的な見直し**
   - 権限の使用状況を監視
   - 不要になった権限は即座に削除

---

## 🗄️ S3 バケットポリシー

### ポリシー定義

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowBucketListing",
            "Effect": "Allow",
            "Action": "s3:ListBucket",
            "Resource": [
                "arn:aws:s3:::keikakun-plan-deliverables-dev",
                "arn:aws:s3:::keikakun-plan-deliverables-prod",
                "arn:aws:s3:::keikakun-plan-deliverables"
            ]
        },
        {
            "Sid": "AllowObjectAccess",
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:DeleteObject"
            ],
            "Resource": [
                "arn:aws:s3:::keikakun-plan-deliverables-dev/*",
                "arn:aws:s3:::keikakun-plan-deliverables-prod/*",
                "arn:aws:s3:::keikakun-plan-deliverables/*"
            ]
        }
    ]
}
```

---

### なぜこの設計なのか

#### 1. バケットリスティング権限（`s3:ListBucket`）

**付与している権限**:
- `s3:ListBucket` - バケット内のオブジェクト一覧取得

**業務要件**:
- 個別支援計画の成果物（PDF等）の一覧取得
- ファイル存在確認
- ページネーション処理

**なぜこの権限のみか**:
- ❌ `s3:*` は付与しない → バケット削除等の破壊的操作を防止
- ❌ `s3:GetBucketPolicy` は不要 → バケットポリシー閲覧は不要
- ❌ `s3:PutBucketPolicy` は不要 → ポリシー変更はインフラチームのみ
- ✅ `s3:ListBucket` のみ → 一覧取得のみに制限

**リソース制限の理由**:
```json
"Resource": [
    "arn:aws:s3:::keikakun-plan-deliverables-dev",
    "arn:aws:s3:::keikakun-plan-deliverables-prod",
    "arn:aws:s3:::keikakun-plan-deliverables"
]
```

- ✅ 特定のバケットのみ指定 → 他のS3バケットへのアクセスを完全にブロック
- ✅ 環境ごとに明示的に列挙 → dev環境からprod環境への誤アクセスを防止
- ❌ `arn:aws:s3:::*` は使用しない → AWSアカウント内の全S3バケットへのアクセスを防止

**セキュリティ上のメリット**:
- 他のプロジェクトのS3バケットへのアクセスを完全にブロック
- 誤って重要なバケットを削除するリスクを排除
- 環境間の誤操作を防止

---

#### 2. オブジェクトアクセス権限（`s3:GetObject`, `s3:PutObject`, `s3:DeleteObject`）

**付与している権限**:
- `s3:GetObject` - オブジェクトの読み取り
- `s3:PutObject` - オブジェクトのアップロード
- `s3:DeleteObject` - オブジェクトの削除

**業務要件**:
- **GetObject**: 個別支援計画PDFのダウンロード
- **PutObject**: 個別支援計画PDFのアップロード
- **DeleteObject**: 古い成果物の削除（データ保持ポリシー準拠）

**なぜこの3つの権限のみか**:
- ❌ `s3:*` は付与しない → バケット削除等を防止
- ❌ `s3:GetObjectVersion` は不要 → バージョニングは使用していない
- ❌ `s3:PutBucketVersioning` は不要 → バケット設定変更は不要
- ❌ `s3:PutObjectAcl` は不要 → ACL変更はセキュリティリスク
- ✅ CRUDの基本3操作のみ → ファイル操作のみに制限

**リソース制限の理由**:
```json
"Resource": [
    "arn:aws:s3:::keikakun-plan-deliverables-dev/*",
    "arn:aws:s3:::keikakun-plan-deliverables-prod/*",
    "arn:aws:s3:::keikakun-plan-deliverables/*"
]
```

- ✅ バケット内のオブジェクトのみ（`/*`） → バケット自体の削除は不可
- ✅ 特定バケットのオブジェクトのみ → 他のバケットのオブジェクトへのアクセスを完全にブロック

**セキュリティ上のメリット**:
- バケット自体の削除を防止（`arn:aws:s3:::bucket-name`ではなく`arn:aws:s3:::bucket-name/*`）
- オブジェクトのACL変更を防止 → 公開設定の誤変更を防止
- 他のバケットへのアクセスを完全にブロック

---

### S3ポリシーのセキュリティ分析

#### ✅ 防止できる攻撃・誤操作

1. **バケット削除の防止**
   - バケットリソース（`arn:aws:s3:::bucket-name`）への`DeleteBucket`権限なし
   - 誤操作や悪意のある削除を防止

2. **他のS3バケットへのアクセス防止**
   - ワイルドカード（`*`）を使用せず、特定バケットのみ指定
   - 他のプロジェクトのデータへのアクセスを完全にブロック

3. **オブジェクトACL変更の防止**
   - `s3:PutObjectAcl` 権限なし
   - ファイルを誤って公開設定にするリスクを排除

4. **バケットポリシー変更の防止**
   - `s3:PutBucketPolicy` 権限なし
   - セキュリティ設定の不正変更を防止

#### 🔒 多層防御（Defense in Depth）

1. **IAMポリシー** - アプリケーションの権限制限
2. **バケットポリシー** - S3側でのアクセス制御
3. **VPCエンドポイント** - ネットワークレベルでのアクセス制限
4. **暗号化** - データ保護（S3サーバー側暗号化）

---

## 📧 SES（Simple Email Service）ポリシー

### ポリシー定義

```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": "ses:SendRawEmail",
            "Resource": "*"
        }
    ]
}
```

---

### なぜこの設計なのか

#### 1. SendRawEmail権限のみ付与

**付与している権限**:
- `ses:SendRawEmail` - RAW形式でのメール送信

**業務要件**:
- 個別支援計画の期限通知メール送信
- スタッフへのアラートメール送信
- マルチパート（HTML + テキスト）メール送信

**なぜこの権限のみか**:
- ❌ `ses:*` は付与しない → 送信ドメイン削除等の破壊的操作を防止
- ❌ `ses:SendEmail` は不要 → `SendRawEmail` でカバー可能
- ❌ `ses:UpdateConfigurationSet` は不要 → 設定変更はインフラチームのみ
- ❌ `ses:DeleteIdentity` は不要 → 送信ドメイン削除は不要
- ❌ `ses:VerifyEmailIdentity` は不要 → メールアドレス認証はインフラチームのみ
- ✅ `ses:SendRawEmail` のみ → メール送信機能のみに制限

**SendRawEmail vs SendEmail**:
- `SendEmail`: シンプルなメール送信（HTML or テキストのみ）
- `SendRawEmail`: MIME形式でのメール送信（マルチパート、添付ファイル対応）
- けいかくんでは、HTML + テキストのマルチパートメールを送信するため `SendRawEmail` を選択

---

#### 2. なぜResource: "*"なのか

**リソース指定**:
```json
"Resource": "*"
```

**理由**:
1. **SES APIの仕様**
   - `ses:SendRawEmail` はリソースARNを受け付けない
   - AWSの仕様上、`Resource: "*"` が必須

2. **アプリケーションレベルでの制御**
   - 送信元メールアドレスはアプリケーション内で検証
   - 送信先メールアドレスは事業所のスタッフのみに制限
   - レート制限（Semaphore(5)）で大量送信を防止

3. **SES側での多層防御**
   - 送信ドメイン認証（SPF, DKIM, DMARC）
   - 送信レート制限（SES側で設定）
   - バウンス・苦情率の監視

**セキュリティ上の懸念と対策**:

| 懸念 | 対策 |
|------|------|
| スパムメール送信 | - 送信先を事業所スタッフのみに制限<br>- dry_runモードで事前検証<br>- 監査ログで全送信を記録 |
| メールアドレスの検証不足 | - スタッフのメールアドレスをDB登録時に検証<br>- `Staff.email IS NOT NULL` で検証済み |
| 大量送信 | - Semaphore(5)で同時送信数制限<br>- バッチ処理でのみ実行（手動トリガーなし） |
| 送信元詐称 | - SESで送信ドメイン認証（DKIM）<br>- アプリケーションで送信元を固定 |

---

#### 3. 付与していない権限とその理由

**設定変更系**:
- ❌ `ses:UpdateConfigurationSet` - SES設定変更（インフラチームのみ）
- ❌ `ses:PutConfigurationSetDeliveryOptions` - 配信オプション変更（不要）

**認証系**:
- ❌ `ses:VerifyEmailIdentity` - メールアドレス認証（インフラチームのみ）
- ❌ `ses:VerifyDomainIdentity` - ドメイン認証（インフラチームのみ）

**削除系**:
- ❌ `ses:DeleteIdentity` - 送信ドメイン削除（破壊的操作）
- ❌ `ses:DeleteConfigurationSet` - 設定削除（破壊的操作）

**情報取得系**:
- ❌ `ses:GetSendQuota` - 送信上限取得（監視用、アプリには不要）
- ❌ `ses:GetSendStatistics` - 送信統計取得（監視用、アプリには不要）

**理由**: アプリケーションにはメール送信機能のみが必要で、設定変更や統計取得は不要

---

### SESポリシーのセキュリティ分析

#### ✅ 防止できる攻撃・誤操作

1. **送信ドメイン削除の防止**
   - `ses:DeleteIdentity` 権限なし
   - 誤操作や悪意のあるドメイン削除を防止

2. **SES設定変更の防止**
   - `ses:UpdateConfigurationSet` 権限なし
   - セキュリティ設定の不正変更を防止

3. **認証設定の変更防止**
   - `ses:VerifyEmailIdentity` 権限なし
   - 不正な送信元アドレスの追加を防止

#### 🔒 多層防御（Defense in Depth）

1. **IAMポリシー** - 送信機能のみに制限
2. **アプリケーション制御** - 送信先をスタッフのみに制限
3. **SES側の制御**
   - 送信ドメイン認証（DKIM, SPF, DMARC）
   - 送信レート制限
   - バウンス・苦情率の監視
4. **監査ログ** - 全メール送信を記録
5. **dry_runモード** - 本番送信前のテスト機能

---

## 📅 サービスアカウント（Google Calendar）

### 権限スコープ

**付与している権限**:
- 予定の変更（イベントの作成・更新・削除）
- 共有の管理（カレンダーACLの管理）

---

### なぜこの設計なのか

#### 1. 必要な権限のみ付与

**付与しているスコープ**:
- `https://www.googleapis.com/auth/calendar.events` - イベントの読み書き
- `https://www.googleapis.com/auth/calendar.acls` - ACL管理

**業務要件**:
- 個別支援計画の更新期限をGoogleカレンダーに登録
- カレンダーへのアクセス権限管理（事業所スタッフのみに共有）

**なぜこの権限のみか**:
- ❌ `https://www.googleapis.com/auth/calendar` - カレンダー全体への完全アクセス（不要）
- ❌ `https://www.googleapis.com/auth/calendar.settings.readonly` - カレンダー設定の読み取り（不要）
- ✅ イベント操作とACL管理のみ → カレンダー削除等を防止

---

#### 2. サービスアカウントを使用する理由

**サービスアカウント vs OAuthユーザー認証**:

| 方式 | メリット | デメリット | けいかくんでの採用 |
|------|---------|-----------|-----------------|
| サービスアカウント | - トークン更新不要<br>- 特定のカレンダーのみにアクセス<br>- ユーザー非依存 | - 初期設定が複雑 | ✅ 採用 |
| OAuthユーザー認証 | - 設定が簡単 | - トークン更新が必要<br>- ユーザーの全カレンダーにアクセス可能 | ❌ 不採用 |

**採用理由**:
1. **最小権限の原則**
   - サービスアカウントは特定のカレンダーのみにアクセス
   - OAuthではユーザーの全カレンダーにアクセス可能（過剰な権限）

2. **トークン管理の安全性**
   - サービスアカウントのキーファイルは環境変数で管理
   - OAuthのリフレッシュトークンは有効期限があり、定期的な再認証が必要

3. **運用の安定性**
   - 特定ユーザーに依存しない（退職時の影響なし）
   - トークン失効のリスクがない

---

#### 3. アクセス制御

**カレンダーACL管理**:
```python
# 事業所スタッフにのみカレンダーを共有
calendar_acl = {
    "role": "reader",  # 読み取り専用
    "scope": {
        "type": "user",
        "value": staff.email
    }
}
```

**なぜ"reader"権限のみか**:
- ✅ `reader` - カレンダーの閲覧のみ
- ❌ `writer` - イベントの変更可能（不要）
- ❌ `owner` - カレンダーの削除可能（危険）

**理由**: スタッフには閲覧権限のみで十分。イベント変更はけいかくんアプリから実施。

---

### Google Calendarポリシーのセキュリティ分析

#### ✅ 防止できる攻撃・誤操作

1. **カレンダー削除の防止**
   - カレンダー全体への完全アクセス権限なし
   - イベント操作のみに制限

2. **他のカレンダーへのアクセス防止**
   - サービスアカウントは特定のカレンダーのみに共有
   - ユーザーの個人カレンダーへのアクセス不可

3. **不正なイベント作成の防止**
   - アプリケーション側で個別支援計画に紐づくイベントのみ作成
   - 監査ログで全イベント操作を記録

#### 🔒 多層防御（Defense in Depth）

1. **サービスアカウント** - 最小権限のスコープ
2. **カレンダーACL** - スタッフに読み取り専用権限
3. **アプリケーション制御** - イベント作成は個別支援計画に紐づくもののみ
4. **監査ログ** - 全カレンダー操作を記録

---

## 📊 権限設計の比較表

### 現在の設計 vs 過剰な権限設計

| サービス | 現在の設計（最小権限） | 過剰な権限設計（悪い例） | リスク削減効果 |
|---------|---------------------|---------------------|-------------|
| **S3** | `s3:ListBucket`, `s3:GetObject`, `s3:PutObject`, `s3:DeleteObject` on 特定バケット | `s3:*` on `*` | ✅ バケット削除防止<br>✅ 他のS3バケットへのアクセス防止<br>✅ ACL変更防止 |
| **SES** | `ses:SendRawEmail` on `*` | `ses:*` on `*` | ✅ 送信ドメイン削除防止<br>✅ SES設定変更防止<br>✅ 不正な認証設定追加防止 |
| **Google Calendar** | イベント操作 + ACL管理のみ | カレンダー全体への完全アクセス | ✅ カレンダー削除防止<br>✅ 他のカレンダーへのアクセス防止 |

---

## 🔍 権限の定期的な見直し

### 監視項目

1. **使用されていない権限の検出**
   - AWS IAM Access Analyzer
   - 過去90日間で未使用の権限を検出

2. **異常なアクセスパターンの検出**
   - CloudWatch Logs
   - 大量のS3アクセス、SES送信失敗の監視

3. **権限昇格の検出**
   - IAMポリシー変更の監視
   - 不正な権限追加を検出

### 見直しスケジュール

| タイミング | 実施内容 |
|-----------|---------|
| **月次** | IAM Access Analyzer レポート確認 |
| **四半期** | 未使用権限の削除 |
| **年次** | 全IAMポリシーの見直し |
| **機能追加時** | 必要な権限のみ追加（最小権限の原則） |

---

## 🎯 まとめ

### けいかくんの最小権限設計の原則

1. **必要最小限の権限のみ付与**
   - 業務要件を満たす最小限の権限に制限
   - 不要な権限は一切付与しない

2. **リソース単位での制限**
   - ワイルドカード（`*`）の使用を最小化
   - 特定のバケット・リソースのみに限定

3. **環境分離**
   - dev/prod環境ごとに明示的にリソースを指定
   - 環境間の誤アクセスを防止

4. **多層防御**
   - IAMポリシー
   - アプリケーション制御
   - サービス側の制御（S3バケットポリシー、SES設定等）
   - 監査ログ

5. **定期的な見直し**
   - 月次でIAM Access Analyzerレポート確認
   - 未使用権限の削除

---

### セキュリティ上のメリット

| メリット | 具体例 |
|---------|--------|
| **攻撃面の縮小** | 不正アクセス時の影響範囲を最小化 |
| **誤操作の防止** | バケット削除、ドメイン削除等の破壊的操作を防止 |
| **コンプライアンス** | 個人情報保護法、ISO27001等の要件を満たす |
| **監査容易性** | 権限が明確で、監査ログの分析が容易 |

---

**作成日**: 2026-02-09
**作成者**: Claude Sonnet 4.5
**最終更新**: 2026-02-09
