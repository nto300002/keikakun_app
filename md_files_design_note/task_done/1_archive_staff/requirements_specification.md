# ã‚¹ã‚¿ãƒƒãƒ•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ©Ÿèƒ½ è¦ä»¶å®šç¾©æ›¸

## ğŸ“‹ ç›®æ¬¡
1. [èƒŒæ™¯ãƒ»ç›®çš„](#èƒŒæ™¯ç›®çš„)
2. [æ³•çš„è¦ä»¶](#æ³•çš„è¦ä»¶)
3. [ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«è¨­è¨ˆ](#ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«è¨­è¨ˆ)
4. [ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç†ãƒ•ãƒ­ãƒ¼](#ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç†ãƒ•ãƒ­ãƒ¼)
5. [å®Ÿè£…è©³ç´°](#å®Ÿè£…è©³ç´°)
6. [ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé–“](#ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé–“)
7. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …)
8. [ãƒ†ã‚¹ãƒˆè¦ä»¶](#ãƒ†ã‚¹ãƒˆè¦ä»¶)

---

## èƒŒæ™¯ãƒ»ç›®çš„

### ç¾çŠ¶ã®èª²é¡Œ

ç¾åœ¨ã®å®Ÿè£…ã§ã¯ã€ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤æ™‚ã«ä»¥ä¸‹ã®å‡¦ç†ãŒè¡Œã‚ã‚Œã‚‹ï¼š
1. è«–ç†å‰Šé™¤ï¼ˆis_deleted=true, deleted_atè¨­å®šï¼‰
2. 30æ—¥çµŒéå¾Œã«ç‰©ç†å‰Šé™¤ï¼ˆcleanup_serviceï¼‰

**å•é¡Œç‚¹**ï¼š
- ç‰©ç†å‰Šé™¤ã«ã‚ˆã‚Šã€æ³•å®šä¿å­˜ç¾©å‹™ã®ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚Œã‚‹
- åŠ´åƒåŸºæº–æ³•ã€éšœå®³è€…ç·åˆæ”¯æ´æ³•ã®è¦ä»¶ã‚’æº€ãŸã›ãªã„
- ç›£æŸ»ã‚„æ³•çš„ç´›äº‰æ™‚ã«å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ãŒå¤±ã‚ã‚Œã‚‹

### ç›®çš„

æ³•ä»¤éµå®ˆã®ãŸã‚ã€ä»¥ä¸‹ã‚’å®Ÿç¾ã™ã‚‹ï¼š
1. **å€‹äººè­˜åˆ¥æƒ…å ±ã®å³æ™‚åŒ¿ååŒ–**ï¼ˆGDPRãƒ»å€‹äººæƒ…å ±ä¿è­·æ³•å¯¾å¿œï¼‰
2. **æ³•å®šä¿å­˜ç¾©å‹™ãƒ‡ãƒ¼ã‚¿ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–**ï¼ˆåŠ´åƒåŸºæº–æ³•ãƒ»éšœå®³è€…ç·åˆæ”¯æ´æ³•å¯¾å¿œï¼‰
3. **äºŒæ®µéšå‰Šé™¤ãƒ—ãƒ­ã‚»ã‚¹ã®å®Ÿè£…**ï¼ˆåŒ¿ååŒ– â†’ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– â†’ æœŸé™å¾Œå‰Šé™¤ï¼‰

---

## æ³•çš„è¦ä»¶

### 1. åŠ´åƒåŸºæº–æ³•ï¼ˆç¬¬109æ¡ï¼‰

**ä¿å­˜ç¾©å‹™**ï¼š
- **åŠ´åƒè€…åç°¿**ï¼šé€€è·ãƒ»è§£é›‡ã‹ã‚‰**5å¹´é–“**ï¼ˆçµŒéæªç½®ã§3å¹´ã‚‚å¯ï¼‰
- **è³ƒé‡‘å°å¸³**ï¼šæœ€å¾Œã®è¨˜å…¥ã‹ã‚‰**5å¹´é–“**ï¼ˆçµŒéæªç½®ã§3å¹´ã‚‚å¯ï¼‰

**å¯¾è±¡ãƒ‡ãƒ¼ã‚¿**ï¼š
- æ°åï¼ˆå§“ãƒ»åã€ãƒ•ãƒªã‚¬ãƒŠï¼‰
- é›‡å…¥ã‚Œæ—¥ï¼ˆcreated_atï¼‰
- é€€è·æ—¥ï¼ˆdeleted_atï¼‰
- å½¹è·ãƒ»è·ç¨®ï¼ˆroleï¼‰
- æ‰€å±äº‹å‹™æ‰€æƒ…å ±

**å‚è€ƒ**ï¼š
- [åšç”ŸåŠ´åƒçœï¼šè³ƒé‡‘å°å¸³ç­‰ã®ä¿ç®¡æœŸé–“](https://www.startup-roudou.mhlw.go.jp/qa/zigyonushi/syuugyoukisoku/q6.html)
- [åŠ´åƒåŸºæº–æ³• ç¬¬109æ¡](https://laws.e-gov.go.jp/document?lawid=322AC0000000049)

### 2. éšœå®³è€…ç·åˆæ”¯æ´æ³•

**ä¿å­˜ç¾©å‹™**ï¼š
- **ã‚µãƒ¼ãƒ“ã‚¹æä¾›è¨˜éŒ²**ï¼šæä¾›æ—¥ã‹ã‚‰**5å¹´é–“**
- **å€‹åˆ¥æ”¯æ´è¨ˆç”»**ï¼šä½œæˆæ—¥ã‹ã‚‰**5å¹´é–“**

**å¯¾è±¡ãƒ‡ãƒ¼ã‚¿**ï¼š
- ã‚µãƒ¼ãƒ“ã‚¹æä¾›è€…ï¼ˆã‚¹ã‚¿ãƒƒãƒ•ï¼‰ã®æƒ…å ±
- æ‹…å½“åˆ©ç”¨è€…ã®è¨˜éŒ²ã¨ã®ç´ä»˜ã‘

**å‚è€ƒ**ï¼š
- [éšœå®³ç¦ç¥‰äº‹æ¥­ã®æ›¸é¡ã®ä¿ç®¡æœŸé–“](https://fukusi.kabudata-dll.com/hokankikan/)

### 3. å€‹äººæƒ…å ±ä¿è­·æ³•ï¼ˆç¬¬22æ¡ï¼‰

**å‰Šé™¤ç¾©å‹™**ï¼š
- åˆ©ç”¨ç›®çš„é”æˆå¾Œã¯ã€Œé…æ»ãªãæ¶ˆå»ã™ã‚‹ã‚ˆã†åŠªã‚ã‚‹ã€ï¼ˆ**åŠªåŠ›ç¾©å‹™**ï¼‰
- æœ¬äººã‹ã‚‰ã®å‰Šé™¤è¦æ±‚ã«ã¯åŸå‰‡å¯¾å¿œãŒå¿…è¦

**å¯¾å¿œæ–¹é‡**ï¼š
- å€‹äººè­˜åˆ¥æƒ…å ±ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç­‰ï¼‰ã¯å³åº§ã«åŒ¿ååŒ–
- æ³•å®šä¿å­˜ç¾©å‹™ã®ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä¿æŒ

**å‚è€ƒ**ï¼š
- [å€‹äººæƒ…å ±ä¿è­·å§”å“¡ä¼šï¼šå–å¾—ã—ãŸå€‹äººæƒ…å ±ã¯ã€ã„ã¤å»ƒæ£„ã—ãªã‘ã‚Œã°ãªã‚Šã¾ã›ã‚“ã‹](https://www.ppc.go.jp/all_faq_index/faq1-q5-2/)

---

## ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«è¨­è¨ˆ

### archived_staffs ãƒ†ãƒ¼ãƒ–ãƒ«

æ³•å®šä¿å­˜ç¾©å‹™ã®ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’åŒ¿ååŒ–ã—ãŸå½¢ã§ä¿å­˜ã™ã‚‹ã€‚

#### ã‚¹ã‚­ãƒ¼ãƒ

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | åˆ¶ç´„ | èª¬æ˜ |
|---------|---------|------|------|
| id | UUID | PRIMARY KEY | ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ID |
| original_staff_id | UUID | NOT NULL, INDEX | å…ƒã®ã‚¹ã‚¿ãƒƒãƒ•IDï¼ˆå‚ç…§æ•´åˆæ€§ãªã—ï¼‰ |
| anonymized_full_name | VARCHAR(255) | NOT NULL | åŒ¿ååŒ–ã•ã‚ŒãŸæ°åï¼ˆä¾‹: "ã‚¹ã‚¿ãƒƒãƒ•-ABC123"ï¼‰ |
| anonymized_email | VARCHAR(255) | NOT NULL | åŒ¿ååŒ–ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ï¼ˆä¾‹: "archived-ABC123@deleted.local"ï¼‰ |
| role | VARCHAR(20) | NOT NULL | å½¹è·ï¼ˆowner/manager/employeeï¼‰ |
| office_id | UUID | NULLABLE, INDEX | æ‰€å±ã—ã¦ã„ãŸäº‹å‹™æ‰€ID |
| office_name | VARCHAR(255) | NULLABLE | äº‹å‹™æ‰€åï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰ |
| hired_at | TIMESTAMP | NOT NULL | é›‡å…¥ã‚Œæ—¥ï¼ˆcreated_atï¼‰ |
| terminated_at | TIMESTAMP | NOT NULL | é€€è·æ—¥ï¼ˆdeleted_atï¼‰ |
| archived_at | TIMESTAMP | NOT NULL | ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆæ—¥æ™‚ |
| archive_reason | VARCHAR(50) | NOT NULL | ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ç†ç”±ï¼ˆstaff_deletion/office_withdrawalï¼‰ |
| legal_retention_until | TIMESTAMP | NOT NULL | æ³•å®šä¿å­˜æœŸé™ï¼ˆterminated_at + 5å¹´ï¼‰ |
| metadata | JSONB | NULLABLE | ãã®ä»–ã®æ³•å®šä¿å­˜ãŒå¿…è¦ãªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ |
| is_test_data | BOOLEAN | NOT NULL, INDEX | ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ©ã‚° |
| created_at | TIMESTAMP | NOT NULL | ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆæ—¥æ™‚ |

#### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

```sql
CREATE INDEX idx_archived_staffs_original_id ON archived_staffs(original_staff_id);
CREATE INDEX idx_archived_staffs_office_id ON archived_staffs(office_id);
CREATE INDEX idx_archived_staffs_retention_until ON archived_staffs(legal_retention_until);
CREATE INDEX idx_archived_staffs_is_test_data ON archived_staffs(is_test_data);
CREATE INDEX idx_archived_staffs_archived_at ON archived_staffs(archived_at);
```

#### å¤–éƒ¨ã‚­ãƒ¼

**é‡è¦**ï¼š`original_staff_id`ã¨`office_id`ã«ã¯å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’**è¨­å®šã—ãªã„**

ç†ç”±ï¼š
- å…ƒã®staffsãƒ¬ã‚³ãƒ¼ãƒ‰ã¯ç‰©ç†å‰Šé™¤ã•ã‚Œã‚‹
- officesã‚‚é€€ä¼šæ™‚ã«å‰Šé™¤ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã¯ç‹¬ç«‹ã—ãŸãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿æŒ

---

## ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç†ãƒ•ãƒ­ãƒ¼

### å…¨ä½“ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤è¦æ±‚   â”‚
â”‚  (DELETE /staffs/ID) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³        â”‚
â”‚   - æ¨©é™ãƒã‚§ãƒƒã‚¯         â”‚
â”‚   - æœ€å¾Œã®Ownerãƒã‚§ãƒƒã‚¯  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ        â”‚
â”‚   - æ³•å®šä¿å­˜ãƒ‡ãƒ¼ã‚¿æŠ½å‡º   â”‚
â”‚   - å€‹äººæƒ…å ±åŒ¿ååŒ–       â”‚
â”‚   - archived_staffsã«ä¿å­˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è«–ç†å‰Šé™¤              â”‚
â”‚   - is_deleted = true    â”‚
â”‚   - deleted_at = now()   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²          â”‚
â”‚   - staff.deleted        â”‚
â”‚   - archive_created      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. é€šçŸ¥é€ä¿¡              â”‚
â”‚   - äº‹å‹™æ‰€å†…ã‚¹ã‚¿ãƒƒãƒ•ã¸   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 30æ—¥å¾Œ: ç‰©ç†å‰Šé™¤         â”‚
â”‚   - cleanup_service      â”‚
â”‚   - staffsãƒ¬ã‚³ãƒ¼ãƒ‰å‰Šé™¤   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5å¹´å¾Œ: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‰Šé™¤    â”‚
â”‚   - cleanup_service      â”‚
â”‚   - archived_staffså‰Šé™¤  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒˆãƒªã‚¬ãƒ¼ã¨ãªã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

#### 1. ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤ï¼ˆOwneræ¨©é™ï¼‰

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**ï¼š
```
DELETE /api/v1/staffs/{staff_id}
```

**å‡¦ç†å†…å®¹**ï¼š
```python
# app/api/v1/endpoints/staffs.py:delete_staff
async def delete_staff(
    staff_id: UUID,
    current_user: Staff = Depends(deps.require_owner)
):
    # 1. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    # 2. ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ â† NEW
    await crud.archived_staff.create_from_staff(
        db=db,
        staff=target_staff,
        reason="staff_deletion",
        deleted_by=current_user.id
    )

    # 3. è«–ç†å‰Šé™¤
    await crud.staff.soft_delete(db, staff_id=staff_id, deleted_by=current_user.id)

    # 4. ç›£æŸ»ãƒ­ã‚°ãƒ»é€šçŸ¥
```

#### 2. ã‚¹ã‚¿ãƒƒãƒ•é€€ä¼šï¼ˆWithdrawalæ‰¿èªæ™‚ï¼‰

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**ï¼š
```
POST /api/v1/withdrawal-requests/{request_id}/approve
```

**å‡¦ç†å†…å®¹**ï¼š
```python
# app/services/withdrawal_service.py:_execute_staff_withdrawal
async def _execute_staff_withdrawal(
    request: ApprovalRequest,
    executor_id: UUID
):
    # 1. ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ â† NEW
    await crud.archived_staff.create_from_staff(
        db=db,
        staff=target_staff,
        reason="staff_withdrawal",
        deleted_by=executor_id
    )

    # 2. è«–ç†å‰Šé™¤
    await crud_staff.soft_delete(db, staff_id=target_staff_id, deleted_by=executor_id)

    # 3. ç›£æŸ»ãƒ­ã‚°
```

#### 3. äº‹å‹™æ‰€é€€ä¼šï¼ˆå…¨ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤ï¼‰

**ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**ï¼š
```
POST /api/v1/withdrawal-requests/{request_id}/approve
```

**å‡¦ç†å†…å®¹**ï¼š
```python
# app/services/withdrawal_service.py:_execute_office_withdrawal
async def _execute_office_withdrawal(
    request: ApprovalRequest,
    executor_id: UUID
):
    # æ‰€å±ã‚¹ã‚¿ãƒƒãƒ•å…¨å“¡ã‚’å–å¾—
    office_staffs = await crud_staff.get_by_office_id(db, office_id=office_id)

    for staff in office_staffs:
        # 1. ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ â† NEW
        await crud.archived_staff.create_from_staff(
            db=db,
            staff=staff,
            reason="office_withdrawal",
            deleted_by=executor_id
        )

        # 2. è«–ç†å‰Šé™¤
        await crud_staff.soft_delete(db, staff_id=staff.id, deleted_by=executor_id)

    # 3. äº‹å‹™æ‰€å‰Šé™¤
    await crud_office.soft_delete(db, office_id=office_id)
```

---

## å®Ÿè£…è©³ç´°

### 1. SQLAlchemy ãƒ¢ãƒ‡ãƒ«

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/models/archived_staff.py`

```python
import uuid
from datetime import datetime, timedelta, timezone
from typing import Optional
from sqlalchemy import String, DateTime, UUID, Boolean, func, Index
from sqlalchemy.dialects.postgresql import JSONB
from sqlalchemy.orm import Mapped, mapped_column

from app.db.base import Base


class ArchivedStaff(Base):
    """
    æ³•å®šä¿å­˜ç¾©å‹™ã«åŸºã¥ãã‚¹ã‚¿ãƒƒãƒ•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–

    åŠ´åƒåŸºæº–æ³•ã€éšœå®³è€…ç·åˆæ”¯æ´æ³•ã®è¦ä»¶ã‚’æº€ãŸã™ãŸã‚ã€
    é€€è·ãƒ»å‰Šé™¤ã•ã‚ŒãŸã‚¹ã‚¿ãƒƒãƒ•ã®æ³•å®šä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’5å¹´é–“ä¿æŒã™ã‚‹ã€‚

    å€‹äººè­˜åˆ¥æƒ…å ±ã¯åŒ¿ååŒ–ã•ã‚Œã€æ³•å®šä¿å­˜ãŒå¿…è¦ãªæƒ…å ±ã®ã¿ã‚’å«ã‚€ã€‚
    """
    __tablename__ = 'archived_staffs'

    id: Mapped[uuid.UUID] = mapped_column(
        UUID(as_uuid=True),
        primary_key=True,
        server_default=func.gen_random_uuid()
    )
    original_staff_id: Mapped[uuid.UUID] = mapped_column(
        UUID(as_uuid=True),
        nullable=False,
        index=True,
        comment="å…ƒã®ã‚¹ã‚¿ãƒƒãƒ•IDï¼ˆå‚ç…§æ•´åˆæ€§ãªã—ï¼‰"
    )
    anonymized_full_name: Mapped[str] = mapped_column(
        String(255),
        nullable=False,
        comment="åŒ¿ååŒ–ã•ã‚ŒãŸæ°åï¼ˆä¾‹: ã‚¹ã‚¿ãƒƒãƒ•-ABC123ï¼‰"
    )
    anonymized_email: Mapped[str] = mapped_column(
        String(255),
        nullable=False,
        comment="åŒ¿ååŒ–ã•ã‚ŒãŸãƒ¡ãƒ¼ãƒ«ï¼ˆä¾‹: archived-ABC123@deleted.localï¼‰"
    )
    role: Mapped[str] = mapped_column(
        String(20),
        nullable=False,
        comment="å½¹è·ï¼ˆowner/manager/employeeï¼‰"
    )
    office_id: Mapped[Optional[uuid.UUID]] = mapped_column(
        UUID(as_uuid=True),
        nullable=True,
        index=True,
        comment="æ‰€å±ã—ã¦ã„ãŸäº‹å‹™æ‰€IDï¼ˆå‚ç…§æ•´åˆæ€§ãªã—ï¼‰"
    )
    office_name: Mapped[Optional[str]] = mapped_column(
        String(255),
        nullable=True,
        comment="äº‹å‹™æ‰€åï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰"
    )
    hired_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        nullable=False,
        comment="é›‡å…¥ã‚Œæ—¥ï¼ˆå…ƒã®created_atï¼‰"
    )
    terminated_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        nullable=False,
        index=True,
        comment="é€€è·æ—¥ï¼ˆdeleted_atï¼‰"
    )
    archived_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        nullable=False,
        server_default=func.now(),
        index=True,
        comment="ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆæ—¥æ™‚"
    )
    archive_reason: Mapped[str] = mapped_column(
        String(50),
        nullable=False,
        comment="ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ç†ç”±ï¼ˆstaff_deletion/staff_withdrawal/office_withdrawalï¼‰"
    )
    legal_retention_until: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        nullable=False,
        index=True,
        comment="æ³•å®šä¿å­˜æœŸé™ï¼ˆterminated_at + 5å¹´ï¼‰"
    )
    metadata: Mapped[Optional[dict]] = mapped_column(
        JSONB,
        nullable=True,
        comment="ãã®ä»–ã®æ³•å®šä¿å­˜ãŒå¿…è¦ãªãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿"
    )
    is_test_data: Mapped[bool] = mapped_column(
        Boolean,
        default=False,
        nullable=False,
        index=True,
        comment="ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ©ã‚°"
    )
    created_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True),
        nullable=False,
        server_default=func.now()
    )

    __table_args__ = (
        Index('idx_archived_staffs_retention_until', 'legal_retention_until'),
        Index('idx_archived_staffs_office_id', 'office_id'),
    )

    @classmethod
    def calculate_retention_until(cls, terminated_at: datetime, years: int = 5) -> datetime:
        """
        æ³•å®šä¿å­˜æœŸé™ã‚’è¨ˆç®—ï¼ˆé€€è·æ—¥ + 5å¹´ï¼‰

        Args:
            terminated_at: é€€è·æ—¥
            years: ä¿å­˜å¹´æ•°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5å¹´ï¼‰

        Returns:
            ä¿å­˜æœŸé™æ—¥æ™‚
        """
        return terminated_at + timedelta(days=365 * years)

    def is_retention_expired(self) -> bool:
        """
        æ³•å®šä¿å­˜æœŸé™ãŒéãã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯

        Returns:
            æœŸé™åˆ‡ã‚Œã®å ´åˆTrue
        """
        return datetime.now(timezone.utc) >= self.legal_retention_until
```

### 2. Alembic ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

**ãƒ•ã‚¡ã‚¤ãƒ«å**: `migrations/versions/xxxx_create_archived_staffs_table.py`

```python
"""create archived_staffs table

Revision ID: xxxx
Revises: yyyy
Create Date: 2025-12-01 12:00:00.000000

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers
revision = 'xxxx'
down_revision = 'yyyy'
branch_labels = None
depends_on = None


def upgrade() -> None:
    """ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ"""

    op.create_table(
        'archived_staffs',
        sa.Column('id', postgresql.UUID(as_uuid=True), server_default=sa.text('gen_random_uuid()'), nullable=False),
        sa.Column('original_staff_id', postgresql.UUID(as_uuid=True), nullable=False),
        sa.Column('anonymized_full_name', sa.String(length=255), nullable=False),
        sa.Column('anonymized_email', sa.String(length=255), nullable=False),
        sa.Column('role', sa.String(length=20), nullable=False),
        sa.Column('office_id', postgresql.UUID(as_uuid=True), nullable=True),
        sa.Column('office_name', sa.String(length=255), nullable=True),
        sa.Column('hired_at', sa.DateTime(timezone=True), nullable=False),
        sa.Column('terminated_at', sa.DateTime(timezone=True), nullable=False),
        sa.Column('archived_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
        sa.Column('archive_reason', sa.String(length=50), nullable=False),
        sa.Column('legal_retention_until', sa.DateTime(timezone=True), nullable=False),
        sa.Column('metadata', postgresql.JSONB(astext_type=sa.Text()), nullable=True),
        sa.Column('is_test_data', sa.Boolean(), server_default='false', nullable=False),
        sa.Column('created_at', sa.DateTime(timezone=True), server_default=sa.text('now()'), nullable=False),
        sa.PrimaryKeyConstraint('id')
    )

    # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
    op.create_index('idx_archived_staffs_original_id', 'archived_staffs', ['original_staff_id'])
    op.create_index('idx_archived_staffs_office_id', 'archived_staffs', ['office_id'])
    op.create_index('idx_archived_staffs_retention_until', 'archived_staffs', ['legal_retention_until'])
    op.create_index('idx_archived_staffs_is_test_data', 'archived_staffs', ['is_test_data'])
    op.create_index('idx_archived_staffs_archived_at', 'archived_staffs', ['archived_at'])

    # ãƒ†ãƒ¼ãƒ–ãƒ«ã‚³ãƒ¡ãƒ³ãƒˆ
    op.execute("""
        COMMENT ON TABLE archived_staffs IS
        'æ³•å®šä¿å­˜ç¾©å‹™ã«åŸºã¥ãã‚¹ã‚¿ãƒƒãƒ•ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼ˆåŠ´åƒåŸºæº–æ³•ãƒ»éšœå®³è€…ç·åˆæ”¯æ´æ³•å¯¾å¿œï¼‰'
    """)


def downgrade() -> None:
    """ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯"""

    op.drop_index('idx_archived_staffs_archived_at', table_name='archived_staffs')
    op.drop_index('idx_archived_staffs_is_test_data', table_name='archived_staffs')
    op.drop_index('idx_archived_staffs_retention_until', table_name='archived_staffs')
    op.drop_index('idx_archived_staffs_office_id', table_name='archived_staffs')
    op.drop_index('idx_archived_staffs_original_id', table_name='archived_staffs')
    op.drop_table('archived_staffs')
```

### 3. CRUDæ“ä½œ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/crud/crud_archived_staff.py`

```python
import uuid
import hashlib
from datetime import datetime, timezone
from typing import Optional, List
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select, and_

from app.models.archived_staff import ArchivedStaff
from app.models.staff import Staff
from app.models.office import Office


class CRUDArchivedStaff:
    """ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚¹ã‚¿ãƒƒãƒ•ã®CRUDæ“ä½œ"""

    def _generate_anonymized_id(self, staff_id: uuid.UUID) -> str:
        """
        ã‚¹ã‚¿ãƒƒãƒ•IDã‹ã‚‰åŒ¿ååŒ–IDã‚’ç”Ÿæˆ

        Args:
            staff_id: å…ƒã®ã‚¹ã‚¿ãƒƒãƒ•ID

        Returns:
            åŒ¿ååŒ–IDï¼ˆä¾‹: ABC123DEFï¼‰
        """
        # SHA-256ãƒãƒƒã‚·ãƒ¥ã®å…ˆé ­9æ–‡å­—ã‚’ä½¿ç”¨
        hash_hex = hashlib.sha256(str(staff_id).encode()).hexdigest()
        return hash_hex[:9].upper()

    async def create_from_staff(
        self,
        db: AsyncSession,
        *,
        staff: Staff,
        reason: str,
        deleted_by: uuid.UUID
    ) -> ArchivedStaff:
        """
        Staffãƒ¬ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ä½œæˆ

        å€‹äººè­˜åˆ¥æƒ…å ±ã‚’åŒ¿ååŒ–ã—ã€æ³•å®šä¿å­˜ãŒå¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’ä¿å­˜ã™ã‚‹ã€‚

        Args:
            db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
            staff: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å¯¾è±¡ã®ã‚¹ã‚¿ãƒƒãƒ•
            reason: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ç†ç”±ï¼ˆstaff_deletion/staff_withdrawal/office_withdrawalï¼‰
            deleted_by: å‰Šé™¤å®Ÿè¡Œè€…ã®ã‚¹ã‚¿ãƒƒãƒ•ID

        Returns:
            ä½œæˆã•ã‚ŒãŸã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ¬ã‚³ãƒ¼ãƒ‰
        """
        # åŒ¿ååŒ–IDç”Ÿæˆ
        anon_id = self._generate_anonymized_id(staff.id)

        # äº‹å‹™æ‰€æƒ…å ±å–å¾—ï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰
        office_id = None
        office_name = None
        if staff.office_associations:
            # ãƒ—ãƒ©ã‚¤ãƒãƒªäº‹å‹™æ‰€ã‚’å„ªå…ˆ
            primary_assoc = next(
                (assoc for assoc in staff.office_associations if assoc.is_primary),
                None
            )
            if primary_assoc and primary_assoc.office:
                office_id = primary_assoc.office.id
                office_name = primary_assoc.office.name
            elif staff.office_associations:
                # ãƒ—ãƒ©ã‚¤ãƒãƒªãŒãªã‘ã‚Œã°æœ€åˆã®äº‹å‹™æ‰€
                first_assoc = staff.office_associations[0]
                if first_assoc.office:
                    office_id = first_assoc.office.id
                    office_name = first_assoc.office.name

        # é€€è·æ—¥ï¼ˆdeleted_atã¾ãŸã¯ç¾åœ¨æ—¥æ™‚ï¼‰
        terminated_at = staff.deleted_at or datetime.now(timezone.utc)

        # æ³•å®šä¿å­˜æœŸé™ã‚’è¨ˆç®—ï¼ˆé€€è·æ—¥ + 5å¹´ï¼‰
        retention_until = ArchivedStaff.calculate_retention_until(terminated_at, years=5)

        # ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
        metadata = {
            "deleted_by_staff_id": str(deleted_by),
            "original_email_domain": staff.email.split("@")[1] if "@" in staff.email else None,
            "mfa_was_enabled": staff.is_mfa_enabled,
            "is_email_verified": staff.is_email_verified,
        }

        # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ
        archived_staff = ArchivedStaff(
            original_staff_id=staff.id,
            anonymized_full_name=f"ã‚¹ã‚¿ãƒƒãƒ•-{anon_id}",
            anonymized_email=f"archived-{anon_id}@deleted.local",
            role=staff.role.value,
            office_id=office_id,
            office_name=office_name,
            hired_at=staff.created_at,
            terminated_at=terminated_at,
            archive_reason=reason,
            legal_retention_until=retention_until,
            metadata=metadata,
            is_test_data=staff.is_test_data if hasattr(staff, 'is_test_data') else False
        )

        db.add(archived_staff)
        await db.flush()
        await db.refresh(archived_staff)

        return archived_staff

    async def get_by_original_staff_id(
        self,
        db: AsyncSession,
        *,
        staff_id: uuid.UUID
    ) -> Optional[ArchivedStaff]:
        """
        å…ƒã®ã‚¹ã‚¿ãƒƒãƒ•IDã§ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’å–å¾—

        Args:
            db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
            staff_id: å…ƒã®ã‚¹ã‚¿ãƒƒãƒ•ID

        Returns:
            ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ¬ã‚³ãƒ¼ãƒ‰ã€ã¾ãŸã¯ None
        """
        stmt = select(ArchivedStaff).where(
            ArchivedStaff.original_staff_id == staff_id
        )
        result = await db.execute(stmt)
        return result.scalar_one_or_none()

    async def get_expired_archives(
        self,
        db: AsyncSession,
        *,
        exclude_test_data: bool = True
    ) -> List[ArchivedStaff]:
        """
        æ³•å®šä¿å­˜æœŸé™ãŒéããŸã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’å–å¾—

        Args:
            db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
            exclude_test_data: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’é™¤å¤–ã™ã‚‹ã‹

        Returns:
            æœŸé™åˆ‡ã‚Œã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒªã‚¹ãƒˆ
        """
        now = datetime.now(timezone.utc)

        stmt = select(ArchivedStaff).where(
            ArchivedStaff.legal_retention_until <= now
        )

        if exclude_test_data:
            stmt = stmt.where(ArchivedStaff.is_test_data == False)

        result = await db.execute(stmt)
        return list(result.scalars().all())

    async def delete_expired_archives(
        self,
        db: AsyncSession,
        *,
        exclude_test_data: bool = True
    ) -> int:
        """
        æ³•å®šä¿å­˜æœŸé™ãŒéããŸã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’å‰Šé™¤

        Args:
            db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³
            exclude_test_data: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’é™¤å¤–ã™ã‚‹ã‹

        Returns:
            å‰Šé™¤ã•ã‚ŒãŸãƒ¬ã‚³ãƒ¼ãƒ‰æ•°
        """
        expired_archives = await self.get_expired_archives(
            db,
            exclude_test_data=exclude_test_data
        )

        count = 0
        for archive in expired_archives:
            await db.delete(archive)
            count += 1

        return count


archived_staff = CRUDArchivedStaff()
```

### 4. cleanup_service ã¸ã®çµ±åˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `app/services/cleanup_service.py`

```python
# æ—¢å­˜ã®cleanup_serviceã«ä»¥ä¸‹ã‚’è¿½åŠ 

async def cleanup_expired_archives(
    self,
    db: AsyncSession
) -> Dict[str, Any]:
    """
    æ³•å®šä¿å­˜æœŸé™ãŒéããŸã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’å‰Šé™¤

    Args:
        db: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚»ãƒƒã‚·ãƒ§ãƒ³

    Returns:
        å‰Šé™¤çµæœã®ã‚µãƒãƒªãƒ¼
    """
    from app.crud.crud_archived_staff import archived_staff

    result = {
        "deleted_archive_count": 0,
        "errors": []
    }

    try:
        # æœŸé™åˆ‡ã‚Œã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’å‰Šé™¤
        count = await archived_staff.delete_expired_archives(
            db,
            exclude_test_data=True
        )
        result["deleted_archive_count"] = count

        await db.commit()

        logger.info(f"Expired archives cleanup completed: {count} archives deleted")

    except Exception as e:
        await db.rollback()
        error_msg = f"Archive cleanup failed: {str(e)}"
        logger.error(error_msg)
        result["errors"].append(error_msg)
        raise

    return result
```

---

## ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé–“

### ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Day 0      â”‚ Day 30        â”‚ Year 5       â”‚ Year 5+      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤â”‚ ç‰©ç†å‰Šé™¤      â”‚ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–   â”‚ å®Œå…¨å‰Šé™¤     â”‚
â”‚            â”‚               â”‚ ä¿æŒæœŸé™     â”‚              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ“ Archive  â”‚ âœ“ staffså‰Šé™¤  â”‚ âœ“ 5å¹´çµŒé    â”‚ âœ“ archiveå‰Šé™¤â”‚
â”‚   ä½œæˆ     â”‚               â”‚              â”‚              â”‚
â”‚ âœ“ è«–ç†å‰Šé™¤  â”‚               â”‚              â”‚              â”‚
â”‚   (staffs) â”‚               â”‚              â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å„æ®µéšã®è©³ç´°

1. **Day 0ï¼ˆå‰Šé™¤å®Ÿè¡Œæ™‚ï¼‰**
   - ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ
   - å€‹äººæƒ…å ±åŒ¿ååŒ–
   - staffsãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’è«–ç†å‰Šé™¤

2. **Day 30ï¼ˆç‰©ç†å‰Šé™¤ï¼‰**
   - cleanup_serviceãŒstaffsãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç‰©ç†å‰Šé™¤
   - ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã¯ä¿æŒ

3. **Year 5ï¼ˆæ³•å®šä¿å­˜æœŸé™ï¼‰**
   - terminated_at + 5å¹´ãŒçµŒé
   - `legal_retention_until`ã«åˆ°é”

4. **Year 5+ï¼ˆå®Œå…¨å‰Šé™¤ï¼‰**
   - cleanup_serviceãŒã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’å‰Šé™¤
   - ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã‚‹

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 1. åŒ¿ååŒ–ã®å¾¹åº•

**åŒ¿ååŒ–å¯¾è±¡**ï¼š
- æ°å â†’ `ã‚¹ã‚¿ãƒƒãƒ•-ABC123DEF`ï¼ˆSHA-256ãƒãƒƒã‚·ãƒ¥ã®å…ˆé ­9æ–‡å­—ï¼‰
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ â†’ `archived-ABC123DEF@deleted.local`

**åŒ¿ååŒ–ã—ãªã„ãƒ‡ãƒ¼ã‚¿**ï¼š
- å½¹è·ï¼ˆroleï¼‰
- é›‡å…¥ã‚Œæ—¥ï¼ˆhired_atï¼‰
- é€€è·æ—¥ï¼ˆterminated_atï¼‰
- æ‰€å±äº‹å‹™æ‰€IDãƒ»åï¼ˆã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆï¼‰

### 2. ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

**ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ‡ãƒ¼ã‚¿ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹**ï¼š
- app_admin ã®ã¿ãŒé–²è¦§å¯èƒ½
- é€šå¸¸ã®ã‚¹ã‚¿ãƒƒãƒ•ã¯é–²è¦§ä¸å¯
- API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯`require_app_admin`ã§ä¿è­·

**APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¾‹**ï¼š
```python
# app/api/v1/endpoints/archived_staffs.py

@router.get("/", dependencies=[Depends(deps.require_app_admin)])
async def list_archived_staffs(
    db: AsyncSession = Depends(deps.get_db),
    skip: int = 0,
    limit: int = 100
):
    """ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒªã‚¹ãƒˆå–å¾—ï¼ˆapp_adminã®ã¿ï¼‰"""
    # ...
```

### 3. ç›£æŸ»ãƒ­ã‚°

**è¨˜éŒ²ã™ã¹ãã‚¤ãƒ™ãƒ³ãƒˆ**ï¼š
- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆï¼ˆ`archive.created`ï¼‰
- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–é–²è¦§ï¼ˆ`archive.accessed`ï¼‰
- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‰Šé™¤ï¼ˆ`archive.deleted`ï¼‰

```python
# ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆæ™‚
await crud.audit_log.create_log(
    db=db,
    actor_id=deleted_by,
    action="archive.created",
    target_type="archived_staff",
    target_id=archived_staff.id,
    details={
        "original_staff_id": str(staff.id),
        "archive_reason": reason,
        "retention_until": retention_until.isoformat()
    }
)
```

### 4. ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–

**è€ƒæ…®äº‹é …**ï¼š
- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ†ãƒ¼ãƒ–ãƒ«ã¯æš—å·åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚‚æš—å·åŒ–
- metadataãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆJSONBï¼‰ã«ã¯æ©Ÿå¯†æƒ…å ±ã‚’å«ã‚ãªã„

---

## ãƒ†ã‚¹ãƒˆè¦ä»¶

### 1. ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `tests/crud/test_crud_archived_staff.py`

```python
import pytest
from datetime import datetime, timedelta, timezone

class TestCRUDArchivedStaff:
    """ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–CRUDã®ãƒ†ã‚¹ãƒˆ"""

    async def test_create_from_staff(self, db, test_staff):
        """Staffã‹ã‚‰ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ"""
        # ...

    async def test_anonymization(self, db, test_staff):
        """åŒ¿ååŒ–ã®ç¢ºèª"""
        # æ°åãƒ»ãƒ¡ãƒ¼ãƒ«ãŒåŒ¿ååŒ–ã•ã‚Œã¦ã„ã‚‹ã‹
        # ...

    async def test_retention_calculation(self):
        """ä¿å­˜æœŸé™è¨ˆç®—ã®ç¢ºèª"""
        # terminated_at + 5å¹´ãŒæ­£ã—ã„ã‹
        # ...

    async def test_get_expired_archives(self, db):
        """æœŸé™åˆ‡ã‚Œã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å–å¾—"""
        # ...

    async def test_delete_expired_archives(self, db):
        """æœŸé™åˆ‡ã‚Œã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‰Šé™¤"""
        # ...
```

### 2. çµ±åˆãƒ†ã‚¹ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `tests/integration/test_staff_deletion_with_archive.py`

```python
class TestStaffDeletionWithArchive:
    """ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤ã¨ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®çµ±åˆãƒ†ã‚¹ãƒˆ"""

    async def test_delete_staff_creates_archive(self, client, db, owner_token):
        """ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤æ™‚ã«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãŒä½œæˆã•ã‚Œã‚‹"""
        # DELETE /staffs/{id} ã‚’å®Ÿè¡Œ
        # archived_staffsã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã‚‹ã‹ç¢ºèª
        # ...

    async def test_archive_data_anonymized(self, client, db, owner_token):
        """ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ‡ãƒ¼ã‚¿ãŒåŒ¿ååŒ–ã•ã‚Œã¦ã„ã‚‹"""
        # æ°åãƒ»ãƒ¡ãƒ¼ãƒ«ãŒåŒ¿ååŒ–ã•ã‚Œã¦ã„ã‚‹ã‹
        # ...

    async def test_archive_retention_period(self, db):
        """ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä¿å­˜æœŸé–“ãŒæ­£ã—ã„"""
        # legal_retention_until ãŒ terminated_at + 5å¹´ã‹
        # ...

    async def test_physical_deletion_keeps_archive(self, db):
        """ç‰©ç†å‰Šé™¤å¾Œã‚‚ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã¯ä¿æŒã•ã‚Œã‚‹"""
        # cleanup_serviceå®Ÿè¡Œå¾Œã‚‚archived_staffsã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒæ®‹ã‚‹ã‹
        # ...
```

### 3. E2Eãƒ†ã‚¹ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `tests/e2e/test_archive_lifecycle.py`

```python
class TestArchiveLifecycle:
    """ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«E2Eãƒ†ã‚¹ãƒˆ"""

    async def test_full_lifecycle(self, db):
        """
        å®Œå…¨ãªãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ã®ãƒ†ã‚¹ãƒˆï¼š
        1. ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤ â†’ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ
        2. 30æ—¥å¾Œ â†’ ç‰©ç†å‰Šé™¤ï¼ˆã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä¿æŒï¼‰
        3. 5å¹´å¾Œ â†’ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‰Šé™¤
        """
        # ...
```

---

## ä»˜éŒ²

### A. ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã¸ã®è¿½è¨˜

```markdown
## ç¬¬Xæ¡ï¼ˆå€‹äººæƒ…å ±ã®ä¿æŒæœŸé–“ï¼‰

1. å€‹äººæƒ…å ±ã¯ã€åˆ©ç”¨ç›®çš„ã®é”æˆã«å¿…è¦ãªæœŸé–“ä¿æŒã—ã¾ã™ã€‚

2. **ã‚¹ã‚¿ãƒƒãƒ•ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤å¾Œã®ä¿æŒæœŸé–“**
   - è«–ç†å‰Šé™¤ã‹ã‚‰**30æ—¥é–“**ï¼šèª¤å‰Šé™¤ã‹ã‚‰ã®å¾©æ—§ãŒå¯èƒ½ãªçŒ¶äºˆæœŸé–“
   - 30æ—¥çµŒéå¾Œï¼šå€‹äººè­˜åˆ¥æƒ…å ±ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç­‰ï¼‰ã‚’å®Œå…¨ã«å‰Šé™¤ï¼ˆç‰©ç†å‰Šé™¤ï¼‰
   - **æ³•å®šä¿å­˜ç¾©å‹™ã®ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿**ï¼šä»¥ä¸‹ã®æœŸé–“ã€åŒ¿ååŒ–ã—ãŸä¸Šã§ä¿æŒ
     - åŠ´åƒè€…åç°¿æƒ…å ±ï¼šé€€è·å¾Œ**5å¹´é–“**ï¼ˆåŠ´åƒåŸºæº–æ³•ç¬¬109æ¡ï¼‰
     - é›‡ç”¨é–¢é€£è¨˜éŒ²ï¼šé€€è·å¾Œ**5å¹´é–“**
     - ã‚µãƒ¼ãƒ“ã‚¹æä¾›è¨˜éŒ²ï¼šæä¾›æ—¥ã‹ã‚‰**5å¹´é–“**ï¼ˆéšœå®³è€…ç·åˆæ”¯æ´æ³•ï¼‰

3. æ³•å®šä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®å–æ‰±ã„
   - å€‹äººã‚’ç‰¹å®šã§ãã‚‹æƒ…å ±ï¼ˆæ°åã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç­‰ï¼‰ã¯åŒ¿ååŒ–
   - æ³•ä»¤ã§å®šã‚ã‚‰ã‚ŒãŸä¿å­˜æœŸé–“çµŒéå¾Œã€é€Ÿã‚„ã‹ã«å‰Šé™¤
   - ã‚¢ã‚¯ã‚»ã‚¹ã¯ç®¡ç†è€…ã®ã¿ã«åˆ¶é™

4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¨©åˆ©
   - å€‹äººæƒ…å ±ã®é–‹ç¤ºã€è¨‚æ­£ã€å‰Šé™¤ã‚’è«‹æ±‚ã§ãã¾ã™
   - ãŸã ã—ã€æ³•ä»¤ã«åŸºã¥ãä¿å­˜ç¾©å‹™ãŒã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ã§ãã¾ã›ã‚“
```

### B. å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [x] ãƒ¢ãƒ‡ãƒ«ä½œæˆï¼ˆ`app/models/archived_staff.py`ï¼‰
- [x] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä½œæˆãƒ»å®Ÿè¡Œ
- [x] CRUDä½œæˆï¼ˆ`app/crud/crud_archived_staff.py`ï¼‰
  - [x] create_from_staff - ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆ
  - [x] get - IDå–å¾—
  - [x] get_by_original_staff_id - å…ƒã‚¹ã‚¿ãƒƒãƒ•IDã§å–å¾—
  - [x] get_multi - ãƒªã‚¹ãƒˆå–å¾—ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ»ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
  - [x] get_expired_archives - æœŸé™åˆ‡ã‚Œã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å–å¾—
  - [x] delete_expired_archives - æœŸé™åˆ‡ã‚Œã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‰Šé™¤
- [x] ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆå‡¦ç†ã‚’è¿½åŠ 
- [x] Withdrawal ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆå‡¦ç†ã‚’è¿½åŠ ï¼ˆstaff_withdrawal, office_withdrawalï¼‰
- [x] cleanup_service ã«ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‰Šé™¤å‡¦ç†ã‚’è¿½åŠ ï¼ˆâ€»æ—¢ã«å®Ÿè£…æ¸ˆã¿ã‚’ç¢ºèªï¼‰
- [x] API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä½œæˆï¼ˆapp_adminå°‚ç”¨ï¼‰
  - [x] GET /api/v1/admin/archived-staffs - ãƒªã‚¹ãƒˆå–å¾—
  - [x] GET /api/v1/admin/archived-staffs/{id} - è©³ç´°å–å¾—
  - [x] ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ä½œæˆï¼ˆapp/schemas/archived_staff.pyï¼‰
  - [x] APIãƒ«ãƒ¼ã‚¿ãƒ¼ç™»éŒ²ï¼ˆapp/api/v1/api.pyï¼‰
- [x] APIãƒ†ã‚¹ãƒˆä½œæˆï¼ˆtests/api/v1/test_archived_staffs.pyï¼‰
  - [x] ãƒªã‚¹ãƒˆå–å¾—ãƒ†ã‚¹ãƒˆï¼ˆæ­£å¸¸ç³»ï¼‰
  - [x] office_idãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
  - [x] archive_reasonãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãƒ†ã‚¹ãƒˆ
  - [x] ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
  - [x] è©³ç´°å–å¾—ãƒ†ã‚¹ãƒˆï¼ˆæ­£å¸¸ç³»ï¼‰
  - [x] 403 Forbiddenãƒ†ã‚¹ãƒˆï¼ˆéapp_adminï¼‰
  - [x] 404 Not Foundãƒ†ã‚¹ãƒˆ
- [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆä½œæˆï¼ˆCRUDå±¤ï¼‰
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆä½œæˆï¼ˆã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä½œæˆãƒ•ãƒ­ãƒ¼å…¨ä½“ï¼‰
- [ ] E2Eãƒ†ã‚¹ãƒˆä½œæˆ
- [ ] ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼æ›´æ–°
- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°

---

**ä½œæˆæ—¥**: 2025-12-01
**æœ€çµ‚æ›´æ–°æ—¥**: 2025-12-01
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
