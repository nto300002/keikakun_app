# ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ©Ÿèƒ½ å®Ÿè£…çŠ¶æ³

æœ€çµ‚æ›´æ–°: 2025-11-23
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèªè€…: Claude Code

---

## å®Ÿè£…æ¸ˆã¿é …ç›® âœ…

### Phase 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤

#### 1.1 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ âœ…
**ãƒ•ã‚¡ã‚¤ãƒ«**: `k_back/migrations/versions/x1y2z3a4b5c6_add_messages_tables.py`

**å®Ÿè£…å†…å®¹**:
- âœ… messages ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- âœ… message_recipients ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- âœ… message_audit_logs ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆï¼ˆå…¨ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
- âœ… å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„è¨­å®š
- âœ… ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ (message_id, recipient_staff_id)

**ä¸è¶³åˆ†**:
- âŒ **is_test_data ã‚«ãƒ©ãƒ ãŒå…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ¬ è½**

---

#### 1.2 ãƒ¢ãƒ‡ãƒ« (éƒ¨åˆ†çš„ã«å®Ÿè£…æ¸ˆã¿) âš ï¸
**ãƒ•ã‚¡ã‚¤ãƒ«**: `k_back/app/models/message.py`

**å®Ÿè£…å†…å®¹**:
- âœ… Message ãƒ¢ãƒ‡ãƒ«
  - sender_staff_id, office_id, message_type, priority
  - title, content, created_at, updated_at
  - ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: sender, office, recipients
  - ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­å®š
- âœ… MessageRecipient ãƒ¢ãƒ‡ãƒ«
  - message_id, recipient_staff_id
  - is_read, read_at, is_archived
  - created_at, updated_at
  - ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: message, recipient_staff
  - ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„

**ä¸è¶³åˆ†**:
- âŒ **MessageAuditLog ãƒ¢ãƒ‡ãƒ«ãŒæœªå®Ÿè£…** (ãƒ†ãƒ¼ãƒ–ãƒ«ã¯ä½œæˆæ¸ˆã¿)
- âŒ **is_test_data ãƒ•ãƒ©ã‚°ãŒå…¨ãƒ¢ãƒ‡ãƒ«ã«æ¬ è½**

---

#### 1.3 Enumå®šç¾© âœ…
**ãƒ•ã‚¡ã‚¤ãƒ«**: `k_back/app/models/enums.py`

**å®Ÿè£…å†…å®¹**:
- âœ… MessageType (personal, announcement, system, inquiry)
- âœ… MessagePriority (low, normal, high, urgent)

---

#### 1.4 ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆ âœ…
**ãƒ•ã‚¡ã‚¤ãƒ«**: `k_back/tests/models/test_message_model.py`

**å®Ÿè£…å†…å®¹**:
- âœ… Message ãƒ¢ãƒ‡ãƒ«ã®CRUDæ“ä½œãƒ†ã‚¹ãƒˆ
- âœ… MessageRecipient ãƒ¢ãƒ‡ãƒ«ã®CRUDæ“ä½œãƒ†ã‚¹ãƒˆ
- âœ… ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒƒãƒ—ãƒ†ã‚¹ãƒˆ
- âœ… Enumå‹•ä½œãƒ†ã‚¹ãƒˆ
- âœ… ãƒ¦ãƒ‹ãƒ¼ã‚¯åˆ¶ç´„ãƒ†ã‚¹ãƒˆ
- âœ… æ—¢èª­åŒ–ãƒ†ã‚¹ãƒˆ
- âœ… è¤‡æ•°å—ä¿¡è€…ãƒ†ã‚¹ãƒˆ

---

## æœªå®Ÿè£…é …ç›® âŒ

### Phase 2: ã‚¹ã‚­ãƒ¼ãƒå±¤ âŒ

**å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«**: `k_back/app/schemas/message.py`

**å¿…è¦ãªã‚¹ã‚­ãƒ¼ãƒ**:
- MessageCreate (å€‹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡)
- AnnouncementCreate (ä¸€æ–‰é€šçŸ¥é€ä¿¡)
- MessageResponse
- MessageRecipientResponse
- InboxResponse
- MessageStatsResponse
- MessageAuditLogCreate (ç›£æŸ»ãƒ­ã‚°ç”¨)

**ãƒ†ã‚¹ãƒˆ**: `tests/schemas/test_message.py`

---

### Phase 3: CRUDå±¤ âŒ

**å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«**:
- `k_back/app/crud/crud_message.py`
- `k_back/app/crud/crud_message_recipient.py`
- `k_back/app/crud/crud_message_audit_log.py`

**å¿…è¦ãªæ©Ÿèƒ½**:
- CRUDMessage
  - create_with_recipients() - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ + å—ä¿¡è€…ä¸€æ‹¬ä½œæˆ
  - get_by_sender() - é€ä¿¡è€…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§
  - get_by_office() - äº‹å‹™æ‰€ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§
- CRUDMessageRecipient
  - create_bulk() - ãƒãƒ«ã‚¯ä½œæˆï¼ˆãƒãƒ£ãƒ³ã‚¯å‡¦ç†ï¼‰
  - get_inbox() - å—ä¿¡ç®±å–å¾—
  - mark_as_read() - æ—¢èª­åŒ–
  - get_unread_count() - æœªèª­ä»¶æ•°
  - get_stats() - çµ±è¨ˆå–å¾—
- CRUDMessageAuditLog
  - log_action() - ç›£æŸ»ãƒ­ã‚°è¨˜éŒ²

**é‡è¦**:
- âš ï¸ **commitã¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã®ã¿å®Ÿè¡Œ**
- âš ï¸ **CRUDå±¤ã§ã¯flush()ã®ã¿ä½¿ç”¨**

**ãƒ†ã‚¹ãƒˆ**:
- `tests/crud/test_crud_message.py`
- `tests/crud/test_crud_message_recipient.py`
- `tests/crud/test_crud_message_audit_log.py`

---

### Phase 4: APIå±¤ âŒ

**å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«**: `k_back/app/api/v1/endpoints/messages.py`

**å¿…è¦ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**:
- POST /api/v1/messages/personal - å€‹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
- POST /api/v1/messages/announcement - ä¸€æ–‰é€šçŸ¥é€ä¿¡
- GET /api/v1/messages/inbox - å—ä¿¡ç®±å–å¾—
- POST /api/v1/messages/{message_id}/read - æ—¢èª­åŒ–
- GET /api/v1/messages/{message_id}/stats - çµ±è¨ˆå–å¾—
- GET /api/v1/messages/unread-count - æœªèª­ä»¶æ•°å–å¾—

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶**:
- é€ä¿¡è€…ã¨å—ä¿¡è€…ã®åŒä¸€äº‹å‹™æ‰€ãƒã‚§ãƒƒã‚¯
- ã‚ªãƒ¼ãƒŠãƒ¼ã®ã¿ä¸€æ–‰é€šçŸ¥å¯èƒ½
- å—ä¿¡è€…æœ¬äººã®ã¿æ—¢èª­åŒ–å¯èƒ½
- é€ä¿¡è€…ã®ã¿çµ±è¨ˆé–²è¦§å¯èƒ½
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™

**ãƒ†ã‚¹ãƒˆ**:
- `tests/api/v1/test_messages_personal.py`
- `tests/api/v1/test_messages_announcement.py`
- `tests/api/v1/test_messages_inbox.py`
- `tests/api/v1/test_messages_read.py`
- `tests/api/v1/test_messages_stats.py`
- `tests/api/v1/test_messages_unread_count.py`

---

### Phase 5: ç›£æŸ»ãƒ­ã‚°çµ±åˆ âŒ

**å®Ÿè£…ç®‡æ‰€**: å„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

**è¨˜éŒ²å¯¾è±¡**:
- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ (sent)
- æ—¢èª­åŒ– (read)
- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– (archived)
- å‰Šé™¤ (deleted)

---

### Phase 6: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ âŒ

**å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«**: `tests/performance/test_message_bulk_insert.py`

**ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹**:
- 100äººã¸ã®ä¸€æ–‰é€šçŸ¥
- 500äººã¸ã®ä¸€æ–‰é€šçŸ¥
- 1000äººã¸ã®ä¸€æ–‰é€šçŸ¥

---

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆå„ªå…ˆé †ä½é †ï¼‰

### 1. ãƒ¢ãƒ‡ãƒ«å±¤ã®å®Œæˆ ğŸ”¥ **æœ€å„ªå…ˆ**

**ã‚¿ã‚¹ã‚¯**:
1. MessageAuditLog ãƒ¢ãƒ‡ãƒ«è¿½åŠ 
2. å…¨ãƒ¢ãƒ‡ãƒ«ã« is_test_data ãƒ•ãƒ©ã‚°è¿½åŠ 
3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã« is_test_data ã‚«ãƒ©ãƒ è¿½åŠ 
4. MessageAuditLog ã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆä½œæˆ

**ç†ç”±**: ãƒ¢ãƒ‡ãƒ«å±¤ãŒå®Œæˆã—ãªã„ã¨ã€ã‚¹ã‚­ãƒ¼ãƒãƒ»CRUDãƒ»APIãŒå®Ÿè£…ã§ããªã„

---

### 2. ã‚¹ã‚­ãƒ¼ãƒå±¤å®Ÿè£… (TDD)

**ã‚¿ã‚¹ã‚¯**:
1. ãƒ†ã‚¹ãƒˆä½œæˆ: `tests/schemas/test_message.py`
2. ã‚¹ã‚­ãƒ¼ãƒå®Ÿè£…: `k_back/app/schemas/message.py`
3. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

---

### 3. CRUDå±¤å®Ÿè£… (TDD)

**ã‚¿ã‚¹ã‚¯**:
1. ãƒ†ã‚¹ãƒˆä½œæˆ: CRUDç”¨ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«3ã¤
2. CRUDå®Ÿè£…: 3ã¤ã®CRUDãƒ•ã‚¡ã‚¤ãƒ«
3. **é‡è¦**: commitã¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã®ã¿å®Ÿè¡Œï¼ˆCRUDå±¤ã§ã¯flush()ã®ã¿ï¼‰
4. ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

---

### 4. APIå±¤å®Ÿè£… (TDD)

**ã‚¿ã‚¹ã‚¯**:
1. çµ±åˆãƒ†ã‚¹ãƒˆä½œæˆ: 6ã¤ã®APIãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
2. APIå®Ÿè£…: messages.py
3. ç›£æŸ»ãƒ­ã‚°çµ±åˆ
4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆæ¨©é™ã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼‰
5. çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

---

### 5. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

**ã‚¿ã‚¹ã‚¯**:
1. å¤§é‡é…ä¿¡ãƒ†ã‚¹ãƒˆä½œæˆ
2. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬
3. å¿…è¦ã«å¿œã˜ã¦æœ€é©åŒ–

---

## å®Ÿè£…é€²æ—ç‡

| Phase | å®Œäº†ç‡ | çŠ¶æ…‹ |
|-------|--------|------|
| Phase 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ»ãƒ¢ãƒ‡ãƒ« | 75% | âš ï¸ ä¸è¶³åˆ†ã‚ã‚Š |
| Phase 2: ã‚¹ã‚­ãƒ¼ãƒ | 0% | âŒ æœªç€æ‰‹ |
| Phase 3: CRUD | 0% | âŒ æœªç€æ‰‹ |
| Phase 4: API | 0% | âŒ æœªç€æ‰‹ |
| Phase 5: ç›£æŸ»ãƒ­ã‚° | 0% | âŒ æœªç€æ‰‹ |
| Phase 6: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ | 0% | âŒ æœªç€æ‰‹ |
| **å…¨ä½“** | **12%** | ğŸ”„ å®Ÿè£…ä¸­ |

---

## ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆæœ€çµ‚ç¢ºèªç”¨ï¼‰

### ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç† âš ï¸ æœªç¢ºèª
- [ ] commitãŒã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã®ã¿å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] CRUDå±¤ã§commitã‚’å‘¼ã³å‡ºã—ã¦ã„ãªã„ã‹
- [ ] ä¾‹å¤–æ™‚ã«rollbackãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‹

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ âš ï¸ æœªç¢ºèª
- [ ] æ¨©é™ãƒã‚§ãƒƒã‚¯å®Ÿè£…æ¸ˆã¿
- [ ] XSSå¯¾ç­–æ¸ˆã¿
- [ ] ãƒ¬ãƒ¼ãƒˆåˆ¶é™å®Ÿè£…æ¸ˆã¿

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ âš ï¸ æœªç¢ºèª
- [ ] ãƒãƒ«ã‚¯ã‚¤ãƒ³ã‚µãƒ¼ãƒˆå®Ÿè£…æ¸ˆã¿
- [ ] ãƒãƒ£ãƒ³ã‚¯å‡¦ç†å®Ÿè£…æ¸ˆã¿
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨ç¢ºèª
- [ ] N+1å•é¡Œå›é¿ç¢ºèª

---

## å‚™è€ƒ

- ç¾åœ¨ã®å®Ÿè£…ã¯ **Phase 1ã®75%** ã¾ã§å®Œäº†
- **MessageAuditLog ãƒ¢ãƒ‡ãƒ«ã¨ is_test_data ãƒ•ãƒ©ã‚°ã®è¿½åŠ ãŒæœ€å„ªå…ˆã‚¿ã‚¹ã‚¯**
- TDDæ–¹å¼ã§é€²ã‚ã‚‹ãŸã‚ã€å„Phaseé–‹å§‹æ™‚ã«ãƒ†ã‚¹ãƒˆã‚’å…ˆã«ä½œæˆã™ã‚‹ã“ã¨
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†ï¼ˆcommitã¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ã¿ï¼‰ã‚’å³å®ˆã™ã‚‹ã“ã¨
