## e2e
   2 -  - 管理者がMFAを有効化: 自分で有効にしていないスタッフがログアウトからの再度ログイン
    3 -  > 全員MFA有効化の場合: できる
    4 -  > 個別で有効にした場合:
    5 -  - 全員MFA有効化した場合その場でQRコード発行 > 
      - k_front/components/auth/MfaFirstSetupForm.tsx 
      - ここに分岐した際に管理者メニューで表示されたQRコードから読み取ったTOTPコード入力
    6 -  > MFA認証できた
### テストケース1: 管理者による全員MFA一括有効化

**前提条件**:
- 管理者（Owner/Manager）がログイン済み
- 対象スタッフは自分でMFAを有効化していない（`is_mfa_enabled = FALSE`, `is_mfa_verified_by_user = FALSE`）

**テスト手順**:
1. 管理者が管理者メニューにアクセス
2. 「全員MFA有効化」ボタンをクリック
3. **結果**: その場で全スタッフのQRコードとシークレットキーが発行される
4. 管理者がQRコード情報をスクリーンショット等で保存
5. 対象スタッフがログアウト
6. 対象スタッフが再度ログイン（メール/パスワード入力）

**期待される動作**:
- `k_front/components/auth/MfaFirstSetupForm.tsx` に遷移
- QRコードとシークレットキーが表示される
- 管理者から受け取ったQRコードをTOTPアプリでスキャン
- TOTPアプリに表示された6桁のコードを入力
- 「確認して有効化」ボタンをクリック
- ダッシュボードに遷移

**実際の結果**:
- ✅ `MfaFirstSetupForm.tsx` に正しく遷移
- ✅ 管理者メニューで表示されたQRコードから読み取ったTOTPコードを入力
- ✅ MFA認証成功
- ✅ ダッシュボードにログイン完了

**技術的詳細**:
- API: `POST /api/v1/auth/admin/office/mfa/enable-all`
- データベース更新: `is_mfa_enabled = TRUE`, `is_mfa_verified_by_user = FALSE`
- ログイン時のレスポンス: `{"requires_mfa_first_setup": true, "qr_code_uri": "...", "secret_key": "..."}`

---

### テストケース2: 管理者による個別スタッフのMFA有効化

**前提条件**:
- 管理者（Owner/Manager）がログイン済み
- 対象スタッフは自分でMFAを有効化していない

**テスト手順**:
1. 管理者が管理者メニュー → スタッフ一覧にアクセス
2. 特定のスタッフの「MFA有効化」ボタンをクリック
3. **結果**: モーダルに該当スタッフのQRコードとシークレットキーが表示
4. 管理者がQRコード情報を対象スタッフに共有（メール、チャット等）
5. 対象スタッフがログアウト（またはログイン済みでない場合）
6. 対象スタッフが再度ログイン

**期待される動作**:
- `MfaFirstSetupForm.tsx` に遷移
- 管理者から共有されたQRコードをTOTPアプリでスキャン
- TOTPコードを入力して検証成功
- ダッシュボードに遷移

**実際の結果**:
- ✅ 個別有効化機能が正常に動作
- ✅ QRコードが正しく生成される
- ✅ スタッフが初回検証を完了できる

**技術的詳細**:
- API: `POST /api/v1/auth/admin/staff/{staff_id}/mfa/enable`
- データベース更新: 対象スタッフのみ `is_mfa_enabled = TRUE`, `is_mfa_verified_by_user = FALSE`

---

### 補足: テストシナリオの共通事項

**QRコード発行のタイミング**:
- 全員MFA有効化: その場で全スタッフ分のQRコードが一括表示
- 個別MFA有効化: 個別モーダルで1スタッフ分のQRコードが表示

**初回検証フロー**:
- 管理者が有効化した場合、スタッフは必ず初回検証フロー（`MfaFirstSetupForm.tsx`）を通る
- 初回検証完了後、`is_mfa_verified_by_user = TRUE` に更新される
- 次回以降のログインでは通常のMFA検証フロー（`mfa-verify/page.tsx`）に遷移

**セキュリティ考慮事項**:
- QRコードとシークレットキーは一度しか表示されない（セキュリティのため）
- 管理者は表示時に必ずスクリーンショット等で保存し、スタッフに共有する必要がある
- 紛失した場合は、管理者が一度MFAを無効化してから再度有効化する

### MFA有効期限切れ後の再ログインフロー検証結果

**テスト日**: 2025-11-19

#### テストシナリオ: トークン失効後の再ログイン

**初回ログイン時**:
1. MFA認証が元々有効であったアカウントでログイン
2. Cookieを削除（トークン失効をシミュレート）
3. 再度ログイン
4. **結果**: `k_front/components/auth/MfaFirstSetupForm.tsx` に遷移
5. 管理者メニューで有効にしていたQRコードから取得したTOTPコードを入力
6. **結果**: ✅ 正常に認証完了

**2回目以降のログイン時**:
1. 初回検証完了後、再度Cookieを削除
2. 再ログイン
3. **結果**: ✅ `k_front/app/auth/mfa-verify/page.tsx` に遷移（通常のMFA検証画面）
4. TOTPコード入力
5. **結果**: ✅ ログイン成功

#### 確認事項

- ✅ Cookie削除（トークン失効シミュレート）と実際の有効期限切れは同じ動作をする
- ✅ 初回検証完了後、`is_mfa_verified_by_user` フラグが `TRUE` に更新される
- ✅ 次回以降のログインでは通常のMFA検証フロー（`mfa-verify`）に遷移する
- ✅ 既存のMFAシークレットが保持され、同じQRコードのTOTPコードが有効

#### 技術的詳細

**ログインフローの分岐条件** (`auths.py:197-236`):
```
is_mfa_enabled = TRUE の場合:
  ├─ is_mfa_verified_by_user = FALSE → mfa-first-setup に遷移（初回検証フロー）
  └─ is_mfa_verified_by_user = TRUE  → mfa-verify に遷移（通常のMFA検証）
```

**トークン失効の同等性**:
- Cookie削除 = トークンなし
- 有効期限切れ（1時間） = トークン無効
- 強制ログアウト = トークンなし
→ すべて同じ結果（再ログインが必要）

#### 結論

MFA機能は仕様通り正常に動作することを確認。トークン有効期限切れ後も、初回検証完了済みのユーザーは通常のMFA検証フロー（`mfa-verify`）に遷移し、問題なくログイン可能。